<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
      [v-cloak] { display: none; }
      body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background-color: #f4f6f9; }
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      .slide-fade-enter-active, .slide-fade-leave-active { transition: all 0.3s ease-in-out; }
      .slide-fade-enter-from, .slide-fade-leave-to { transform: translateY(-10px); opacity: 0; max-height: 0; overflow: hidden; }
      .slide-fade-enter-to, .slide-fade-leave-from { transform: translateY(0); opacity: 1; max-height: 800px; }
      .modal-fade-enter-active, .modal-fade-leave-active { transition: all 0.3s ease-out; }
      .modal-fade-enter-from, .modal-fade-leave-to { transform: translateY(100%); opacity: 0; }
      .modal-fade-enter-to, .modal-fade-leave-from { transform: translateY(0); opacity: 1; }
    </style>
  </head>
  <body class="pb-20">
    <div id="app" v-cloak class="w-full 2xl:max-w-[1600px] mx-auto p-4 md:p-6">
      
      <div v-if="!loading" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5">
        <div v-for="(item, index) in finalSortedData" :key="index" class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden flex flex-col h-full border-t-[6px]" :style="{ borderTopColor: getCategoryColor(getCategory(item)) }">
          <div class="p-4 md:p-5 flex flex-col flex-grow">
            <div class="mt-auto pt-2 grid grid-cols-3 gap-2">
              <button @click="openLineModal(item)" class="flex items-center justify-center gap-1 bg-white border border-gray-200 text-gray-600 py-2.5 rounded-xl font-bold text-[12px] shadow-sm active:bg-gray-50 transition">ğŸ’¬ Line</button>
              <a :href="'tel:' + item.phone" class="flex items-center justify-center gap-1 bg-white border border-gray-200 text-gray-600 py-2.5 rounded-xl font-bold text-[12px] shadow-sm transition">ğŸ“ é›»è©±</a>
              <button @click="openUpdateModal(item)" class="flex items-center justify-center gap-1 bg-orange-500 text-white py-2.5 rounded-xl font-bold text-[12px] shadow-sm active:scale-95 transition">ğŸ“ æ›´æ–°</button>
            </div>
          </div>
        </div>
      </div>

      <transition name="modal-fade">
        <div v-if="showUpdateModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-gray-900/60 backdrop-blur-sm" @click.self="closeUpdateModal">
          <div class="bg-white w-full max-w-md rounded-t-[2rem] sm:rounded-[2rem] p-5 md:p-6 max-h-[90vh] overflow-y-auto shadow-2xl">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
              <h3 class="text-lg font-black text-gray-800 tracking-tight">ğŸ“ æ›´æ–°ï¼š[[ currentItem?.storeName ]]</h3>
              <button @click="closeUpdateModal" class="text-gray-400 font-bold">âœ•</button>
            </div>

            <p class="text-xs font-bold text-gray-500 mb-2">ğŸ“Œ ç•¶å‰ç‹€æ…‹</p>
            <div class="grid grid-cols-2 gap-2 mb-4">
              <button @click="editData.newTracking = 'è¯çµ¡ä¸­'" :class="['py-3 rounded-xl font-bold text-sm transition', editData.newTracking === 'è¯çµ¡ä¸­' ? 'bg-blue-600 text-white shadow-lg' : 'bg-gray-100 text-gray-500']">ğŸ“ è¯çµ¡ä¸­</button>
              <button @click="editData.newTracking = 'æ‹’çµ•'" :class="['py-3 rounded-xl font-bold text-sm transition', editData.newTracking === 'æ‹’çµ•' ? 'bg-red-600 text-white shadow-lg' : 'bg-gray-100 text-gray-500']">ğŸš« æ‹’çµ•/ç„¡æ•ˆ</button>
            </div>

            <p class="text-xs font-bold text-gray-500 mb-2">ğŸ“ è¯çµ¡é€²åº¦</p>
            <div class="flex flex-wrap gap-2 mb-4">
              <button v-for="tag in ['åŠ Line','å·²è®€','æ’­é›»è©±','æ˜¯å¦æ’¥é€š','Email']" :key="tag" @click="toggleEditCheck(tag)"
                      :class="['px-3 py-2 rounded-lg text-[11px] font-bold border transition', isTagChecked(tag) ? 'bg-blue-50 text-blue-600 border-blue-200' : 'bg-white text-gray-400 border-gray-100']">
                [[ tag ]]
              </button>
            </div>

            <p class="text-xs font-bold text-gray-500 mb-2">âš¡ å¿«é€Ÿç´€éŒ„ (é»æ“Šç´¯åŠ )</p>
            <div class="grid grid-cols-3 gap-2 mb-4 text-[11px]">
              <button @click="addNoteAction('call')" class="py-2 bg-blue-50 text-blue-600 rounded-lg font-bold border border-blue-100 shadow-sm">ğŸ“ æ’¥æ‰“ç´€éŒ„</button>
              <button @click="addNoteAction('line')" class="py-2 bg-green-50 text-green-600 rounded-lg font-bold border border-green-100 shadow-sm">ğŸ’¬ å‚³Lineç´€éŒ„</button>
              <button @click="addNoteManual('ç„¡äººæ¥è½')" class="py-2 bg-gray-100 text-gray-600 rounded-lg font-bold shadow-sm">ç„¡äººæ¥è½</button>
              <button @click="addNoteManual('å¿™ç¢Œä¸­')" class="py-2 bg-gray-100 text-gray-600 rounded-lg font-bold shadow-sm">å¿™ç¢Œä¸­</button>
              <button @click="addNoteManual('è«‹å¯„è³‡æ–™')" class="py-2 bg-gray-100 text-gray-600 rounded-lg font-bold shadow-sm">è«‹å¯„è³‡æ–™</button>
              <button @click="addNoteManual('å·²ç´„æ™‚é–“')" class="py-2 bg-gray-100 text-gray-600 rounded-lg font-bold shadow-sm">å·²ç´„æ™‚é–“</button>
            </div>

            <textarea v-model="editData.note" class="w-full h-40 p-3 bg-gray-50 border border-gray-200 rounded-xl text-xs text-gray-600 mb-4 focus:ring-2 focus:ring-blue-500 outline-none resize-none leading-relaxed shadow-inner font-mono"></textarea>

            <button @click="submitUpdate" :disabled="isUpdating" class="w-full bg-blue-600 text-white font-bold py-4 rounded-2xl shadow-xl active:scale-95 transition flex justify-center items-center gap-2">
              <span v-if="isUpdating" class="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>
              [[ isUpdating ? 'æ­£åœ¨å„²å­˜...' : 'ğŸ’¾ å„²å­˜æ›´æ–°' ]]
            </button>
          </div>
        </div>
      </transition>

    </div>

    <script>
      const GAS_URL = "https://script.google.com/macros/s/ä½ çš„æ­£å¼ç‰ˆID/exec";
      const { createApp } = Vue;
      createApp({
        delimiters: ['[[', ']]'],
        data() {
          return {
            loading: true, salesData: [], showUpdateModal: false, isUpdating: false,
            currentItem: null,
            editData: { newTracking: '', addLine: '', readStatus: '', callStatus: '', isConnected: '', emailSent: '', note: '' }
          }
        },
        methods: {
          openUpdateModal(item) {
            this.currentItem = item;
            // æ‹·è²ç•¶å‰è³‡æ–™åˆ°ç·¨è¼¯å€
            this.editData = { ...item };
            // å¦‚æœç´€éŒ„å…§å®¹æ˜¯ç©ºçš„ï¼Œåˆå§‹åŒ–æ¨¡æ¿
            if (!this.editData.note || this.editData.note === 'ç„¡') {
              this.editData.note = "å‚³lineç´€éŒ„ï¼ˆå…±0æ¬¡ï¼‰ï¼š\næ’¥æ‰“ç´€éŒ„ï¼ˆå…±0æ¬¡ï¼‰ï¼š\nå…¶ä»–è³‡è¨Šï¼š\næ‰‹å‹•ç´€éŒ„ï¼š";
            }
            this.showUpdateModal = true;
          },
          closeUpdateModal() { this.showUpdateModal = false; },
          
          isTagChecked(tag) {
            const map = { 'åŠ Line': 'addLine', 'å·²è®€': 'readStatus', 'æ’¥é›»è©±': 'callStatus', 'æ˜¯å¦æ’¥é€š': 'isConnected', 'Email': 'emailSent' };
            return String(this.editData[map[tag]]).includes('âœ…');
          },
          toggleEditCheck(tag) {
            const map = { 'åŠ Line': 'addLine', 'å·²è®€': 'readStatus', 'æ’¥é›»è©±': 'callStatus', 'æ˜¯å¦æ’¥é€š': 'isConnected', 'Email': 'emailSent' };
            const key = map[tag];
            this.editData[key] = this.editData[key] === 'âœ…' ? '' : 'âœ…';
          },
          
          // ğŸª„ å­—ä¸²ç´¯åŠ é­”æ³•
          addNoteAction(type) {
            const now = new Date();
            const timeStr = `[ ${now.getMonth()+1}/${now.getDate()} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')} ]`;
            const label = type === 'call' ? 'æ’¥æ‰“ç´€éŒ„' : 'å‚³lineç´€éŒ„';
            const actionText = type === 'call' ? 'å·²æ’¥æ‰“' : 'å·²å‚³è¨Š';
            
            let val = this.editData.note;
            const regex = new RegExp(`${label}ï¼ˆå…±(\\d+)æ¬¡ï¼‰ï¼š`);
            const match = val.match(regex);
            
            if (match) {
              const count = parseInt(match[1]) + 1;
              val = val.replace(regex, `${label}ï¼ˆå…±${count}æ¬¡ï¼‰ï¼š\n${timeStr} ${actionText}`);
            }
            this.editData.note = val;
          },
          addNoteManual(text) {
            this.editData.note = this.editData.note.replace('æ‰‹å‹•ç´€éŒ„ï¼š', `æ‰‹å‹•ç´€éŒ„ï¼š\n[${text}] `);
          },

          submitUpdate() {
            this.isUpdating = true;
            const params = new URLSearchParams({
              action: 'updateProgress', // å°æ‡‰ Main.gs è£¡çš„ handleUpdateProgress
              key: this.currentItem.id,
              isL: String(this.editData.addLine === 'âœ…'),
              isM: String(this.editData.readStatus === 'âœ…'),
              isN: String(this.editData.callStatus === 'âœ…'),
              isO: String(this.editData.isConnected === 'âœ…'),
              isQ: String(this.editData.emailSent === 'âœ…'),
              note: this.editData.note,
              progress: `${new Date().toLocaleDateString()} | ${this.editData.newTracking}`
            });

            fetch(GAS_URL + "?" + params.toString(), { method: "POST" })
              .then(res => res.text())
              .then(result => {
                if(result === "Success") {
                  alert("æ›´æ–°æˆåŠŸï¼");
                  this.loadData(); // é‡æ–°æŠ“å–è³‡æ–™
                  this.closeUpdateModal();
                }
              })
              .finally(() => { this.isUpdating = false; });
          }
        }
      }).mount('#app');
    </script>
  </body>
</html>

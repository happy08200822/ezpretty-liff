<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
      [v-cloak] { display: none; }
      body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background-color: #f4f6f9; }
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      
      /* é¢æ¿å‹•ç•« */
      .slide-fade-enter-active, .slide-fade-leave-active { transition: all 0.3s ease-in-out; }
      .slide-fade-enter-from, .slide-fade-leave-to { transform: translateY(-10px); opacity: 0; max-height: 0; overflow: hidden; }
      .slide-fade-enter-to, .slide-fade-leave-from { transform: translateY(0); opacity: 1; max-height: 1000px; }
      
      /* å½ˆå‡ºè¦–çª—å‹•ç•« */
      .modal-fade-enter-active, .modal-fade-leave-active { transition: all 0.3s ease-out; }
      .modal-fade-enter-from, .modal-fade-leave-to { transform: translateY(100%); opacity: 0; }
      .modal-fade-enter-to, .modal-fade-leave-from { transform: translateY(0); opacity: 1; }
    </style>
  </head>
  <body class="pb-20">
    <div id="app" v-cloak class="w-full 2xl:max-w-[1600px] mx-auto p-4 md:p-6">
      
      <div class="sticky top-0 z-30 bg-[#f4f6f9] pb-3 pt-2 mb-4 border-b border-gray-200 shadow-sm">
        <div class="flex gap-2 mb-3 w-full">
          <div class="relative flex-grow">
            <input v-model="searchQuery" type="text" placeholder="ğŸ” æœå°‹åº—åã€åœ°å€æˆ–è² è²¬äºº..." 
                   class="w-full px-4 py-3 rounded-xl border border-gray-200 shadow-inner focus:ring-2 focus:ring-blue-500 outline-none text-sm bg-white">
          </div>
          <button @click="toggleSort" :class="['w-12 md:w-16 shrink-0 rounded-xl border shadow-sm font-bold text-lg flex items-center justify-center transition active:scale-95', sortDesc ? 'bg-blue-50 border-blue-200 text-blue-600' : 'bg-white border-gray-200 text-gray-600']">â‡…</button>
          <button @click="loadData" class="w-12 md:w-16 shrink-0 bg-white rounded-xl border border-gray-200 shadow-sm text-lg flex items-center justify-center hover:bg-gray-50 active:scale-95 transition">ğŸ”„</button>
        </div>
        
        <div class="flex overflow-x-auto w-full gap-2 no-scrollbar mb-3 pb-1">
          <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id"
                  :class="['flex-1 min-w-[75px] flex flex-col items-center justify-center py-2 px-2 rounded-xl border transition-all duration-200 shadow-sm', currentTab === tab.id ? tab.activeClass + ' scale-105 border-white ring-2 ring-offset-1 z-10 ' + tab.ringClass : 'bg-white text-gray-500 border-gray-100 hover:bg-gray-50']">
            <span class="text-lg leading-none mb-1">[[ tab.icon ]]</span>
            <span class="text-[11px] font-bold mb-1 whitespace-nowrap">[[ tab.label ]]</span>
            <span :class="['text-[10px] px-2 py-0.5 rounded-lg font-bold', currentTab === tab.id ? 'bg-white text-gray-900 shadow-sm' : 'bg-gray-100 text-gray-400']">[[ getTabCount(tab.id) ]]</span>
          </button>
        </div>

        <div class="flex gap-2 w-full">
          <button @click="toggleFilterPanel" :class="['flex-1 py-2.5 rounded-xl font-bold text-sm border shadow-sm transition flex justify-center items-center gap-1', showFilter ? 'bg-blue-500 text-white border-blue-600' : 'bg-white text-gray-600 border-gray-200']">ğŸŒªï¸ é€²éšç¯©é¸ <span v-if="activeFilterCount > 0" class="bg-white text-blue-600 px-1.5 py-0.5 rounded-md text-[10px] ml-1">[[ activeFilterCount ]]</span></button>
          <button @click="toggleChartPanel" :class="['flex-1 py-2.5 rounded-xl font-bold text-sm border shadow-sm transition flex justify-center items-center gap-1', showChart ? 'bg-purple-600 text-white border-purple-700' : 'bg-white text-gray-600 border-gray-200']">ğŸ“Š æ•¸æ“šå ±è¡¨</button>
        </div>

        <transition name="slide-fade">
          <div v-show="showFilter" class="mt-3 bg-white border border-gray-200 rounded-2xl shadow-lg p-5 w-full">
            <div class="mb-6 bg-gray-50 p-4 rounded-xl border border-gray-100 shadow-inner">
              <p class="text-[13px] font-bold text-gray-500 mb-3">ğŸ“… å¡«å–®æ—¥æœŸå€é–“</p>
              <div class="grid grid-cols-4 gap-2 mb-3">
                <button v-for="t in ['thisMonth','lastMonth','thisWeek','lastWeek']" :key="t" @click="setQuickDate(t)" class="py-2 bg-white border border-gray-200 rounded-lg text-xs font-bold text-gray-600 active:bg-blue-600 active:text-white transition">[[ {thisMonth:'æœ¬æœˆ',lastMonth:'ä¸Šæœˆ',thisWeek:'æœ¬é€±',lastWeek:'ä¸Šé€±'}[t] ]]</button>
              </div>
              <div class="flex items-center gap-2">
                <input type="date" v-model="filterStartDate" @change="validateDateRange" class="flex-1 p-2 rounded-lg border border-gray-300 text-sm">
                <span class="text-gray-400">â</span>
                <input type="date" v-model="filterEndDate" @change="validateDateRange" class="flex-1 p-2 rounded-lg border border-gray-300 text-sm">
              </div>
            </div>
            
            <div class="space-y-4">
              <div><p class="text-xs font-bold text-gray-400 mb-2 uppercase tracking-widest">ğŸ“¢ ä¾†æº (å¯å¤šé¸)</p><div class="flex flex-wrap gap-2"><button v-for="v in uniqueSources" :key="v" @click="toggleFilterItem('Source',v)" :class="['px-3 py-1.5 rounded-lg text-xs font-bold border transition', filterSource.includes(v)?'bg-blue-600 text-white border-blue-700 shadow-md':'bg-gray-50 text-gray-500 border-gray-200']">[[ v ]]</button></div></div>
              <div><p class="text-xs font-bold text-gray-400 mb-2 uppercase tracking-widest">ğŸ™ï¸ åœ°å€ (å¯å¤šé¸)</p><div class="flex flex-wrap gap-2"><button v-for="v in uniqueAreas" :key="v" @click="toggleFilterItem('Area',v)" :class="['px-3 py-1.5 rounded-lg text-xs font-bold border transition', filterArea.includes(v)?'bg-orange-500 text-white border-orange-600 shadow-md':'bg-gray-50 text-gray-500 border-gray-200']">[[ v ]]</button></div></div>
              <div><p class="text-xs font-bold text-gray-400 mb-2 uppercase tracking-widest">ğŸ­ ç”¢æ¥­ (å¯å¤šé¸)</p><div class="flex flex-wrap gap-2"><button v-for="v in uniqueIndustries" :key="v" @click="toggleFilterItem('Industry',v)" :class="['px-3 py-1.5 rounded-lg text-xs font-bold border transition', filterIndustry.includes(v)?'bg-green-600 text-white border-green-700 shadow-md':'bg-gray-50 text-gray-500 border-gray-200']">[[ v ]]</button></div></div>
            </div>
            <button @click="clearFilters" class="w-full py-3 mt-6 bg-red-50 text-red-500 font-bold text-sm rounded-xl border border-red-100 active:bg-red-100 transition shadow-sm">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æ¢ä»¶</button>
          </div>
        </transition>

        <transition name="slide-fade">
          <div v-show="showChart" class="mt-3 bg-white border border-gray-200 rounded-2xl shadow-lg p-5 w-full">
            <div class="flex justify-around bg-gray-50 p-4 rounded-xl border border-gray-100 mb-5 shadow-inner">
              <div class="text-center w-1/2 border-r border-gray-200"><p class="text-[10px] text-gray-500 font-bold mb-1">ğŸš€ æ´¾å–®è½‰åŒ–ç‡</p><p class="text-3xl font-black text-green-600">[[ conversionRate ]]%</p></div>
              <div class="text-center w-1/2"><p class="text-[10px] text-gray-500 font-bold mb-1">ğŸ—‘ï¸ åƒåœ¾å–®ç‡</p><p class="text-3xl font-black text-red-600">[[ junkRate ]]%</p></div>
            </div>
            <p class="text-sm font-bold text-gray-500 mb-3">ğŸ† æ¥­å‹™æ‰‹æŒæ´¾å–®æ’è¡Œ (ä¾ç•¶å‰ç¯©é¸)</p>
            <div class="space-y-3 bg-gray-50 p-4 rounded-xl shadow-inner">
              <div v-for="(count, name) in salesLeaderboard" :key="name" class="flex items-center gap-3">
                <span class="text-xs font-bold text-gray-600 w-14 truncate text-right">[[ name ]]</span>
                <div class="flex-grow bg-gray-200 rounded-full h-3 overflow-hidden shadow-inner"><div class="bg-purple-600 h-full rounded-full transition-all duration-500" :style="{ width: (count / maxSalesCount * 100) + '%' }"></div></div>
                <span class="text-xs font-black text-purple-600 w-8">[[ count ]]</span>
              </div>
            </div>
          </div>
        </transition>
      </div>

      <div v-if="loading" class="text-center py-20 text-gray-400 font-bold animate-pulse"><div class="w-12 h-12 border-4 border-gray-200 border-t-blue-500 rounded-full animate-spin mx-auto mb-4"></div>è³‡æ–™åŒæ­¥ä¸­...</div>
      <div v-else-if="finalSortedData.length === 0" class="text-center py-20 text-gray-400 font-bold text-lg">æ­¤æ¢ä»¶ä¸‹ç›®å‰ç„¡ç¬¦åˆåå–® ğŸ“­</div>

      <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        <div v-for="(item, index) in finalSortedData" :key="index" class="bg-white rounded-2xl shadow-md border border-gray-100 overflow-hidden flex flex-col h-full border-t-[6px]" :style="{ borderTopColor: getCategoryColor(getCategory(item)) }">
          <div class="p-5 flex flex-col flex-grow">
            <div class="flex justify-between items-start mb-3">
              <span class="bg-gray-100 text-gray-500 font-bold px-2 py-1 rounded-lg text-[10px] tracking-wider flex items-center gap-1">#[[ item.id ]] <span class="bg-gray-200 px-1 rounded">ğŸ­ [[ item.industry || 'ä¸€èˆ¬' ]]</span></span>
              <span class="bg-green-600 text-white font-bold px-2 py-1 rounded text-[10px] shadow-sm">[[ item.source ]]</span>
            </div>
            
            <h2 class="text-xl font-black text-gray-800 leading-tight mb-3 flex items-start gap-2">[[ item.area ]][[ item.storeName ]] <button @click="copyText(item.area + item.storeName)" class="text-gray-300 hover:text-gray-500 active:scale-90 transition shrink-0">ğŸ“„</button></h2>
            
            <div :class="['border border-dashed rounded-xl px-3 py-2 mb-4 text-[13px] font-bold flex items-center gap-2', getActionAlert(item).color]"><span>ğŸ””</span> [[ getActionAlert(item).text ]]</div>
            
            <div class="bg-blue-50/50 rounded-xl p-4 mb-4 border border-blue-50 text-[13px]">
              <p class="font-bold text-gray-700 mb-2 flex items-center gap-2">ğŸ‘¤ è² è²¬äºº: [[ item.bossName || 'æœªå¡«' ]]</p>
              <p class="font-bold text-gray-700 mb-2 flex items-center gap-2">ğŸ“ é›»è©±: [[ item.phone || '--' ]] <button @click="copyText(item.phone)" class="text-gray-300 hover:text-gray-500">ğŸ“„</button></p>
              <p class="font-bold text-gray-700 mb-2 flex items-center gap-2">ğŸ†” Line: [[ item.lineId || '--' ]] <button @click="copyText(item.lineId)" class="text-gray-300 hover:text-gray-500">ğŸ“„</button></p>
              <p class="font-bold text-orange-600 mt-2 pt-2 border-t border-dashed border-blue-100">ğŸ“ éœ€æ±‚: [[ item.adDemand || 'ç„¡' ]]</p>
            </div>

            <div class="flex flex-wrap gap-1.5 mb-4">
              <span v-for="tag in ['åŠ Line','å·²è®€','æ’¥é›»è©±','æ˜¯å¦æ’¥é€š','Email']" :key="tag" :class="pillClass(tag, item)" class="px-2.5 py-1 rounded-full text-[10px] font-bold border transition-colors shadow-sm">[[ tag ]]</span>
            </div>

            <div class="mb-6">
              <p class="text-xs font-bold text-gray-500 mb-1.5 flex items-center gap-1">ğŸ“ æœ€æ–°ç´€éŒ„</p>
              <div class="bg-gray-50 rounded-xl p-3 text-xs text-gray-600 min-h-[60px] whitespace-pre-wrap line-clamp-3 border border-gray-100 shadow-inner">[[ item.note || 'ç„¡' ]]</div>
            </div>

            <div class="mt-auto space-y-2.5">
              <div class="grid grid-cols-3 gap-2.5">
                <button @click="openLineModal(item)" class="bg-white border border-gray-200 text-gray-700 py-3 rounded-2xl font-black text-xs shadow-sm active:bg-gray-50 flex flex-col items-center justify-center">ğŸ’¬<span class="mt-1">Line</span></button>
                <a :href="'tel:' + item.phone" class="bg-white border border-gray-200 text-gray-700 py-3 rounded-2xl font-black text-xs shadow-sm active:bg-gray-50 flex flex-col items-center justify-center">ğŸ“<span class="mt-1">é›»è©±</span></a>
                <a :href="'mailto:' + item.email" class="bg-white border border-gray-200 text-gray-700 py-3 rounded-2xl font-black text-xs shadow-sm active:bg-gray-50 flex flex-col items-center justify-center">âœ‰ï¸<span class="mt-1">Email</span></a>
              </div>
              <div class="grid grid-cols-3 gap-2.5">
                <a :href="'https://www.google.com/maps/search/' + item.area + item.storeName" target="_blank" class="bg-white border border-gray-200 text-gray-700 py-3 rounded-2xl font-black text-xs shadow-sm active:bg-gray-50 flex flex-col items-center justify-center">ğŸ—ºï¸<span class="mt-1">åœ°åœ–</span></a>
                <button @click="openUpdateModal(item)" class="bg-orange-500 text-white py-3 rounded-2xl font-black text-xs shadow-lg active:scale-95 flex flex-col items-center justify-center">ğŸ“<span class="mt-1">æ›´æ–°</span></button>
                <button @click="openDispatch(item)" class="bg-purple-600 text-white py-3 rounded-2xl font-black text-xs shadow-lg active:scale-95 flex flex-col items-center justify-center">ğŸš€<span class="mt-1">æ´¾å–®</span></button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <transition name="modal-fade">
        <div v-if="showLineModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-gray-900/60 backdrop-blur-sm" @click.self="closeLineModal">
          <div class="bg-white w-full max-w-md rounded-t-[2.5rem] sm:rounded-[2rem] p-7 shadow-2xl overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-6 border-b border-gray-100 pb-3">
              <h3 class="text-xl font-black text-gray-800">ğŸ  [[ currentLineItem?.storeName ]]</h3>
              <button @click="closeLineModal" class="text-gray-300 hover:text-gray-700 text-3xl font-bold transition">âœ•</button>
            </div>
            <button @click="jumpAndCopyName" class="w-full bg-blue-600 text-white font-black py-5 rounded-[1.5rem] shadow-xl shadow-blue-200 mb-8 active:scale-95 transition">ğŸ†” æ‰“é–‹ LINE ä¸¦è¤‡è£½åç¨±<p class="text-[11px] opacity-70 mt-1 font-bold tracking-wider">å°‡è‡ªå‹•è¤‡è£½ï¼šã€ŒğŸ‘¤[[ currentLineItem?.storeName ]]-ã€</p></button>
            <p class="text-sm font-bold text-gray-500 mb-3 text-center tracking-widest">STEP 2: å‚³é€åç‰‡ (é•·æŒ‰å„²å­˜åœ–æª”)</p>
            <img src="https://happy08200822.github.io/ezpretty-liff/card.jpg" class="max-h-36 mx-auto mb-8 rounded-2xl border-4 border-gray-50 shadow-md">
            <div class="flex gap-1 bg-gray-100 p-1 rounded-2xl mb-4 shadow-inner">
              <button v-for="t in ['first','follow','success']" :key="t" @click="lineScriptTab = t" :class="['flex-1 py-2.5 rounded-xl text-xs font-black transition', lineScriptTab === t ? 'bg-white text-blue-600 shadow-md' : 'text-gray-400']">[[ {first:'åˆæ¬¡',follow:'äºŒæ•²',success:'é‚€ç´„'}[t] ]]</button>
            </div>
            <textarea readonly v-model="lineScriptContent" class="w-full h-28 p-4 bg-gray-50 border border-gray-200 rounded-2xl text-xs mb-4 resize-none shadow-inner leading-relaxed text-gray-600 font-bold"></textarea>
            <button @click="copyScript" class="w-full bg-emerald-500 text-white font-black py-4 rounded-[1.25rem] shadow-xl shadow-emerald-100 active:scale-95 transition text-[15px]">ğŸ“‹ è¤‡è£½é–‹ç™¼è©±è¡“</button>
          </div>
        </div>
      </transition>

      <transition name="modal-fade">
        <div v-if="showUpdateModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-gray-900/60 backdrop-blur-sm" @click.self="closeUpdateModal">
          <div class="bg-white w-full max-w-md rounded-t-[2.5rem] sm:rounded-[2rem] p-7 shadow-2xl overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-6 border-b border-gray-100 pb-3">
              <h3 class="text-xl font-black text-gray-800 tracking-tight">ğŸ“ æ›´æ–°ï¼š[[ currentItem?.storeName ]]</h3>
              <button @click="closeUpdateModal" class="text-gray-300 hover:text-gray-700 text-3xl font-bold transition">âœ•</button>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-6">
              <button @click="editData.newTracking = 'è¯çµ¡ä¸­'" :class="['py-4 rounded-2xl font-black text-sm transition shadow-sm', editData.newTracking === 'è¯çµ¡ä¸­' ? 'bg-blue-600 text-white shadow-blue-200' : 'bg-gray-100 text-gray-500']">ğŸ“ è¯çµ¡ä¸­</button>
              <button @click="editData.newTracking = 'æ‹’çµ•'" :class="['py-4 rounded-2xl font-black text-sm transition shadow-sm', editData.newTracking === 'æ‹’çµ•' ? 'bg-red-600 text-white shadow-red-200' : 'bg-gray-100 text-gray-500']">ğŸš« æ‹’çµ•/ç„¡æ•ˆ</button>
            </div>
            <p class="text-xs font-bold text-gray-400 mb-3 tracking-widest uppercase">ğŸ“ è¯çµ¡é€²åº¦å‹¾é¸</p>
            <div class="flex flex-wrap gap-2 mb-6">
              <button v-for="tag in ['åŠ Line','å·²è®€','æ’¥é›»è©±','æ˜¯å¦æ’¥é€š','Email']" :key="tag" @click="toggleEditCheck(tag)"
                      :class="['px-4 py-2.5 rounded-xl text-[11px] font-black border transition-all', isTagChecked(tag) ? 'bg-blue-600 text-white border-blue-700 shadow-md' : 'bg-white text-gray-400 border-gray-200 shadow-sm']">[[ tag ]]</button>
            </div>
            <p class="text-xs font-bold text-gray-400 mb-3 tracking-widest uppercase">âš¡ å¿«é€Ÿç´€éŒ„å™¨ (é»æ“Šè‡ªå‹•ç´¯åŠ )</p>
            <div class="grid grid-cols-3 gap-2.5 mb-5 text-[11px]">
              <button @click="addNoteAction('call')" class="py-3 bg-blue-50 text-blue-600 rounded-xl font-black border border-blue-100 active:bg-blue-100 transition">ğŸ“ æ’¥æ‰“ç´€éŒ„</button>
              <button @click="addNoteAction('line')" class="py-3 bg-emerald-50 text-emerald-600 rounded-xl font-black border border-emerald-100 active:bg-emerald-100 transition">ğŸ’¬ å‚³Lineç´€éŒ„</button>
              <button @click="addNoteManual('ç„¡äººæ¥è½')" class="py-3 bg-gray-100 text-gray-600 rounded-xl font-black border border-gray-200 active:bg-gray-200">ç„¡äººæ¥è½</button>
            </div>
            <textarea v-model="editData.note" class="w-full h-44 p-4 bg-gray-50 border border-gray-200 rounded-2xl text-[13px] text-gray-600 mb-6 focus:ring-2 focus:ring-blue-500 outline-none resize-none font-mono shadow-inner leading-relaxed font-bold"></textarea>
            <button @click="submitUpdate" :disabled="isUpdating" class="w-full bg-gray-800 text-white font-black py-5 rounded-[1.5rem] shadow-2xl shadow-gray-200 active:scale-95 transition flex justify-center items-center gap-3">
              <span v-if="isUpdating" class="w-5 h-5 border-3 border-white/30 border-t-white rounded-full animate-spin"></span>
              [[ isUpdating ? 'æ­£åœ¨å„²å­˜ä¸­...' : 'ğŸ’¾ å„²å­˜æ‰€æœ‰æ›´æ–°' ]]
            </button>
          </div>
        </div>
      </transition>

      <div v-if="toastMessage" class="fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-8 py-3.5 rounded-full text-sm font-black shadow-2xl z-50 transition-all tracking-wider">[[ toastMessage ]]</div>
    </div>

    <script>
      const GAS_URL = "https://script.google.com/macros/s/AKfycbzIKHpWcWj0bOhaQsx-OynY5FVVorMJvTNON5PBOywj1q-Nd5EylLCSl-zTlFW9Rb5U/exec";
      const { createApp } = Vue;
      createApp({
        delimiters: ['[[', ']]'],
        data() { 
          return { 
            salesData: [], searchQuery: '', currentTab: 'new', loading: true, toastMessage: '',
            sortDesc: true, showFilter: false, showChart: false,
            filterSource: [], filterArea: [], filterIndustry: [], filterStartDate: '', filterEndDate: '',
            showLineModal: false, currentLineItem: null, lineScriptTab: 'first',
            showUpdateModal: false, isUpdating: false, currentItem: null,
            editData: { newTracking: '', addLine: '', readStatus: '', callStatus: '', isConnected: '', emailSent: '', note: '' },
            tabs: [
              { id: 'all', icon: 'ğŸ“‚', label: 'å…¨éƒ¨', activeClass: 'bg-gray-700 text-white', ringClass: 'ring-gray-300' },
              { id: 'new', icon: 'ğŸ†•', label: 'æ–°å–®', activeClass: 'bg-[#00C851] text-white', ringClass: 'ring-green-300' },
              { id: 'unread', icon: 'ğŸ“²', label: 'æœªè®€', activeClass: 'bg-[#ffbb33] text-[#5c3a00]', ringClass: 'ring-yellow-300' },
              { id: 'read', icon: 'ğŸ‘€', label: 'å·²è®€', activeClass: 'bg-[#ff4444] text-white', ringClass: 'ring-red-300' },
              { id: 'noline', icon: 'ğŸ“µ', label: 'æ²’Line', activeClass: 'bg-[#33b5e5] text-white', ringClass: 'ring-cyan-300' },
              { id: 'dispatched', icon: 'ğŸš€', label: 'å·²æ´¾å–®', activeClass: 'bg-[#9c27b0] text-white', ringClass: 'ring-purple-300' },
              { id: 'self', icon: 'ğŸ’ª', label: 'è‡ªé–‹ä»¶', activeClass: 'bg-[#00897b] text-white', ringClass: 'ring-teal-300' },
              { id: 'invalid', icon: 'ğŸ’€', label: 'ç„¡æ•ˆ', activeClass: 'bg-[#6c757d] text-white', ringClass: 'ring-gray-300' }
            ]
          } 
        },
        computed: {
          uniqueSources() { return [...new Set(this.salesData.map(i => i.source).filter(Boolean))].sort(); },
          uniqueAreas() { return [...new Set(this.salesData.map(i => i.area).filter(Boolean))].sort(); },
          uniqueIndustries() { return [...new Set(this.salesData.map(i => i.industry).filter(Boolean))].sort(); },
          activeFilterCount() { return this.filterSource.length + this.filterArea.length + this.filterIndustry.length + (this.filterStartDate || this.filterEndDate ? 1 : 0); },
          filteredData() {
            return this.salesData.filter(item => {
              const s = this.searchQuery.toLowerCase();
              const matchSearch = !s || (item.storeName + item.area + item.bossName + item.id).toLowerCase().includes(s);
              const matchSrc = this.filterSource.length === 0 || this.filterSource.includes(item.source);
              const matchArea = this.filterArea.length === 0 || this.filterArea.includes(item.area);
              const matchInd = this.filterIndustry.length === 0 || this.filterIndustry.includes(item.industry);
              let matchDate = true;
              if (this.filterStartDate || this.filterEndDate) {
                const itemDate = new Date(item.formDate);
                if (this.filterStartDate && itemDate < new Date(this.filterStartDate)) matchDate = false;
                if (this.filterEndDate && itemDate > new Date(this.filterEndDate + 'T23:59:59')) matchDate = false;
              }
              return matchSearch && matchSrc && matchArea && matchInd && matchDate;
            });
          },
          finalSortedData() {
            let res = this.currentTab === 'all' ? this.filteredData : this.filteredData.filter(i => this.getCategory(i) === this.currentTab);
            return res.sort((a,b) => {
              const valA = parseInt(a.id) || 0; const valB = parseInt(b.id) || 0;
              return this.sortDesc ? (valB - valA) : (valA - valB);
            });
          },
          conversionRate() {
            const total = this.filteredData.filter(i => i.source !== 'æ¥­å‹™è‡ªé–‹ä»¶').length;
            if (!total) return 0;
            const disp = this.filteredData.filter(i => i.source !== 'æ¥­å‹™è‡ªé–‹ä»¶' && this.getCategory(i) === 'dispatched').length;
            return Math.round((disp/total)*100);
          },
          junkRate() {
            const total = this.filteredData.filter(i => i.source !== 'æ¥­å‹™è‡ªé–‹ä»¶').length;
            if (!total) return 0;
            const inv = this.filteredData.filter(i => i.source !== 'æ¥­å‹™è‡ªé–‹ä»¶' && this.getCategory(i) === 'invalid').length;
            return Math.round((inv/total)*100);
          },
          salesLeaderboard() {
            const counts = {};
            this.filteredData.filter(i => ['dispatched','self'].includes(this.getCategory(i))).forEach(i => { const o = i.owner || 'æœªæŒ‡æ´¾'; counts[o] = (counts[o] || 0) + 1; });
            return Object.fromEntries(Object.entries(counts).sort(([,a],[,b]) => b-a));
          },
          maxSalesCount() { return Math.max(...Object.values(this.salesLeaderboard), 1); },
          lineScriptContent() {
            if (!this.currentLineItem) return '';
            const { storeName: n, adDemand: r } = this.currentLineItem;
            if (this.lineScriptTab === 'first') return `å“ˆå›‰ è€é—† æ‚¨å¥½ï¼æ‚¨é€™é‚Šæ˜¯ ${n} åº—å®¶å—ï½\næˆ‘æ˜¯ ezPretty çš„æ¥­å‹™ç¶“ç† æšåº­ ğŸ˜Š\nå‰›æ‰æœ‰æ”¶åˆ°æ‚¨çš„è«®è©¢ï¼Œæ‚¨æƒ³äº†è§£ã€${r||'ç›¸é—œ'}ã€‘çš„åŠŸèƒ½å—ï¼Ÿ\n\næ‚¨çœ‹åˆ°è¨Šæ¯å¾Œï¼Œæ–¹ä¾¿è·Ÿæ‚¨é€šè©±1åˆ†é˜å—ï¼Ÿ`;
            if (this.lineScriptTab === 'follow') return `å“ˆå›‰è€é—†ï¼Œæ“”å¿ƒæ‚¨è¿‘æ—¥å¿™ç¢Œæ¼æ‰è¨Šæ¯ï¼Œæ‰€ä»¥å†è·Ÿæ‚¨æ‰“å€‹æ‹›å‘¼ ğŸ˜Š\n\nè¿‘æœŸæœ‰æ”¶åˆ°æ‚¨çš„è«®è©¢ï¼Œæ‚¨æƒ³äº†è§£æˆ‘å€‘é ç´„posç³»çµ±çš„ã€${r||'ç›¸é—œ'}ã€‘çš„åŠŸèƒ½å—ï¼Ÿ`;
            return `å¥½çš„ï¼Œæˆ‘å¾…æœƒæ‹‰å€‹ç¾¤çµ„ï¼Œç”±å°ˆå“¡ç‚ºæ‚¨æœå‹™ï¼`;
          }
        },
        mounted() { this.loadData(); },
        methods: {
          loadData() { 
            this.loading = true; 
            fetch(GAS_URL + "?action=getWarRoomData")
              .then(res => res.json()).then(d => { this.salesData = d; this.loading = false; })
              .catch(e => { alert("æŠ“å–å¤±æ•—: " + e.message); this.loading = false; });
          },
          // ğŸ“ æ›´æ–°é¢æ¿å°ˆç”¨
          openUpdateModal(item) {
            this.currentItem = item;
            this.editData = JSON.parse(JSON.stringify(item));
            if (!this.editData.note || this.editData.note === 'ç„¡') {
              this.editData.note = "å‚³lineç´€éŒ„ï¼ˆå…±0æ¬¡ï¼‰ï¼š\næ’¥æ‰“ç´€éŒ„ï¼ˆå…±0æ¬¡ï¼‰ï¼š\næ‰‹å‹•ç´€éŒ„ï¼š";
            }
            this.showUpdateModal = true;
          },
          closeUpdateModal() { this.showUpdateModal = false; },
          isTagChecked(tag) {
            const m = { 'åŠ Line':'addLine', 'å·²è®€':'readStatus', 'æ’¥é›»è©±':'callStatus', 'æ˜¯å¦æ’¥é€š':'isConnected', 'Email':'emailSent' };
            return String(this.editData[m[tag]]).includes('âœ…');
          },
          toggleEditCheck(tag) {
            const m = { 'åŠ Line':'addLine', 'å·²è®€':'readStatus', 'æ’¥é›»è©±':'callStatus', 'æ˜¯å¦æ’¥é€š':'isConnected', 'Email':'emailSent' };
            const key = m[tag];
            this.editData[key] = String(this.editData[key]).includes('âœ…') ? '' : 'âœ…';
          },
          addNoteAction(type) {
            const now = new Date();
            const timeStr = `[ ${now.getMonth()+1}/${now.getDate()} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')} ]`;
            const label = type === 'call' ? 'æ’¥æ‰“ç´€éŒ„' : 'å‚³lineç´€éŒ„';
            const regex = new RegExp(`${label}ï¼ˆå…±(\\d+)æ¬¡ï¼‰ï¼š`);
            const match = this.editData.note.match(regex);
            if (match) {
              const count = parseInt(match[1]) + 1;
              this.editData.note = this.editData.note.replace(regex, `${label}ï¼ˆå…±${count}æ¬¡ï¼‰ï¼š\n${timeStr} ${type==='call'?'å·²æ’¥æ‰“':'å·²å‚³è¨Š'}`);
            }
          },
          addNoteManual(text) { this.editData.note = this.editData.note.replace('æ‰‹å‹•ç´€éŒ„ï¼š', `æ‰‹å‹•ç´€éŒ„ï¼š\n[${text}] `); },
          submitUpdate() {
            this.isUpdating = true;
            const params = new URLSearchParams({
              action: 'updateProgress', key: this.currentItem.id, note: this.editData.note,
              isL: String(String(this.editData.addLine).includes('âœ…')), 
              isM: String(String(this.editData.readStatus).includes('âœ…')),
              isN: String(String(this.editData.callStatus).includes('âœ…')), 
              isO: String(String(this.editData.isConnected).includes('âœ…')),
              isQ: String(String(this.editData.emailSent).includes('âœ…')),
              progress: `${new Date().toLocaleDateString()} | ${this.editData.newTracking}`
            });
            fetch(GAS_URL + "?" + params.toString(), { method: "POST" })
              .then(res => res.text()).then(r => { if(r==="Success") { this.showToast("æ›´æ–°æˆåŠŸï¼"); this.loadData(); this.closeUpdateModal(); } })
              .finally(() => this.isUpdating = false);
          },
          // ğŸ’¬ LINE é¢æ¿å°ˆç”¨
          openLineModal(item) { this.currentLineItem = item; this.showLineModal = true; },
          closeLineModal() { this.showLineModal = false; },
          jumpAndCopyName() {
            const name = `ğŸ‘¤${this.currentLineItem.storeName}-`;
            this.copyText(name);
            this.showToast(`å·²è¤‡è£½ï¼šã€Œ${name}ã€æº–å‚™è·³è½‰ LINE...`);
            setTimeout(() => window.open('https://line.me/ti/p/~' + (this.currentLineItem.lineId || this.currentLineItem.phone)), 800);
          },
          copyScript() { this.copyText(this.lineScriptContent); this.showToast('âœ… è©±è¡“å·²è¤‡è£½ï¼'); },
          // ğŸ› ï¸ æ ¸å¿ƒé€šç”¨
          getCategory(i) {
            const L=String(i.addLine).includes('âœ…'), M=String(i.readStatus).includes('âœ…'), N=String(i.callStatus).includes('âœ…'), O=String(i.isConnected).includes('âœ…');
            if (i.owner) return i.source === 'æ¥­å‹™è‡ªé–‹ä»¶' ? 'self' : 'dispatched';
            if (String(i.status).includes('æ‹’çµ•') || String(i.status).includes('ç„¡æ•ˆ')) return 'invalid';
            if (!L && !M && !N && !O) return 'new';
            if (L && !M) return 'unread';
            if (L && M) return 'read';
            return 'noline';
          },
          getActionAlert(i) {
            const c = this.getCategory(i);
            if(c==='new') return {text:'ğŸ†• æ–°å–®è«‹è¯çµ¡ï¼', color:'text-green-600 bg-green-50 border-green-200'};
            if(c==='unread') return {text:'ğŸ“ è«‹ä¸€å®šè¦æ‰“é›»è©±ï¼', color:'text-red-500 bg-red-50 border-red-200'};
            if(c==='read') return {text:'ğŸ”¥ å·²è®€å·²é€šï¼è©²æ´¾å–®äº†ï¼', color:'text-red-500 bg-red-50 border-red-200'};
            if(c==='self') return {text:'ğŸ’ª æ¥­å‹™è‡ªé–‹ï¼š' + i.owner, color:'text-teal-600 bg-teal-50 border-teal-200'};
            if(c==='dispatched') return {text:'ğŸš€ å·²æ´¾å–®çµ¦ï¼š' + i.owner, color:'text-purple-600 bg-purple-50 border-purple-200'};
            return {text:'ğŸ“ è¿½è¹¤ç´€éŒ„ï¼š' + (i.status || 'æœªå®šç¾©'), color:'text-gray-500 bg-gray-50 border-gray-200'};
          },
          pillClass(t, i) {
            const m = {'åŠ Line':'addLine','å·²è®€':'readStatus','æ’¥é›»è©±':'callStatus','æ˜¯å¦æ’¥é€š':'isConnected','Email':'emailSent'};
            return String(i[m[t]]).includes('âœ…') ? 'bg-blue-600 text-white border-blue-700' : 'bg-gray-100 text-gray-400 border-transparent';
          },
          toggleSort() { this.sortDesc = !this.sortDesc; },
          toggleFilterPanel() { this.showFilter = !this.showFilter; this.showChart = false; },
          toggleChartPanel() { this.showChart = !this.showChart; this.showFilter = false; },
          toggleFilterItem(type, val) { const a = this['filter'+type]; const i = a.indexOf(val); if(i>-1) a.splice(i,1); else a.push(val); },
          clearFilters() { this.filterSource = []; this.filterArea = []; this.filterIndustry = []; this.filterStartDate = ''; this.filterEndDate = ''; },
          setQuickDate(t) {
            const now = new Date(); const fmt = d => d.toISOString().split('T')[0];
            if(t==='thisMonth') { this.filterStartDate = fmt(new Date(now.getFullYear(), now.getMonth(), 1)); this.filterEndDate = fmt(new Date(now.getFullYear(), now.getMonth()+1, 0)); }
            else if(t==='lastMonth') { this.filterStartDate = fmt(new Date(now.getFullYear(), now.getMonth()-1, 1)); this.filterEndDate = fmt(new Date(now.getFullYear(), now.getMonth(), 0)); }
            else if(t==='thisWeek') { const d = now.getDay()||7; this.filterStartDate = fmt(new Date(now.setDate(now.getDate()-d+1))); this.filterEndDate = fmt(new Date(now.setDate(now.getDate()+6))); }
            else if(t==='lastWeek') { const d = now.getDay()||7; const lastMon = new Date(); lastMon.setDate(now.getDate()-d-6); this.filterStartDate = fmt(lastMon); const lastSun = new Date(lastMon); lastSun.setDate(lastMon.getDate()+6); this.filterEndDate = fmt(lastSun); }
          },
          validateDateRange() { if (this.filterStartDate && this.filterEndDate && this.filterStartDate > this.filterEndDate) [this.filterStartDate, this.filterEndDate] = [this.filterEndDate, this.filterStartDate]; },
          getTabCount(id) { return id==='all'?this.filteredData.length:this.filteredData.filter(i=>this.getCategory(i)===id).length; },
          getCategoryColor(c) { return {new:'#00C851',unread:'#ffbb33',read:'#ff4444',noline:'#33b5e5',dispatched:'#9c27b0',self:'#00897b',invalid:'#6c757d'}[c]||'#ccc'; },
          copyText(text) { if (!text) return; const el = document.createElement('textarea'); el.value = text; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); this.showToast('å·²è¤‡è£½ï¼'); },
          showToast(m) { this.toastMessage = m; setTimeout(() => this.toastMessage = '', 2000); },
          openDispatch(item) { window.open('https://happy08200822.github.io/ezpretty-liff/dispatch.html?key=' + item.id + '&store=' + encodeURIComponent(item.storeName)); }
        }
      }).mount('#app');
    </script>
  </body>
</html>

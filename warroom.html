<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
      /* åŠ å…¥ !important å¼·åˆ¶éš±è—ï¼Œé¿å…è¼‰å…¥æ™‚é–ƒçˆç ´ç‰ˆ */
      [v-cloak] { display: none !important; } 
      body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background-color: #f4f6f9; -webkit-tap-highlight-color: transparent; }
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      
      .slide-fade-enter-active, .slide-fade-leave-active { transition: all 0.3s ease-in-out; }
      .slide-fade-enter-from, .slide-fade-leave-to { transform: translateY(-10px); opacity: 0; max-height: 0; overflow: hidden; }
      .slide-fade-enter-to, .slide-fade-leave-from { transform: translateY(0); opacity: 1; max-height: 1200px; }
      
      .modal-fade-enter-active, .modal-fade-leave-active { transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
      .modal-fade-enter-from, .modal-fade-leave-to { transform: translateY(100%); opacity: 0; }
      .modal-fade-enter-to, .modal-fade-leave-from { transform: translateY(0); opacity: 1; }
    </style>
  </head>
  <body class="pb-20">
    <div id="app" v-cloak class="w-full px-3 md:px-6 pt-2">
      
      <div class="sticky top-0 z-30 bg-[#f4f6f9] pb-3 mb-2 border-b border-gray-200">
        <div class="flex gap-2 mb-3">
          <input v-model="searchQuery" type="text" placeholder="ğŸ” æœå°‹åº—åã€åœ°å€æˆ–è² è²¬äºº..." 
                 class="flex-grow px-4 py-3 rounded-2xl border border-gray-200 shadow-inner focus:ring-2 focus:ring-blue-500 outline-none text-sm bg-white">
          <button @click="toggleSort" :class="['w-12 shrink-0 rounded-2xl border shadow-sm font-bold text-lg transition active:scale-90', sortDesc ? 'bg-blue-50 border-blue-200 text-blue-600' : 'bg-white text-gray-400']">â‡…</button>
          <button @click="loadData" class="w-12 shrink-0 bg-white rounded-2xl border border-gray-200 shadow-sm text-lg active:scale-90 transition">ğŸ”„</button>
        </div>
        
        <div class="flex overflow-x-auto gap-2 no-scrollbar mb-3">
          <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id"
                  :class="['flex-1 min-w-[70px] flex flex-col items-center justify-center py-2 rounded-xl border transition-all duration-200', currentTab === tab.id ? tab.activeClass + ' scale-105 border-white ring-2 ring-offset-1 ' + tab.ringClass : 'bg-white text-gray-500 border-gray-100 shadow-sm']">
            <span class="text-lg leading-none mb-0.5">[[ tab.icon ]]</span>
            <span class="text-[10px] font-bold mb-0.5 whitespace-nowrap">[[ tab.label ]]</span>
            <span :class="['text-[10px] px-1.5 py-0.5 rounded-lg font-black', currentTab === tab.id ? 'bg-white text-gray-900 shadow-sm' : 'bg-gray-100 text-gray-400']">[[ getTabCount(tab.id) ]]</span>
          </button>
        </div>

        <div class="flex gap-2">
          <button @click="toggleFilterPanel" :class="['flex-1 py-3 rounded-2xl font-bold text-xs border shadow-sm transition flex justify-center items-center gap-1', showFilter ? 'bg-blue-600 text-white border-blue-700' : 'bg-white text-gray-600 border-gray-200']">ğŸŒªï¸ ç¯©é¸ <span v-if="activeFilterCount > 0" class="bg-white text-blue-600 px-1.5 py-0.5 rounded-md text-[9px]">[[ activeFilterCount ]]</span></button>
          <button @click="toggleChartPanel" :class="['flex-1 py-3 rounded-2xl font-bold text-xs border shadow-sm transition flex justify-center items-center gap-1', showChart ? 'bg-purple-600 text-white border-purple-700' : 'bg-white text-gray-600 border-gray-200']">ğŸ“Š å ±è¡¨</button>
        </div>

        <transition name="slide-fade">
          <div v-show="showFilter" class="mt-3 bg-white border border-gray-200 rounded-3xl shadow-xl p-5 w-full">
            <div class="mb-6 bg-gray-50 p-4 rounded-2xl border border-gray-100">
              <p class="text-xs font-bold text-gray-400 mb-3 uppercase tracking-wider">ğŸ“… å¡«å–®æ—¥æœŸå€é–“</p>
              <div class="grid grid-cols-4 gap-2 mb-4">
                <button v-for="t in ['thisMonth','lastMonth','thisWeek','lastWeek']" :key="t" @click="setQuickDate(t)" class="py-2.5 bg-white border border-gray-200 rounded-xl text-xs font-bold text-gray-600 active:bg-blue-600 active:text-white transition">[[ {thisMonth:'æœ¬æœˆ',lastMonth:'ä¸Šæœˆ',thisWeek:'æœ¬é€±',lastWeek:'ä¸Šé€±'}[t] ]]</button>
              </div>
              <div class="flex items-center gap-2">
                <input type="date" v-model="filterStartDate" @change="validateDateRange" class="flex-1 p-3 rounded-xl border border-gray-200 text-sm outline-none">
                <span class="text-gray-300">â</span>
                <input type="date" v-model="filterEndDate" @change="validateDateRange" class="flex-1 p-3 rounded-xl border border-gray-200 text-sm outline-none">
              </div>
            </div>
            <div class="space-y-5">
              <div><p class="text-xs font-black text-gray-400 mb-2 tracking-widest">ğŸ“¢ ä¾†æºç¯©é¸</p><div class="flex flex-wrap gap-2"><button v-for="v in uniqueSources" :key="v" @click="toggleFilterItem('Source',v)" :class="['px-3 py-2 rounded-xl text-xs font-bold border transition', filterSource.includes(v)?'bg-blue-600 text-white border-blue-700 shadow-md':'bg-gray-50 text-gray-500 border-gray-200']">[[ v ]]</button></div></div>
              <div><p class="text-xs font-black text-gray-400 mb-2 tracking-widest">ğŸ™ï¸ åœ°å€ç¯©é¸</p><div class="flex flex-wrap gap-2"><button v-for="v in uniqueAreas" :key="v" @click="toggleFilterItem('Area',v)" :class="['px-3 py-2 rounded-xl text-xs font-bold border transition', filterArea.includes(v)?'bg-orange-500 text-white border-orange-600 shadow-md':'bg-gray-50 text-gray-500 border-gray-200']">[[ v ]]</button></div></div>
            </div>
            <button @click="clearFilters" class="w-full py-4 mt-6 bg-red-50 text-red-500 font-black text-sm rounded-2xl border border-red-100 active:bg-red-200 transition">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æ¢ä»¶</button>
          </div>
        </transition>

        <transition name="slide-fade">
          <div v-show="showChart" class="mt-3 bg-white border border-gray-200 rounded-3xl shadow-xl p-5 w-full">
            <div class="flex gap-3 mb-5">
              <div class="flex-1 bg-green-50 p-4 rounded-2xl border border-green-100 text-center"><p class="text-[10px] text-green-600 font-bold mb-1">ğŸš€ æ´¾å–®è½‰åŒ–</p><p class="text-3xl font-black text-green-700">[[ conversionRate ]]%</p></div>
              <div class="flex-1 bg-red-50 p-4 rounded-2xl border border-red-100 text-center"><p class="text-[10px] text-red-600 font-bold mb-1">ğŸ—‘ï¸ åƒåœ¾å–®ç‡</p><p class="text-3xl font-black text-red-700">[[ junkRate ]]%</p></div>
            </div>
            <p class="text-sm font-black text-gray-600 mb-3">ğŸ† æŒ‡æ´¾æ¥­å‹™æ’è¡Œæ¦œ</p>
            <div class="space-y-3 bg-gray-50 p-4 rounded-2xl shadow-inner">
              <div v-for="(count, name) in salesLeaderboard" :key="name" class="flex items-center gap-3">
                <span class="text-xs font-bold text-gray-500 w-14 truncate text-right">[[ name ]]</span>
                <div class="flex-grow bg-gray-200 rounded-full h-4 overflow-hidden shadow-inner"><div class="bg-gradient-to-r from-purple-500 to-purple-700 h-full rounded-full transition-all duration-700" :style="{ width: (count / maxSalesCount * 100) + '%' }"></div></div>
                <span class="text-xs font-black text-purple-700 w-8">[[ count ]]</span>
              </div>
            </div>
          </div>
        </transition>
      </div>

      <div v-if="loading" class="text-center py-20 text-gray-400 font-bold animate-pulse"><div class="w-12 h-12 border-4 border-gray-200 border-t-blue-500 rounded-full animate-spin mx-auto mb-4"></div>åŒæ­¥é›²ç«¯è³‡æ–™ä¸­...</div>
      <div v-else-if="finalSortedData.length === 0" class="text-center py-20 text-gray-400 font-bold text-lg">ç›®å‰æ­¤æ¢ä»¶ç„¡åå–® ğŸ“­</div>

      <div v-else class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
        <div v-for="(item, index) in finalSortedData" :key="index" 
             class="bg-white rounded-[2rem] shadow-sm border border-gray-100 overflow-hidden flex flex-col h-full border-t-[6px]" 
             :style="{ borderTopColor: getCategoryColor(getCategory(item)) }">
          
          <div class="p-4 flex flex-col flex-grow">
            <div class="flex justify-between items-start mb-2">
              <h2 class="text-lg font-black text-gray-800 leading-tight flex-grow pr-2">
                [[ item.area ]][[ item.storeName ]]
                <div :class="['inline-block text-[10px] px-2 py-0.5 rounded-full border ml-1', getActionAlert(item).color]">
                  [[ getActionAlert(item).text.split('ï¼')[0] ]]
                </div>
              </h2>
              <div class="flex flex-col items-end shrink-0">
                <span class="bg-green-600 text-white text-[9px] font-black px-1.5 py-0.5 rounded shadow-sm mb-1">[[ item.source ]]</span>
                <span class="text-[9px] font-bold text-gray-400">[[ formatDate(item.formDate) ]]</span>
              </div>
            </div>
            
            <div class="bg-blue-50/40 rounded-xl px-3 py-2 mb-3 border border-blue-50/50 flex items-center justify-between text-[11px] font-bold">
              <span class="text-gray-700 truncate max-w-[60px]">ğŸ‘¤ [[ item.bossName || 'æœªå¡«' ]]</span>
              <span class="text-gray-300">|</span>
              <span class="text-blue-600 active:scale-95 transition" @click="copyText(item.phone)">ğŸ“ [[ item.phone || '--' ]]</span>
              <span class="text-gray-300">|</span>
              <span class="text-purple-600 active:scale-95 transition" @click="copyText(item.lineId)">ğŸ†” [[ item.lineId || '--' ]]</span>
            </div>

            <p class="text-[11px] font-bold text-orange-600 px-1 mb-3 truncate">ğŸ“ éœ€æ±‚: [[ item.adDemand || 'ç„¡' ]]</p>

            <div class="grid grid-cols-5 gap-1 mb-3">
              <span v-for="tag in ['åŠ Line','å·²è®€','æ’¥é›»è©±','æ˜¯å¦æ’¥é€š','Email']" :key="tag" 
                    :class="[pillClass(tag, item), 'py-1 rounded-md text-[9px] font-black border text-center transition-all']">
                [[ tag === 'æ˜¯å¦æ’¥é€š' ? 'æ’¥é€š' : tag ]]
              </span>
            </div>

            <div class="mb-4 bg-gray-50/60 p-2.5 rounded-2xl border border-gray-100 flex-grow">
              <p class="text-[9px] font-black text-gray-400 mb-1 tracking-tighter">æœ€æ–°è¿½è¹¤ï¼š</p>
              <div class="text-[11px] text-gray-600 line-clamp-2 leading-snug font-bold">[[ item.callCount || 'å°šç„¡ç´€éŒ„' ]]</div>
            </div>

            <div class="space-y-1.5">
              <div class="grid grid-cols-3 gap-1.5">
                <button @click="openLineModal(item)" class="bg-white border border-gray-100 py-2 rounded-xl font-black text-[10px] shadow-sm active:bg-gray-100">ğŸ’¬ Line</button>
                <a :href="'tel:' + item.phone" class="flex items-center justify-center bg-white border border-gray-200 py-2 rounded-xl font-black text-[10px] shadow-sm active:bg-gray-100">ğŸ“ é›»è©±</a>
                <a :href="'mailto:' + item.email" class="flex items-center justify-center bg-white border border-gray-200 py-2 rounded-xl font-black text-[10px] shadow-sm active:bg-gray-100">âœ‰ï¸ Email</a>
              </div>
              <div class="grid grid-cols-3 gap-1.5">
                <a :href="'http://googleusercontent.com/maps.google.com/5' + item.area + item.storeName" target="_blank" class="flex items-center justify-center bg-white border border-gray-200 py-2 rounded-xl font-black text-[10px] shadow-sm active:bg-gray-100">ğŸ—ºï¸ åœ°åœ–</a>
                <button @click="openUpdateModal(item)" class="bg-orange-500 text-white py-2 rounded-xl font-black text-[10px] shadow-md active:scale-95">ğŸ“ æ›´æ–°</button>
                <button @click="openDispatch(item)" class="bg-purple-600 text-white py-2 rounded-xl font-black text-[10px] shadow-md active:scale-95">ğŸš€ æ´¾å–®</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <transition name="modal-fade">
        <div v-if="showLineModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-gray-900/60 backdrop-blur-md" @click.self="closeLineModal">
          <div class="bg-white w-full max-w-md rounded-t-[3rem] sm:rounded-[2.5rem] p-8 shadow-2xl overflow-y-auto max-h-[92vh]">
            <div class="flex justify-between items-center mb-6 pb-2 border-b border-gray-50">
              <h3 class="text-2xl font-black text-gray-800 tracking-tight">ğŸ  [[ currentLineItem?.storeName ]]</h3>
              <button @click="closeLineModal" class="text-gray-300 hover:text-gray-500 text-4xl font-light">âœ•</button>
            </div>
            <button @click="jumpAndCopyName" class="w-full bg-blue-600 text-white font-black py-5 rounded-[1.5rem] shadow-xl shadow-blue-100 mb-8 active:scale-95 transition text-lg flex flex-col items-center">ğŸ†” æ‰“é–‹ LINE ä¸¦è¤‡è£½åç¨±<span class="text-[11px] opacity-70 mt-1 font-bold">è‡ªå‹•å¸¶å…¥ï¼šğŸ‘¤[[ currentLineItem?.storeName ]]-</span></button>
            <p class="text-sm font-black text-gray-400 mb-4 text-center uppercase tracking-widest">STEP 2: å‚³é€åç‰‡ (é•·æŒ‰å„²å­˜åœ–æª”)</p>
            <img src="https://happy08200822.github.io/ezpretty-liff/card.jpg" class="max-h-40 mx-auto mb-8 rounded-3xl border-4 border-gray-50 shadow-lg">
            <div class="flex gap-1 bg-gray-100 p-1.5 rounded-2xl mb-4">
              <button v-for="t in ['first','follow','success']" :key="t" @click="lineScriptTab = t" :class="['flex-1 py-3 rounded-xl text-xs font-black transition-all', lineScriptTab === t ? 'bg-white text-blue-600 shadow-md scale-105' : 'text-gray-400']">[[ {first:'åˆæ¬¡',follow:'äºŒæ•²',success:'é‚€ç´„'}[t] ]]</button>
            </div>
            <textarea readonly v-model="lineScriptContent" class="w-full h-32 p-5 bg-gray-50 border border-gray-100 rounded-3xl text-sm mb-5 resize-none shadow-inner leading-relaxed text-gray-600 font-bold"></textarea>
            <button @click="copyScript" class="w-full bg-emerald-500 text-white font-black py-5 rounded-[1.5rem] shadow-xl active:scale-95 transition text-lg">ğŸ“‹ è¤‡è£½é–‹ç™¼è©±è¡“</button>
          </div>
        </div>
      </transition>

      <transition name="modal-fade">
        <div v-if="showUpdateModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-gray-900/60 backdrop-blur-md" @click.self="closeUpdateModal">
          <div class="bg-white w-full max-w-md rounded-t-[3rem] sm:rounded-[2.5rem] p-8 shadow-2xl overflow-y-auto max-h-[92vh]">
            <div class="flex justify-between items-center mb-6 pb-2 border-b border-gray-50">
              <h3 class="text-xl font-black text-gray-800 tracking-tight">ğŸ“ æ›´æ–°ï¼š[[ currentItem?.area ]][[ currentItem?.storeName ]]</h3>
              <button @click="closeUpdateModal" class="text-gray-300 hover:text-gray-500 text-4xl font-light">âœ•</button>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-8">
              <button @click="editData.newTracking = 'è¯çµ¡ä¸­'" 
                      :class="['py-4 rounded-[1.5rem] font-black text-sm transition-all shadow-sm', String(editData.newTracking || '').includes('è¯çµ¡ä¸­') ? 'bg-blue-600 text-white shadow-md ring-2 ring-blue-200 ring-offset-1 scale-[1.02]' : 'bg-gray-100 text-gray-500 hover:bg-gray-200']">
                ğŸ“ è¯çµ¡ä¸­
              </button>
              <button @click="editData.newTracking = 'æ‹’çµ•/ç„¡æ•ˆ'" 
                      :class="['py-4 rounded-[1.5rem] font-black text-sm transition-all shadow-sm', (String(editData.newTracking || '').includes('æ‹’çµ•') || String(editData.newTracking || '').includes('ç„¡æ•ˆ')) ? 'bg-red-600 text-white shadow-md ring-2 ring-red-200 ring-offset-1 scale-[1.02]' : 'bg-gray-100 text-gray-500 hover:bg-gray-200']">
                ğŸš« æ‹’çµ•/ç„¡æ•ˆ
              </button>
            </div>
            <p class="text-xs font-black text-gray-400 mb-4 tracking-widest uppercase px-1">ğŸ“ è¯çµ¡ç‹€æ…‹å‹¾é¸</p>
            <div class="flex flex-wrap gap-2 mb-8">
              <button v-for="tag in ['åŠ Line','å·²è®€','æ’¥é›»è©±','æ˜¯å¦æ’¥é€š','Email']" :key="tag" @click="toggleEditCheck(tag)"
                      :class="['px-4 py-2.5 rounded-xl text-[11px] font-black border transition-all shadow-sm', isTagChecked(tag) ? 'bg-blue-600 text-white border-blue-700 shadow-md scale-105' : 'bg-white text-gray-400 border-gray-200']">[[ tag ]]</button>
            </div>
            <p class="text-xs font-black text-gray-400 mb-4 tracking-widest uppercase px-1">âš¡ å¿«é€Ÿç´€éŒ„å™¨ (é»æ“Šç´¯åŠ æ¬¡æ•¸)</p>
            <div class="grid grid-cols-3 gap-3 mb-6">
              <button @click="addNoteAction('call')" class="py-4 bg-blue-50 text-blue-600 rounded-2xl font-black border border-blue-100 active:bg-blue-100 transition shadow-sm text-xs">ğŸ“ æ’¥æ‰“ç´€éŒ„</button>
              <button @click="addNoteAction('line')" class="py-4 bg-emerald-50 text-emerald-600 rounded-2xl font-black border border-emerald-100 active:bg-emerald-100 transition shadow-sm text-xs">ğŸ’¬ å‚³Line</button>
              <button @click="addNoteManual('ç„¡äººæ¥è½')" class="py-4 bg-gray-100 text-gray-600 rounded-2xl font-black border border-gray-200 active:bg-gray-200 shadow-sm text-xs">ç„¡äººæ¥è½</button>
            </div>
            <textarea v-model="editData.note" class="w-full h-48 p-5 bg-gray-50 border border-gray-100 rounded-[2rem] text-sm text-gray-600 mb-8 focus:ring-4 focus:ring-blue-500/10 outline-none resize-none font-mono shadow-inner leading-relaxed font-bold"></textarea>
            <button @click="submitUpdate" :disabled="isUpdating" class="w-full bg-gray-900 text-white font-black py-6 rounded-[1.75rem] shadow-2xl active:scale-95 transition flex justify-center items-center gap-3 text-lg">
              <span v-if="isUpdating" class="w-5 h-5 border-3 border-white/30 border-t-white rounded-full animate-spin"></span>
              [[ isUpdating ? 'åŒæ­¥é›²ç«¯ä¸­...' : 'ğŸ’¾ å„²å­˜æ‰€æœ‰æ›´æ–°' ]]
            </button>
          </div>
        </div>
      </transition>

      <transition name="modal-fade">
        <div v-if="showDispatchModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-gray-900/60 backdrop-blur-md" @click.self="closeDispatchModal">
          <div class="bg-white w-full max-w-md rounded-t-[3rem] sm:rounded-[2.5rem] p-8 shadow-2xl overflow-y-auto max-h-[92vh]">
            
            <div class="flex justify-between items-center mb-6 pb-2 border-b border-gray-100">
              <h3 class="text-xl font-black text-gray-800 tracking-tight">ğŸš€ æ´¾å–®ï¼š[[ currentItem?.area ]][[ currentItem?.storeName ]]</h3>
              <button @click="closeDispatchModal" class="text-gray-300 hover:text-gray-700 text-4xl font-light">âœ•</button>
            </div>

            <p class="text-xs font-black text-gray-400 mb-3 tracking-widest uppercase px-1">STEP 1: è¤‡è£½åç¨± & åŠ å¥½å‹å‰µç¾¤</p>
            <button @click="copyAndJumpForGroup" class="w-full bg-blue-600 text-white font-black py-4 rounded-[1.5rem] shadow-lg shadow-blue-100 mb-6 active:scale-95 transition flex flex-col items-center">
              ğŸ“‹ è¤‡è£½åç¨±ä¸¦è·³è½‰ LINE
              <span class="text-[11px] opacity-80 mt-1 tracking-wider">è‡ªå‹•è¤‡è£½ï¼šã€Œ[[ currentItem?.area ]][[ currentItem?.storeName ]] + ezPrettyè¨è«–ã€</span>
            </button>

            <p class="text-xs font-black text-gray-400 mb-3 tracking-widest uppercase px-1">STEP 2: ç¾¤çµ„ç¶å®š</p>
            <div class="flex gap-2 mb-3">
              <select v-model="dispatchData.groupId" class="flex-grow p-3.5 bg-gray-50 border border-gray-200 rounded-xl text-sm font-bold text-gray-700 outline-none">
                <option value="">ğŸ¤– è«‹é¸æ“‡åµæ¸¬åˆ°çš„ç¾¤çµ„ ID...</option>
                <option v-for="g in availableGroupIds" :key="g.id" :value="g.id">[[ g.name ]] (å‰›åµæ¸¬åˆ°)</option>
              </select>
              <button @click="fetchGroupIds" class="bg-gray-100 border border-gray-200 px-4 rounded-xl font-black text-gray-600 active:bg-gray-200 transition shadow-sm">ğŸ”„</button>
            </div>
            <input type="text" v-model="dispatchData.groupLink" placeholder="ğŸ”— è²¼ä¸Š LINE ç¾¤çµ„é‚€è«‹é€£çµ" class="w-full p-3.5 bg-gray-50 border border-gray-200 rounded-xl text-sm font-bold text-gray-700 outline-none mb-6 shadow-inner">

            <p class="text-xs font-black text-gray-400 mb-3 tracking-widest uppercase px-1">STEP 3: æŒ‡æ´¾èˆ‡äº¤æ¥</p>
            <div class="flex gap-2 mb-4">
              <button v-for="staff in ['Kelvin', 'David', 'WT']" :key="staff" @click="dispatchData.owner = staff"
                      :class="['flex-1 py-3.5 rounded-xl font-black text-sm transition shadow-sm', dispatchData.owner === staff ? 'bg-purple-600 text-white shadow-md scale-105' : 'bg-gray-100 text-gray-500 hover:bg-gray-200']">
                [[ staff ]]
              </button>
            </div>
            <textarea v-model="dispatchData.initialDemand" placeholder="ğŸ“ åˆæ­¥äº†è§£çš„éœ€æ±‚ / ä¸»ç®¡äº¤æ¥å‚™è¨»..." class="w-full h-28 p-4 bg-gray-50 border border-gray-100 rounded-2xl text-sm text-gray-600 mb-6 focus:ring-2 focus:ring-purple-500/20 outline-none resize-none font-bold leading-relaxed shadow-inner"></textarea>
            
            <button @click="submitDispatch" :disabled="isDispatching" class="w-full bg-gray-900 text-white font-black py-5 rounded-[1.5rem] shadow-2xl active:scale-95 transition flex justify-center items-center gap-3 text-lg">
              <span v-if="isDispatching" class="w-5 h-5 border-3 border-white/30 border-t-white rounded-full animate-spin"></span>
              [[ isDispatching ? 'æ´¾å–®åŒæ­¥å¯«å…¥ä¸­...' : 'ğŸš€ ç¢ºèªæ´¾å–®ä¸¦å¯«å…¥' ]]
            </button>
          </div>
        </div>
      </transition>

      <div v-if="toastMessage" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-gray-800/95 backdrop-blur text-white px-8 py-4 rounded-full text-sm font-black shadow-2xl z-50 transition-all tracking-wider border border-white/10 animate-bounce">[[ toastMessage ]]</div>
    </div>

    <script>
      const GAS_URL = "https://script.google.com/macros/s/AKfycbzIKHpWcWj0bOhaQsx-OynY5FVVorMJvTNON5PBOywj1q-Nd5EylLCSl-zTlFW9Rb5U/exec";
      const { createApp } = Vue;
      createApp({
        delimiters: ['[[', ']]'],
        data() { 
          return { 
            salesData: [], searchQuery: '', currentTab: 'new', loading: true, toastMessage: '',
            sortDesc: true, showFilter: false, showChart: false,
            filterSource: [], filterArea: [], filterIndustry: [], filterStartDate: '', filterEndDate: '',
            showLineModal: false, currentLineItem: null, lineScriptTab: 'first',
            showUpdateModal: false, isUpdating: false, currentItem: null,
            editData: { newTracking: '', addLine: '', readStatus: '', callStatus: '', isConnected: '', emailSent: '', note: '' },
            showDispatchModal: false, isDispatching: false,
            dispatchData: { groupId: '', groupLink: '', owner: 'Kelvin', initialDemand: '' },
            availableGroupIds: [],
            tabs: [
              { id: 'all', icon: 'ğŸ“‚', label: 'å…¨éƒ¨', activeClass: 'bg-gray-700 text-white', ringClass: 'ring-gray-300' },
              { id: 'new', icon: 'ğŸ†•', label: 'æ–°å–®', activeClass: 'bg-[#00C851] text-white', ringClass: 'ring-green-300' },
              { id: 'unread', icon: 'ğŸ“²', label: 'æœªè®€', activeClass: 'bg-[#ffbb33] text-[#5c3a00]', ringClass: 'ring-yellow-300' },
              { id: 'read', icon: 'ğŸ‘€', label: 'å·²è®€', activeClass: 'bg-[#ff4444] text-white', ringClass: 'ring-red-300' },
              { id: 'noline', icon: 'ğŸ“µ', label: 'æ²’Line', activeClass: 'bg-[#33b5e5] text-white', ringClass: 'ring-cyan-300' },
              { id: 'dispatched', icon: 'ğŸš€', label: 'å·²æ´¾å–®', activeClass: 'bg-[#9c27b0] text-white', ringClass: 'ring-purple-300' },
              { id: 'self', icon: 'ğŸ’ª', label: 'è‡ªé–‹ä»¶', activeClass: 'bg-[#00897b] text-white', ringClass: 'ring-teal-300' },
              { id: 'invalid', icon: 'ğŸ’€', label: 'ç„¡æ•ˆ', activeClass: 'bg-[#6c757d] text-white', ringClass: 'ring-gray-300' }
            ]
          } 
        },
        computed: {
          uniqueSources() { return [...new Set(this.salesData.map(i => i.source).filter(Boolean))].sort(); },
          uniqueAreas() { return [...new Set(this.salesData.map(i => i.area).filter(Boolean))].sort(); },
          uniqueIndustries() { return [...new Set(this.salesData.map(i => i.industry).filter(Boolean))].sort(); },
          activeFilterCount() { return this.filterSource.length + this.filterArea.length + this.filterIndustry.length + (this.filterStartDate || this.filterEndDate ? 1 : 0); },
          filteredData() {
            return this.salesData.filter(item => {
              const s = this.searchQuery.toLowerCase();
              const matchSearch = !s || (item.storeName + item.area + item.bossName + item.id).toLowerCase().includes(s);
              const matchSrc = this.filterSource.length === 0 || this.filterSource.includes(item.source);
              const matchArea = this.filterArea.length === 0 || this.filterArea.includes(item.area);
              const matchInd = this.filterIndustry.length === 0 || this.filterIndustry.includes(item.industry);
              let matchDate = true;
              if (this.filterStartDate || this.filterEndDate) {
                const itemDate = this.parseSafeDate(item.formDate);
                if (!itemDate) matchDate = false; else {
                  if (this.filterStartDate && itemDate < new Date(this.filterStartDate)) matchDate = false;
                  if (this.filterEndDate && itemDate > new Date(this.filterEndDate + 'T23:59:59')) matchDate = false;
                }
              }
              return matchSearch && matchSrc && matchArea && matchInd && matchDate;
            });
          },
          finalSortedData() {
            let res = this.currentTab === 'all' ? this.filteredData : this.filteredData.filter(i => this.getCategory(i) === this.currentTab);
            return res.sort((a,b) => {
              const valA = parseInt(a.id) || 0; const valB = parseInt(b.id) || 0;
              return this.sortDesc ? (valB - valA) : (valA - valB);
            });
          },
          conversionRate() {
            const total = this.filteredData.filter(i => i.source !== 'æ¥­å‹™è‡ªé–‹ä»¶').length;
            if (!total) return 0;
            const disp = this.filteredData.filter(i => i.source !== 'æ¥­å‹™è‡ªé–‹ä»¶' && this.getCategory(i) === 'dispatched').length;
            return Math.round((disp/total)*100);
          },
          junkRate() {
            const total = this.filteredData.filter(i => i.source !== 'æ¥­å‹™è‡ªé–‹ä»¶').length;
            if (!total) return 0;
            const inv = this.filteredData.filter(i => i.source !== 'æ¥­å‹™è‡ªé–‹ä»¶' && this.getCategory(i) === 'invalid').length;
            return Math.round((inv/total)*100);
          },
          salesLeaderboard() {
            const counts = {};
            this.filteredData.filter(i => ['dispatched','self'].includes(this.getCategory(i))).forEach(i => { const o = i.owner || 'æœªæŒ‡æ´¾'; counts[o] = (counts[o] || 0) + 1; });
            return Object.fromEntries(Object.entries(counts).sort(([,a],[,b]) => b-a));
          },
          maxSalesCount() { return Math.max(...Object.values(this.salesLeaderboard), 1); },
          lineScriptContent() {
            if (!this.currentLineItem) return '';
            const { storeName: n, adDemand: r } = this.currentLineItem;
            if (this.lineScriptTab === 'first') return `å“ˆå›‰ è€é—† æ‚¨å¥½ï¼æ‚¨é€™é‚Šæ˜¯ ${n} åº—å®¶å—ï½\næˆ‘æ˜¯ ezPretty çš„æ¥­å‹™ç¶“ç† æšåº­ ğŸ˜Š\nå‰›æ‰æœ‰æ”¶åˆ°æ‚¨çš„è«®è©¢ï¼Œæ‚¨æƒ³äº†è§£ã€${r||'ç›¸é—œ'}ã€‘çš„åŠŸèƒ½å—ï¼Ÿ\n\næ‚¨çœ‹åˆ°è¨Šæ¯å¾Œï¼Œæ–¹ä¾¿è·Ÿæ‚¨é€šè©±1åˆ†é˜å—ï¼Ÿ`;
            if (this.lineScriptTab === 'follow') return `å“ˆå›‰è€é—†ï¼Œæ“”å¿ƒæ‚¨è¿‘æ—¥å¿™ç¢Œæ¼æ‰è¨Šæ¯ï¼Œæ‰€ä»¥å†è·Ÿæ‚¨æ‰“å€‹æ‹›å‘¼ ğŸ˜Š\n\nè¿‘æœŸæœ‰æ”¶åˆ°æ‚¨çš„è«®è©¢ï¼Œæ‚¨æƒ³äº†è§£æˆ‘å€‘é ç´„posç³»çµ±çš„ã€${r||'ç›¸é—œ'}ã€‘çš„åŠŸèƒ½å—ï¼Ÿ`;
            return `å¥½çš„ï¼Œæˆ‘å¾…æœƒæ‹‰å€‹ç¾¤çµ„ï¼Œç”±å°ˆå“¡ç‚ºæ‚¨æœå‹™ï¼`;
          }
        },
        mounted() { this.loadData(); },
        methods: {
          loadData() { 
            this.loading = true; 
            fetch(GAS_URL + "?action=getWarRoomData")
              .then(res => res.json()).then(d => { this.salesData = d; this.loading = false; })
              .catch(e => { alert("æŠ“å–å¤±æ•—: " + e.message); this.loading = false; });
          },
          parseSafeDate(s) { if(!s) return null; let clean = String(s).split(" ")[0].replace(/[^\d\/\-\.]/g, ''); let d = new Date(clean); return isNaN(d.getTime()) ? null : d; },
          
          openUpdateModal(item) {
            this.currentItem = item;
            this.editData = JSON.parse(JSON.stringify(item));
            // æŠ“èˆŠç´€éŒ„ï¼Œå¦‚æœæ²’æœ‰å°±å¥—ç”¨ç¯„æœ¬
            let oldRecord = this.editData.callCount || this.editData.note || '';
            if (oldRecord.trim() === '' || oldRecord === 'ç„¡' || oldRecord === 'å°šç„¡ç´€éŒ„') {
              this.editData.note = "å‚³lineç´€éŒ„ï¼ˆå…±0æ¬¡ï¼‰ï¼š\næ’¥æ‰“ç´€éŒ„ï¼ˆå…±0æ¬¡ï¼‰ï¼š\næ‰‹å‹•ç´€éŒ„ï¼š";
            } else {
              this.editData.note = oldRecord;
            }
            this.showUpdateModal = true;
          },
          closeUpdateModal() { this.showUpdateModal = false; },
          
          isTagChecked(tag) {
            const m = { 'åŠ Line':'addLine', 'å·²è®€':'readStatus', 'æ’¥é›»è©±':'callStatus', 'æ˜¯å¦æ’¥é€š':'isConnected', 'Email':'emailSent' };
            return String(this.editData[m[tag]]).includes('âœ…');
          },
          toggleEditCheck(tag) {
            const m = { 'åŠ Line':'addLine', 'å·²è®€':'readStatus', 'æ’¥é›»è©±':'callStatus', 'æ˜¯å¦æ’¥é€š':'isConnected', 'Email':'emailSent' };
            const key = m[tag];
            this.editData[key] = String(this.editData[key]).includes('âœ…') ? '' : 'âœ…';
          },
          addNoteAction(type) {
            const now = new Date();
            const timeStr = `[ ${now.getMonth()+1}/${now.getDate()} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')} ]`;
            const label = type === 'call' ? 'æ’¥æ‰“ç´€éŒ„' : 'å‚³lineç´€éŒ„';
            const regex = new RegExp(`${label}ï¼ˆå…±(\\d+)æ¬¡ï¼‰ï¼š`);
            const match = this.editData.note.match(regex);
            if (match) {
              const count = parseInt(match[1]) + 1;
              this.editData.note = this.editData.note.replace(regex, `${label}ï¼ˆå…±${count}æ¬¡ï¼‰ï¼š\n${timeStr} ${type==='call'?'å·²æ’¥æ‰“':'å·²å‚³è¨Š'}`);
            }
          },
          addNoteManual(text) { this.editData.note = this.editData.note.replace('æ‰‹å‹•ç´€éŒ„ï¼š', `æ‰‹å‹•ç´€éŒ„ï¼š\n[${text}] `); },
          
          submitUpdate() {
            this.isUpdating = true;
            const params = new URLSearchParams({
              action: 'updateProgress', key: this.currentItem.id, note: this.editData.note,
              isL: String(String(this.editData.addLine).includes('âœ…')), 
              isM: String(String(this.editData.readStatus).includes('âœ…')),
              isN: String(String(this.editData.callStatus).includes('âœ…')), 
              isO: String(String(this.editData.isConnected).includes('âœ…')),
              isQ: String(String(this.editData.emailSent).includes('âœ…')),
              progress: `${new Date().toLocaleDateString()} | ${this.editData.newTracking}`
            });
            fetch(GAS_URL + "?" + params.toString(), { method: "POST" })
              .then(res => res.text()).then(r => { if(r==="Success") { this.showToast("âœ… é›²ç«¯åŒæ­¥æˆåŠŸï¼"); this.loadData(); this.closeUpdateModal(); } })
              .finally(() => this.isUpdating = false);
          },

          openLineModal(item) { this.currentLineItem = item; this.showLineModal = true; },
          closeLineModal() { this.showLineModal = false; },
          jumpAndCopyName() {
            const name = `ğŸ‘¤${this.currentLineItem.storeName}-`;
            this.copyText(name);
            this.showToast(`å·²è¤‡è£½ï¼šã€Œ${name}ã€è·³è½‰ä¸­...`);
            setTimeout(() => window.open('https://line.me/ti/p/~' + (this.currentLineItem.lineId || this.currentLineItem.phone)), 800);
          },
          copyScript() { this.copyText(this.lineScriptContent); this.showToast('âœ… é–‹ç™¼è©±è¡“å·²è¤‡è£½ï¼'); },

          getCategory(i) {
            const L=String(i.addLine).includes('âœ…'), M=String(i.readStatus).includes('âœ…'), N=String(i.callStatus).includes('âœ…'), O=String(i.isConnected).includes('âœ…');
            if (i.owner) return i.source === 'æ¥­å‹™è‡ªé–‹ä»¶' ? 'self' : 'dispatched';
            if (String(i.status).includes('æ‹’çµ•') || String(i.status).includes('ç„¡æ•ˆ')) return 'invalid';
            if (!L && !M && !N && !O) return 'new';
            if (L && !M) return 'unread';
            if (L && M) return 'read';
            return 'noline';
          },
          getActionAlert(i) {
            const c = this.getCategory(i);
            if(c==='new') return {text:'ğŸ†• æ–°å–®è«‹è¯çµ¡ï¼', color:'text-green-600 bg-green-50 border-green-200'};
            if(c==='unread') return {text:'ğŸ“ è«‹ä¸€å®šè¦æ‰“é›»è©±ï¼', color:'text-red-600 bg-red-50 border-red-200'};
            if(c==='read') return {text:'ğŸ”¥ å·²è®€å·²é€šï¼è©²æ´¾å–®äº†ï¼', color:'text-red-700 bg-red-50 border-red-200'};
            if(c==='self') return {text:'ğŸ’ª æ¥­å‹™è‡ªé–‹ï¼š' + i.owner, color:'text-teal-600 bg-teal-50 border-teal-200'};
            if(c==='dispatched') return {text:'ğŸš€ å·²æ´¾å–®çµ¦ï¼š' + i.owner, color:'text-purple-600 bg-purple-50 border-purple-200'};
            return {text:'ğŸ“ è¿½è¹¤ï¼š' + (i.status || 'è™•ç†ä¸­'), color:'text-gray-500 bg-gray-50 border-gray-200'};
          },
          pillClass(t, i) {
            const m = {'åŠ Line':'addLine','å·²è®€':'readStatus','æ’¥é›»è©±':'callStatus','æ˜¯å¦æ’¥é€š':'isConnected','Email':'emailSent'};
            return String(i[m[t]]).includes('âœ…') ? 'bg-blue-600 text-white border-blue-700' : 'bg-gray-100 text-gray-400 border-transparent';
          },
          toggleSort() { this.sortDesc = !this.sortDesc; },
          toggleFilterPanel() { this.showFilter = !this.showFilter; this.showChart = false; },
          toggleChartPanel() { this.showChart = !this.showChart; this.showFilter = false; },
          toggleFilterItem(type, val) { const a = this['filter'+type]; const i = a.indexOf(val); if(i>-1) a.splice(i,1); else a.push(val); },
          clearFilters() { this.filterSource = []; this.filterArea = []; this.filterIndustry = []; this.filterStartDate = ''; this.filterEndDate = ''; },
          setQuickDate(t) {
            const now = new Date(); const fmt = d => d.toISOString().split('T')[0];
            if(t==='thisMonth') { this.filterStartDate = fmt(new Date(now.getFullYear(), now.getMonth(), 1)); this.filterEndDate = fmt(new Date(now.getFullYear(), now.getMonth()+1, 0)); }
            else if(t==='lastMonth') { this.filterStartDate = fmt(new Date(now.getFullYear(), now.getMonth()-1, 1)); this.filterEndDate = fmt(new Date(now.getFullYear(), now.getMonth(), 0)); }
            else if(t==='thisWeek') { const d = now.getDay()||7; this.filterStartDate = fmt(new Date(now.setDate(now.getDate()-d+1))); this.filterEndDate = fmt(new Date(now.setDate(now.getDate()+6))); }
          },
          validateDateRange() { if (this.filterStartDate && this.filterEndDate && this.filterStartDate > this.filterEndDate) [this.filterStartDate, this.filterEndDate] = [this.filterEndDate, this.filterStartDate]; },
          getTabCount(id) { return id==='all'?this.filteredData.length:this.filteredData.filter(i=>this.getCategory(i)===id).length; },
          getCategoryColor(c) { return {new:'#00C851',unread:'#ffbb33',read:'#ff4444',noline:'#33b5e5',dispatched:'#9c27b0',self:'#00897b',invalid:'#6c757d'}[c]||'#ccc'; },
          copyText(text) { if (!text) return; const el = document.createElement('textarea'); el.value = text; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); },
          showToast(m) { this.toastMessage = m; setTimeout(() => this.toastMessage = '', 2500); },
          formatDate(d) { if(!d) return ''; const t = new Date(d); return isNaN(t) ? d : `${t.getMonth()+1}/${t.getDate()}`; },
          
          // ğŸš€ æ´¾å–®äº¤æ¥é¢æ¿é‚è¼¯
          openDispatch(item) {
            this.currentItem = item;
            this.dispatchData = { 
              groupId: item.groupId || '', 
              groupLink: item.groupLink || '', 
              owner: item.owner || 'Kelvin', 
              initialDemand: item.initialDemand || item.adDemand || '' 
            };
            this.showDispatchModal = true;
            this.fetchGroupIds();
          },
          closeDispatchModal() { this.showDispatchModal = false; },
          
          copyAndJumpForGroup() {
            const groupName = `${this.currentItem.area || ''}${this.currentItem.storeName || ''} + ezPrettyè¨è«–`;
            this.copyText(groupName);
            this.showToast(`å·²è¤‡è£½ï¼šã€Œ${groupName}ã€è·³è½‰ä¸­...`);
            const target = this.currentItem.lineId || this.currentItem.phone || '';
            // ğŸŒŸ æ”¹æˆè·³è½‰åˆ° LINE çš„ã€ŒåŠ å…¥å¥½å‹/å»ºç«‹ç¾¤çµ„ã€é¢æ¿
            setTimeout(() => window.open('https://line.me/R/nv/addFriends'), 800);
          },

          fetchGroupIds() {
            fetch(GAS_URL + "?action=getGroupIds")
              .then(res => res.json())
              .then(data => { this.availableGroupIds = data; this.showToast("ğŸ”„ ç¾¤çµ„ ID å·²æ›´æ–°"); })
              .catch(err => console.log(err));
          },

          submitDispatch() {
            this.isDispatching = true;
            const params = new URLSearchParams({
              action: 'submitDispatch',
              key: this.currentItem.id,
              groupId: this.dispatchData.groupId,
              groupLink: this.dispatchData.groupLink,
              owner: this.dispatchData.owner,
              initialDemand: this.dispatchData.initialDemand
            });
            fetch(GAS_URL + "?" + params.toString(), { method: "POST" })
              .then(res => res.text())
              .then(r => { 
                if(r === "Success") { 
                  this.showToast("ğŸš€ æ´¾å–®åŒæ­¥æˆåŠŸï¼"); 
                  this.loadData(); 
                  this.closeDispatchModal(); 
                } 
              })
              .finally(() => this.isDispatching = false);
          }
        }
      }).mount('#app');
    </script>
  </body>
</html>

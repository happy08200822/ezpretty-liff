<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ezPretty æˆ°æƒ…å®¤ (æœ€çµ‚å®Œç¾å„ªåŒ–ç‰ˆ)</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    /* --- åŸºç¤è¨­å®š --- */
    body { font-family: -apple-system, "Noto Sans TC", sans-serif; background: #f4f6f9; padding: 0; margin: 0; padding-bottom: 90px; -webkit-tap-highlight-color: transparent; }
    
    /* =========================================
       ğŸŒŸ é ‚éƒ¨å›ºå®šå€ (Header Sticky)
       ========================================= */
    .header-sticky { position: sticky; top: 0; background: #f4f6f9; z-index: 100; box-shadow: 0 4px 6px -6px rgba(0,0,0,0.1); }
    
    .top-row-container { display: flex; align-items: center; gap: 8px; padding: 10px 10px 5px 10px; }
    .main-search-input { flex: 1; padding: 10px 12px; border-radius: 10px; border: 2px solid #e0e0e0; background: #fff; font-size: 14px; outline: none; transition: 0.3s; height: 42px; box-sizing: border-box; }
    .main-search-input:focus { border-color: #007bff; }
    
    .tool-group { display: flex; gap: 5px; }
    .tool-btn-small { width: 42px; height: 42px; border-radius: 10px; background: white; border: 1px solid #ddd; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 16px; color: #555; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .tool-btn-small:active { background: #f0f0f0; transform: scale(0.95); }
    
    /* ğŸŒŸ RWD è‡ªé©æ‡‰ Tabs */
    .tabs-sticky-container { background: #f4f6f9; padding-bottom: 5px; border-bottom: 1px solid rgba(0,0,0,0.05); }
    .status-tabs { display: flex; overflow-x: auto; gap: 8px; padding: 0 10px; scrollbar-width: none; -webkit-overflow-scrolling: touch; }
    .status-tabs::-webkit-scrollbar { display: none; }
    
    .tab-btn { flex: 0 0 auto; min-width: 68px; padding: 6px 4px; border-radius: 10px; font-size: 11px; font-weight: bold; border: none; cursor: pointer; background: #fff; color: #888; transition: 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .tab-btn span { font-size: 14px; margin-bottom: 1px; }
    .tab-btn .count { background: rgba(0,0,0,0.05); padding: 1px 6px; border-radius: 10px; font-size: 9px; margin-top: 1px; }
    .tab-btn.active { transform: scale(0.96); box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); color: white; }
    
    /* ğŸŒŸ é›»è…¦ç‰ˆå„ªåŒ–ï¼šæŒ‰éˆ•è‡ªå‹•å¡«æ»¿ */
    @media (min-width: 768px) {
        .status-tabs { flex-wrap: wrap; overflow: visible; }
        .tab-btn { flex: 1 0 auto; min-width: 80px; } /* è‡ªå‹•è®Šå¯¬ */
        .chip-container { flex-wrap: wrap; overflow: visible; } /* Chip ä¹Ÿè‡ªå‹•æ›è¡Œ */
    }

    /* Tabs é¡è‰²å®šç¾© */
    .tab-all.active { background: #555; }
    .tab-new.active { background: #00C851; }
    .tab-unread.active { background: #ffbb33; color: #5c3a00; }
    .tab-read.active { background: #ff4444; }
    .tab-noline.active { background: #33b5e5; }
    .tab-dispatched.active { background: #9c27b0; } 
    .tab-self.active { background: #00897b; }       
    .tab-invalid.active { background: #6c757d; }

    /* ç¯©é¸é–‹é—œåˆ— */
    .filter-trigger-row { padding: 5px 10px; display: flex; flex-direction: column; align-items: flex-start; gap: 5px; }
    .filter-toggle-btn { background: none; border: none; color: #007bff; font-size: 13px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; padding: 5px 0; }
    
    /* ğŸŒŸ å„ªåŒ–çš„ç¯©é¸æç¤ºæ–‡å­— */
    .filter-hint-row { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 5px; padding: 0 10px; }
    .filter-tag { font-size: 10px; background: #e7f5ff; color: #007bff; padding: 2px 8px; border-radius: 10px; border: 1px solid #b3d7ff; white-space: nowrap; }

    /* æ¥­å‹™ç¯©é¸åˆ— */
    #salesFilterBar { display: none; white-space: nowrap; overflow-x: auto; padding: 0 10px 8px 10px; -webkit-overflow-scrolling: touch; }
    #salesFilterBar::-webkit-scrollbar { display: none; }
    .sales-pill { display: inline-flex; align-items: center; gap: 5px; padding: 4px 10px; margin-right: 5px; border-radius: 15px; font-size: 11px; color: #555; background: #e0e0e0; border: 1px solid #ccc; cursor: pointer; transition: 0.2s; }
    .sales-pill.active { background: #333; color: white; border-color: #000; }
    .sales-filter-dispatched .sales-pill.active { background: #9c27b0; border-color: #7b1fa2; }
    .sales-filter-self .sales-pill.active { background: #00897b; border-color: #00695c; }
    .sales-count { background: rgba(0,0,0,0.1); color: inherit; font-size: 10px; padding: 1px 6px; border-radius: 10px; font-weight: bold; }
    .sales-pill.active .sales-count { background: rgba(255,255,255,0.25); color: white; }

    /* =========================================
       ğŸŒŸ å±•é–‹å€ (ç¯©é¸é¢æ¿ & åœ–è¡¨)
       ========================================= */
    .expand-area { padding: 0 10px; }
    .hidden-panel { display: none; background: white; border-radius: 16px; padding: 15px; margin-bottom: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); animation: slideDown 0.2s ease-out; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    .date-trigger-btn { width: 100%; padding: 12px; background: #f0f7ff; border: 1px solid #007bff; border-radius: 12px; text-align: left; font-size: 14px; font-weight: bold; color: #007bff; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; cursor: pointer; box-sizing: border-box; }
    .date-trigger-btn span { color: #333; font-weight: normal; font-size: 13px; }

    .filter-section-title { font-size: 12px; color: #888; font-weight: bold; margin-bottom: 8px; margin-top: 10px; }
    
    .chip-container { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 5px; scrollbar-width: none; -webkit-overflow-scrolling: touch; }
    .chip { flex: 0 0 auto; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: bold; color: #555; background: #f1f3f5; border: 1px solid #dee2e6; cursor: pointer; transition: 0.2s; }
    .chip.active { background: #e7f5ff; color: #007bff; border-color: #007bff; box-shadow: 0 2px 4px rgba(0,123,255,0.2); }

    /* ğŸŒŸ å„ªåŒ–çš„æ¸…é™¤æŒ‰éˆ• */
    .btn-reset-full { width: 100%; padding: 12px; background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; border-radius: 12px; font-size: 13px; font-weight: bold; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 5px; transition: 0.2s; }
    .btn-reset-full:active { background: #ffcdd2; }

    /* =========================================
       ğŸŒŸ Bottom Sheet (æ—¥æœŸé¸æ“‡)
       ========================================= */
    .bottom-sheet-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: none; opacity: 0; transition: opacity 0.3s; }
    .bottom-sheet { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-radius: 20px 20px 0 0; z-index: 10000; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.9, 0.3, 1); padding: 20px; padding-bottom: 40px; box-shadow: 0 -5px 25px rgba(0,0,0,0.1); display: flex; flex-direction: column; max-height: 85vh; }
    .bottom-sheet.show { transform: translateY(0); }
    .sheet-header { font-size: 16px; font-weight: bold; text-align: center; margin-bottom: 15px; position: relative; }
    .sheet-close { position: absolute; right: 0; top: -5px; background: none; border: none; font-size: 20px; color: #999; padding: 5px; cursor: pointer; }
    
    /* ğŸŒŸ å„ªåŒ–çš„å¿«æ·æ—¥æœŸ Grid */
    .quick-date-grid-row1 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 8px; }
    .quick-date-grid-row2 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 20px; }
    
    .quick-btn { padding: 10px 2px; background: #f8f9fa; border: 1px solid #eee; border-radius: 10px; font-size: 12px; color: #555; font-weight: bold; text-align: center; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .quick-btn:active { background: #e9ecef; color: #007bff; border-color: #b3d7ff; }

    .date-range-inputs { display: flex; gap: 10px; align-items: center; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 12px; }
    .date-input-group { flex: 1; display: flex; flex-direction: column; gap: 5px; }
    .date-input-group label { font-size: 11px; color: #666; font-weight: bold; }
    .date-native-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 8px; font-size: 15px; box-sizing: border-box; background: #fff; -webkit-appearance: none; }
    .sheet-confirm-btn { width: 100%; padding: 14px; background: linear-gradient(135deg, #007bff, #0056b3); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; }

    /* åœ–è¡¨å€ */
    .chart-wrapper { position: relative; height: 320px; width: 100%; display: none; margin-top: 10px; }
    .chart-wrapper.active { display: block; }
    .time-toggles-container { display: flex; justify-content: flex-end; padding-right: 10px; margin-bottom: 5px; }
    .time-toggles { display: flex; background: #e9ecef; border-radius: 20px; padding: 3px; }
    .time-btn { padding: 4px 12px; border: none; background: transparent; font-size: 11px; border-radius: 15px; cursor: pointer; color: #666; font-weight: bold; transition: 0.2s; }
    .time-btn.active { background: white; color: #007bff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .chart-tabs { display: flex; gap: 8px; overflow-x: auto; margin-bottom: 10px; scrollbar-width: none; }
    .chart-tab-btn { padding: 6px 14px; border-radius: 20px; background: #f1f3f5; color: #555; font-size: 12px; font-weight: bold; border: none; white-space: nowrap; cursor: pointer; }
    .chart-tab-btn.active { background: #007bff; color: white; }

    /* åˆ—è¡¨å€ */
    .list-container { padding: 10px; }

    /* å¡ç‰‡è¨­è¨ˆ */
    .store-card { background: white; border-radius: 16px; padding: 16px; margin-bottom: 16px; border-top: 6px solid #ccc; position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    .card-new { border-top-color: #00C851; }
    .card-unread { border-top-color: #ffbb33; }
    .card-read { border-top-color: #ff4444; }
    .card-noline { border-top-color: #33b5e5; }
    .card-invalid { border-top-color: #6c757d; opacity: 0.7; }
    .card-dispatched { border-top-color: #9c27b0; } 
    .card-self { border-top-color: #00897b; } 

    .top-right-badge { position: absolute; top: 12px; right: 12px; text-align: right; font-size: 11px; color: #888; line-height: 1.4; }
    .badge-source { font-weight: bold; padding: 2px 6px; border-radius: 4px; margin-bottom: 3px; display: inline-block; color: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    .action-alert { background: #fff5f5; border: 1px dashed #ff6b6b; color: #c0392b; padding: 8px 12px; border-radius: 8px; font-size: 14px; font-weight: bold; margin: 8px 0; display: flex; align-items: center; gap: 6px; }
    .action-alert i { font-style: normal; font-size: 16px; }
    .dup-alert { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; font-size: 11px; padding: 8px; border-radius: 8px; margin-bottom: 8px; }
    .store-name { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 4px; padding-right: 80px; line-height: 1.4; display: flex; align-items: center; }
    .industry-text { font-size: 12px; background: #eee; color: #555; padding: 2px 6px; border-radius: 4px; margin-right: 5px; font-weight: normal; }
    .btn-copy-text { background: none; border: none; font-size: 14px; cursor: pointer; margin-left: 5px; opacity: 0.6; pointer-events: auto; }
    .key-badge { font-size: 11px; color: #666; background: #f0f0f0; padding: 2px 6px; border-radius: 4px; margin-left: 5px; vertical-align: middle; }
    .info-box { display: flex; flex-direction: column; gap: 4px; font-size: 13px; color: #555; background: #f8faff; padding: 10px; border-radius: 12px; border: 1px solid #eef2f7; margin-bottom: 8px; }
    .req-text { color: #d35400; font-weight: bold; border-top: 1px dashed #ddd; padding-top: 6px; margin-top: 4px; line-height: 1.4; }
    .status-checks { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 5px; }
    .check-pill { font-size: 10px; padding: 2px 6px; border-radius: 10px; background: #f0f0f0; color: #aaa; border: 1px solid #ddd; }
    .check-pill.on { background: #e3f2fd; color: #1565c0; border-color: #90caf9; font-weight: bold; }
    .action-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-top: 10px; }
    .btn-tool { display: flex; flex-direction: row; justify-content: center; align-items: center; padding: 8px 0; border-radius: 8px; border: 1px solid #ddd; font-size: 12px; font-weight: bold; text-decoration: none; color: #444; background: #fff; transition: 0.2s; gap: 4px; }
    .btn-line { background: #ebf9f0; border-color: #06C755; color: #06C755; }
    .btn-call { background: #e0f7fa; border-color: #00acc1; color: #00838f; }
    .btn-map { background: #e8f0fe; border-color: #4285F4; color: #4285F4; }
    .btn-dispatch { background: #f3e5f5; border-color: #ab47bc; color: #7b1fa2; }
    .btn-tool i { font-size: 14px; font-style: normal; }
    .update-badge { background: #e74c3c; color: white; border-radius: 10px; padding: 0px 5px; font-size: 10px; margin-left: 2px; height: 16px; line-height: 16px; display: inline-block; vertical-align: text-top; }

    .fab-switch { position: fixed; bottom: 25px; right: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 24px; border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); font-size: 14px; font-weight: bold; text-decoration: none; display: flex; align-items: center; gap: 8px; z-index: 1000; transition: transform 0.2s; }
    #toast { visibility: hidden; min-width: 200px; background-color: #333; color: #fff; text-align: center; border-radius: 20px; padding: 10px; position: fixed; z-index: 10001; left: 50%; bottom: 100px; transform: translateX(-50%); font-size: 13px; }
    #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
    
    .skeleton-card { background: #fff; border-radius: 16px; padding: 16px; margin-bottom: 16px; border-top: 6px solid #e0e0e0; }
    .skeleton-box { background: #f6f7f8; height: 20px; margin-bottom: 10px; border-radius: 4px; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
  </style>
</head>
<body>

  <div class="header-sticky">
    <div class="top-row-container">
        <input type="text" class="main-search-input" id="searchInput" placeholder="ğŸ” æœå°‹..." oninput="render()">
        <div class="tool-group">
            <div class="tool-btn-small" id="chartToggleBtn" onclick="togglePanel('chartPanel')"><span>ğŸ“Š</span></div>
            <div class="tool-btn-small" id="sortToggleBtn" onclick="toggleSort()"><span>â‡…</span></div>
            <div class="tool-btn-small" onclick="loadData()"><span>ğŸ”„</span></div>
        </div>
    </div>

    <div class="tabs-sticky-container">
        <div class="status-tabs" id="statusTabs">
            <button class="tab-btn tab-all" onclick="setTab('all')"><span>ğŸ“‚</span>å…¨éƒ¨<div class="count" id="cnt-all">0</div></button>
            <button class="tab-btn tab-new active" onclick="setTab('new')"><span>ğŸ†•</span>æ–°å–®<div class="count" id="cnt-new">0</div></button>
            <button class="tab-btn tab-unread" onclick="setTab('unread')"><span>ğŸ“²</span>æœªè®€<div class="count" id="cnt-unread">0</div></button>
            <button class="tab-btn tab-read" onclick="setTab('read')"><span>ğŸ‘€</span>å·²è®€<div class="count" id="cnt-read">0</div></button>
            <button class="tab-btn tab-noline" onclick="setTab('noline')"><span>ğŸ“µ</span>æ²’Line<div class="count" id="cnt-noline">0</div></button>
            <button class="tab-btn tab-dispatched" onclick="setTab('dispatched')"><span>ğŸš€</span>å·²æ´¾å–®<div class="count" id="cnt-dispatched">0</div></button>
            <button class="tab-btn tab-self" onclick="setTab('self')"><span>ğŸ’ª</span>è‡ªé–‹ä»¶<div class="count" id="cnt-self">0</div></button>
            <button class="tab-btn tab-invalid" onclick="setTab('invalid')"><span>ğŸ’€</span>ç„¡æ•ˆ<div class="count" id="cnt-invalid">0</div></button>
        </div>
        
        <div class="filter-trigger-row">
            <button class="filter-toggle-btn" id="filterToggleBtn" onclick="togglePanel('filterPanel')">ğŸŒªï¸ ç¯©é¸æ¢ä»¶</button>
        </div>
        <div class="filter-hint-row" id="filterHintRow"></div>
        <div id="salesFilterBar"></div>
    </div>
  </div>

  <div class="expand-area">
      <div id="filterPanel" class="hidden-panel">
          <div class="date-trigger-btn" onclick="openDateSheet()">
              <div>ğŸ“… æ—¥æœŸå€é–“</div>
              <span id="dateDisplay">å…¨éƒ¨æ—¥æœŸ</span>
          </div>

          <div class="filter-section-title">ğŸ“¢ ä¾†æº (å¯è¤‡é¸)</div>
          <div class="chip-container" id="sourceChips"></div>

          <div class="filter-section-title">ğŸ™ï¸ åœ°å€ (å¯è¤‡é¸)</div>
          <div class="chip-container" id="areaChips"></div>

          <div class="filter-section-title">ğŸ­ ç”¢æ¥­ (å¯è¤‡é¸)</div>
          <div class="chip-container" id="industryChips"></div>

          <div style="text-align:center; margin-top:15px;">
              <button class="btn-reset-full" onclick="resetAllFilters()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æ¢ä»¶</button>
          </div>
      </div>
      
      <div id="chartPanel" class="hidden-panel">
         <div class="chart-tabs">
           <button class="chart-tab-btn active" onclick="switchChart('status')">ğŸ·ï¸ ç‹€æ…‹</button>
           <button class="chart-tab-btn" onclick="switchChart('sales')">ğŸ† æ’è¡Œ</button>
           <button class="chart-tab-btn" onclick="switchChart('date')">ğŸ“… èµ°å‹¢</button>
           <button class="chart-tab-btn" onclick="switchChart('source')">ğŸ“¢ ä¾†æº</button>
         </div>
         <div class="chart-wrapper active" id="chart-status"><canvas id="canvas-status"></canvas></div>
         <div class="chart-wrapper" id="chart-sales"><canvas id="canvas-sales"></canvas></div>
         <div class="chart-wrapper" id="chart-date">
             <div class="time-toggles-container">
                 <div class="time-toggles">
                     <button class="time-btn" onclick="setDateGrain('month', this)">æœˆ</button>
                     <button class="time-btn" onclick="setDateGrain('week', this)">é€±</button>
                     <button class="time-btn active" onclick="setDateGrain('day', this)">æ—¥</button>
                 </div>
             </div>
             <canvas id="canvas-date"></canvas>
         </div>
         <div class="chart-wrapper" id="chart-source"><canvas id="canvas-source"></canvas></div>
         <div class="chart-wrapper" id="chart-area"><canvas id="canvas-area"></canvas></div>
      </div>
  </div>

  <div class="list-container">
      <div id="storeList"></div>
  </div>

  <a href="https://liff.line.me/YOUR_BACKEND_LIFF_ID" class="fab-switch">ğŸ¯ å‰å¾€å¾Œæ®µ <i>â†’</i></a>
  <div id="toast">å·²è¤‡è£½åº—å®¶è³‡æ–™ï¼</div>

  <div class="bottom-sheet-overlay" id="dateSheetOverlay" onclick="closeDateSheet()"></div>
  <div class="bottom-sheet" id="dateSheet">
      <div class="sheet-header">ğŸ“… é¸æ“‡æ—¥æœŸå€é–“ <button class="sheet-close" onclick="closeDateSheet()">âœ•</button></div>
      
      <div class="filter-section-title" style="margin-bottom:8px;">âš¡ å¿«é€Ÿé¸æ“‡</div>
      <div class="quick-date-grid-row1">
          <div class="quick-btn" onclick="setQuickDate('thisMonth')">æœ¬æœˆ</div>
          <div class="quick-btn" onclick="setQuickDate('lastMonth')">ä¸Šå€‹æœˆ</div>
          <div class="quick-btn" onclick="setQuickDate('thisWeek')">æœ¬é€±</div>
          <div class="quick-btn" onclick="setQuickDate('lastWeek')">ä¸Šé€±</div>
      </div>
      <div class="quick-date-grid-row2" id="recentMonthsContainer">
          </div>

      <div class="date-range-inputs">
          <div class="date-input-group">
              <label>é–‹å§‹æ—¥æœŸ</label>
              <input type="date" id="dateStart" class="date-native-input" onchange="validateDateRange()">
          </div>
          <div style="padding-top:20px; color:#aaa;">â</div>
          <div class="date-input-group">
              <label>çµæŸæ—¥æœŸ</label>
              <input type="date" id="dateEnd" class="date-native-input" onchange="validateDateRange()">
          </div>
      </div>
      <button class="sheet-confirm-btn" onclick="applyDateFilter()">ç¢ºèªç¯©é¸</button>
      <button style="width:100%; padding:12px; background:none; border:none; color:#666; margin-top:5px;" onclick="clearDateFilter()">æ¸…é™¤æ—¥æœŸæ¢ä»¶</button>
  </div>

<script>
  const FORM_LIFF_ID = "2009117067-6y3yHx9o"; 
  const GAS_URL = "https://script.google.com/macros/s/AKfycbzIKHpWcWj0bOhaQsx-OynY5FVVorMJvTNON5PBOywj1q-Nd5EylLCSl-zTlFW9Rb5U/exec";

  let allData = [];
  let currentTab = 'new';
  let currentSalesFilter = 'all'; 
  let currentDateGrain = 'day'; 
  let sortDesc = true; 
  let clickCounts = JSON.parse(localStorage.getItem('ezPretty_ClickCounts')) || {};
  const charts = { status: null, sales: null, date: null, source: null, area: null };

  let filterState = { dateStart: null, dateEnd: null, source: [], area: [], industry: [] };

  function showSkeleton() {
    document.getElementById('storeList').innerHTML = Array(3).fill(0).map(() => `<div class="skeleton-card"><div class="skeleton-box" style="width:60%"></div><div class="skeleton-box"></div></div>`).join('');
  }

  async function loadData() {
    showSkeleton();
    const fetchUrl = GAS_URL + "?action=getManagementList&t=" + new Date().getTime();
    try {
      const response = await fetch(fetchUrl);
      const rawData = await response.json();
      allData = rawData.map(processItem); 
      checkDuplicates(allData); 
      initFilterOptions(); 
      try { initAllCharts(); } catch(e) { console.error('Chart init error', e); }
      doSort(); 
      render(); 
      playScrollHint();
    } catch (e) { 
      console.error(e);
      document.getElementById('storeList').innerHTML = `<div style="text-align:center; padding:20px; color:red;">é€£ç·šå¤±æ•—<br><small>${e.message}</small></div>`; 
    }
  }

  function processItem(i) {
    const L = !!i.isL; const M = !!i.isM; const N = !!i.isN; const O = !!i.isO; const Q = !!i.isQ;
    const detailLabel = String(i.detailLabel || "");
    const status = String(i.status || "");
    const isInvalid = detailLabel.includes('ç„¡æ•ˆ') || status === 'ç„¡æ•ˆå–®';
    const sales = String(i.sales || "").trim();
    const hasSales = sales !== "";
    const source = String(i.source || "");
    const isSelfSource = source === "æ¥­å‹™è‡ªé–‹ä»¶";

    let category = 'new';
    let actionText = 'æœªå®šç¾©';

    if (hasSales) {
        if (isSelfSource) {
            category = 'self';
            actionText = `ğŸ’ª æ¥­å‹™è‡ªé–‹ï¼š${sales}`;
        } else {
            category = 'dispatched';
            actionText = `ğŸš€ å·²æ´¾å–®çµ¦ï¼š${sales}`;
        }
    } else if (isInvalid) {
        category = 'invalid';
        actionText = 'ğŸ’€ æ­¤å–®å·²æ¨™è¨˜ç„¡æ•ˆ';
    } else if (!L && !M && !N && !O && !Q) {
        category = 'new';
        actionText = 'ğŸ†• æ–°å–®è«‹è¯çµ¡ï¼';
    } else if (L && !M) {
        category = 'unread';
        if (!N) actionText = 'ğŸ“ è«‹ä¸€å®šè¦æ‰“é›»è©±ï¼(ä¸è¦å·æ‡¶ï¼)';
        else if (N && !O) actionText = 'ğŸ”„ æœªæ¥ï¼ç¹¼çºŒæ‰“ï¼ç¹¼çºŒå‚³è¨Šæ¯ï¼';
        else if (N && O && !Q) actionText = 'ğŸš¨ è£æ­»ä¸çœ‹ï¼ç¹¼çºŒæ‰“ï¼ç¹¼çºŒå‚³ï¼';
        else actionText = 'ğŸ“§ å·²å¯„ä¿¡ï¼ç¹¼çºŒè¿½æ®ºï¼(ç›´åˆ°å·²è®€)';
    } else if (L && M) {
        category = 'read';
        if (!N && !O) actionText = 'ğŸ“ å·²è®€æ²’å›ï¼è«‹ä¸€å®šè¦æ‰“é›»è©±ï¼';
        else if (N && !O) actionText = 'ğŸ”„ å·²è®€æœªæ¥ï¼ç¹¼çºŒæ‰“ï¼ç¹¼çºŒå‚³ï¼';
        else actionText = 'ğŸ”¥ å·²è®€å·²é€šï¼ç¹¼çºŒæ‰“ï¼(è©²æ´¾å–®äº†åˆ¥æ‹–ï¼)';
    } else {
        category = 'noline';
        if (N && !O) actionText = 'ğŸ”„ æœªé€šï¼ç¹¼çºŒæ‰“ï¼';
        else if (N && O) actionText = 'âš ï¸ æœ‰é€šæ²’åŠ Lineï¼(ç¢ºèªå¿™ç¢Œæˆ–æ‹’çµ•)';
        else actionText = 'â“ ç‹€æ…‹ç•°å¸¸';
    }
    i.category = category;
    i.actionText = actionText;
    return i;
  }

  function initFilterOptions() {
      // 1. ç”Ÿæˆæœ€è¿‘3å€‹æœˆæŒ‰éˆ• (é‚è¼¯ï¼šå¾æœ¬æœˆé–‹å§‹å€’æ¨)
      const recentContainer = document.getElementById('recentMonthsContainer');
      let html = '';
      const today = new Date();
      for(let i=0; i<3; i++) {
          const d = new Date(today.getFullYear(), today.getMonth()-i, 1);
          const y = d.getFullYear();
          const m = d.getMonth() + 1;
          html += `<div class="quick-btn" onclick="setQuickMonth('${y}', '${m}')">${y}å¹´${m}æœˆ</div>`;
      }
      recentContainer.innerHTML = html;

      // 2. Chips
      renderChips('sourceChips', 'source');
      renderChips('areaChips', 'area');
      renderChips('industryChips', 'industry');
  }

  function renderChips(containerId, field) {
      const container = document.getElementById(containerId);
      const set = new Set();
      allData.forEach(i => { if(i[field]) set.add(i[field]); });
      const sorted = [...set].sort();
      let html = '';
      sorted.forEach(val => {
          html += `<div class="chip" onclick="toggleChip('${field}', '${val}', this)">${val}</div>`;
      });
      container.innerHTML = html;
  }

  function toggleChip(field, value, el) {
      const idx = filterState[field].indexOf(value);
      if (idx > -1) {
          filterState[field].splice(idx, 1);
          el.classList.remove('active');
      } else {
          filterState[field].push(value);
          el.classList.add('active');
      }
      render();
  }

  function openDateSheet() {
      document.getElementById('dateSheetOverlay').style.display = 'block';
      setTimeout(() => document.getElementById('dateSheetOverlay').style.opacity = '1', 10);
      document.getElementById('dateSheet').classList.add('show');
  }
  function closeDateSheet() {
      document.getElementById('dateSheet').classList.remove('show');
      document.getElementById('dateSheetOverlay').style.opacity = '0';
      setTimeout(() => document.getElementById('dateSheetOverlay').style.display = 'none', 300);
  }
  
  function validateDateRange() {
      const s = document.getElementById('dateStart');
      const e = document.getElementById('dateEnd');
      if (s.value && e.value && s.value > e.value) {
          const temp = s.value;
          s.value = e.value;
          e.value = temp;
      }
  }

  // ğŸŒŸ æ—¥æœŸå¿«æ·é‚è¼¯ (åš´æ ¼ä¿®å¾©)
  function setQuickDate(type) {
      const today = new Date();
      // å°‡æ™‚é–“æ­¸é›¶ï¼Œé¿å…æ™‚å€å¹²æ“¾
      today.setHours(0,0,0,0);
      
      const fmt = d => {
          const y = d.getFullYear();
          const m = String(d.getMonth()+1).padStart(2,'0');
          const day = String(d.getDate()).padStart(2,'0');
          return `${y}-${m}-${day}`;
      };

      let start, end;

      if(type === 'thisMonth') {
          start = new Date(today.getFullYear(), today.getMonth(), 1);
          end = new Date(today.getFullYear(), today.getMonth() + 1, 0); // ä¸‹å€‹æœˆç¬¬0å¤© = æœ¬æœˆæœ€å¾Œä¸€å¤©
      } else if(type === 'lastMonth') {
          start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
          end = new Date(today.getFullYear(), today.getMonth(), 0);
      } else if(type === 'thisWeek') {
          // æœ¬é€± (é€±ä¸€ ~ é€±æ—¥)
          const day = today.getDay() || 7; // Sunday=0 -> 7
          start = new Date(today);
          start.setDate(today.getDate() - day + 1);
          end = new Date(start);
          end.setDate(start.getDate() + 6);
      } else if(type === 'lastWeek') {
          // ä¸Šé€±
          const day = today.getDay() || 7;
          const thisMon = new Date(today);
          thisMon.setDate(today.getDate() - day + 1);
          start = new Date(thisMon);
          start.setDate(thisMon.getDate() - 7);
          end = new Date(start);
          end.setDate(start.getDate() + 6);
      }

      document.getElementById('dateStart').value = fmt(start);
      document.getElementById('dateEnd').value = fmt(end);
  }

  function setQuickMonth(y, m) {
      y = parseInt(y); m = parseInt(m);
      const start = new Date(y, m-1, 1);
      const end = new Date(y, m, 0);
      const fmt = d => {
          const yy = d.getFullYear();
          const mm = String(d.getMonth()+1).padStart(2,'0');
          const dd = String(d.getDate()).padStart(2,'0');
          return `${yy}-${mm}-${dd}`;
      };
      document.getElementById('dateStart').value = fmt(start);
      document.getElementById('dateEnd').value = fmt(end);
  }

  function applyDateFilter() {
      const s = document.getElementById('dateStart').value;
      const e = document.getElementById('dateEnd').value;
      if (s) filterState.dateStart = new Date(s + 'T00:00:00');
      if (e) filterState.dateEnd = new Date(e + 'T23:59:59'); 
      
      let label = 'å…¨éƒ¨æ—¥æœŸ';
      if (s && e) label = `${s} ~ ${e}`;
      else if (s) label = `${s} èµ·`;
      else if (e) label = `${e} æ­¢`;
      
      document.getElementById('dateDisplay').innerText = label;
      closeDateSheet();
      render();
  }
  function clearDateFilter() {
      document.getElementById('dateStart').value = '';
      document.getElementById('dateEnd').value = '';
      filterState.dateStart = null;
      filterState.dateEnd = null;
      document.getElementById('dateDisplay').innerText = 'å…¨éƒ¨æ—¥æœŸ';
      closeDateSheet();
      render();
  }

  function render() {
    updateFilterHint();
    
    const salesBar = document.getElementById('salesFilterBar');
    if (currentTab === 'dispatched' || currentTab === 'self') {
        salesBar.style.display = 'block';
        salesBar.className = currentTab === 'dispatched' ? 'sales-filter-dispatched' : 'sales-filter-self';
        updateSalesFilterUI(allData); 
    } else {
        salesBar.style.display = 'none';
        currentSalesFilter = 'all'; 
    }

    const list = document.getElementById('storeList');
    const search = document.getElementById('searchInput').value.trim().toLowerCase();

    const commonFiltered = allData.filter(i => {
      const content = ((i.source||"")+(i.industry||"")+(i.area||"")+(i.name||"")+(i.boss||"")+(i.lineId||"")+(i.phone||"")+(i.email||"")+(i.req||"")+(i.key||"")+(i.sales||"")).toLowerCase();
      const matchSearch = (search === "") || content.includes(search);
      
      let matchDate = true;
      if (i.date) {
          const p = i.date.split(/[-/]/);
          if(p.length >= 3) {
              const itemDate = new Date(parseInt(p[0]), parseInt(p[1])-1, parseInt(p[2]));
              if (filterState.dateStart && itemDate < filterState.dateStart) matchDate = false;
              if (filterState.dateEnd && itemDate > filterState.dateEnd) matchDate = false;
          }
      } else if (filterState.dateStart || filterState.dateEnd) {
          matchDate = false;
      }

      const matchSource = filterState.source.length === 0 || filterState.source.includes(i.source);
      const matchArea = filterState.area.length === 0 || filterState.area.includes(i.area);
      const matchIndustry = filterState.industry.length === 0 || filterState.industry.includes(i.industry);
      
      return matchSearch && matchDate && matchSource && matchArea && matchIndustry;
    });

    calculateCountsAndCharts(commonFiltered);

    const finalFiltered = commonFiltered.filter(i => {
        const matchTab = (currentTab === 'all') ? true : (i.category === currentTab);
        const matchSales = (currentSalesFilter === 'all') ? true : (i.sales === currentSalesFilter);
        return matchTab && matchSales;
    });

    if (finalFiltered.length === 0) { list.innerHTML = `<div style="text-align:center; padding:50px; color:#999;">æ­¤åˆ†é¡ç„¡ç¬¦åˆåå–®</div>`; return; }

    list.innerHTML = finalFiltered.map(item => {
      const style = getSourceStyle(item.source);
      let dupAlert = '';
      if (item.isDup && item.dupInfo) {
          const reasonsHtml = item.dupInfo.map(info => `<div style="margin-top:2px;">ğŸš¨ é‡è¤‡ï¼š${info.reason} <span style="font-weight:normal;color:#666;">(${info.targets.join(', ')})</span></div>`).join('');
          dupAlert = `<div class="dup-alert">${reasonsHtml}</div>`;
      }
      const localCount = clickCounts[item.key] || 0;
      const badgeHtml = localCount > 0 ? `<span class="update-badge">${localCount}</span>` : '';
      let lineUrl = "#"; if (item.lineId) lineUrl = `https://line.me/ti/p/~${item.lineId}`; else if (item.phone) lineUrl = `https://line.me/ti/p/~${item.phone}`;
      const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.area + item.name)}`;

      return `
      <div class="store-card card-${item.category}">
        <div class="top-right-badge"><span class="badge-source" style="background:${style.bg}">${style.label}</span><br>${item.date}</div>
        <div class="store-name">
            <span class="key-badge">#${item.key || 'ç„¡'}</span>
            <span class="industry-text" style="margin-left:5px;">ğŸ­ ${item.industry || 'ä¸€èˆ¬'}</span>
            ${item.area}${item.name} 
            <button class="btn-copy-text" onclick="copyContent('${item.area}${item.name}', 'åº—å')">ğŸ“„</button>
        </div>
        <div class="action-alert"><i>ğŸ””</i> ${item.actionText}</div>
        ${dupAlert}
        <div class="info-box">
          <div><b>ğŸ‘¤ è² è²¬äºº:</b> ${item.boss || 'æœªå¡«'}</div>
          <div><b>ğŸ“ é›»è©±:</b> ${item.phone} <button class="btn-copy-text" onclick="copyContent('${item.phone}','é›»è©±')">ğŸ“„</button></div>
          <div><b>ğŸ†” Line:</b> ${item.lineId || '--'}</div>
          ${item.req ? `<div class="req-text">ğŸ“ éœ€æ±‚: ${item.req}</div>` : ''}
          ${item.sales ? `<div class="req-text" style="color:${item.category==='self'?'#00897b':'#9c27b0'};">ğŸš€ æ¥­å‹™: ${item.sales}</div>` : ''}
        </div>
        <div class="status-checks">
          <span class="check-pill ${item.isL?'on':''}">åŠ Line</span>
          <span class="check-pill ${item.isM?'on':''}">å·²è®€</span>
          <span class="check-pill ${item.isN?'on':''}">æ’¥é›»è©±</span>
          <span class="check-pill ${item.isO?'on':''}">æ’¥é€š</span>
          <span class="check-pill ${item.isQ?'on':''}">Email</span>
        </div>
        <div style="font-size:11px;color:#888;margin-bottom:5px;">ğŸ“ ç´€éŒ„: ${item.rawP || 'ç„¡'}</div>
        <div class="action-grid">
          <a href="${lineUrl}" class="btn-tool btn-line"><i>ğŸ’¬</i>åŠ Line</a>
          <a href="tel:${item.phone}" class="btn-tool btn-call"><i>ğŸ“</i>é›»è©±</a>
          <a href="mailto:${item.email}" class="btn-tool" style="color:#c0392b;"><i>âœ‰ï¸</i>Email</a>
          <a href="${mapUrl}" target="_blank" class="btn-tool btn-map"><i>ğŸ—ºï¸</i>åœ°åœ–</a>
          <div class="btn-tool" style="color:#d35400;" onclick="openUpdate('${item.key}', '${item.name}')"><i>ğŸ“</i>æ›´æ–°${badgeHtml}</div>
          <div class="btn-tool btn-dispatch" onclick="openDispatch('${item.key}')"><i>ğŸš€</i>æ´¾å–®</div>
        </div>
      </div>
    `}).join('');
  }

  function updateSalesFilterUI(sourceData) {
    const targetItems = sourceData.filter(i => i.category === currentTab);
    const counts = {};
    targetItems.forEach(i => { const name = i.sales || 'æœªçŸ¥'; counts[name] = (counts[name] || 0) + 1; });
    const salesNames = Object.keys(counts).sort((a,b) => counts[b] - counts[a]);
    const container = document.getElementById('salesFilterBar');
    let html = `<span class="sales-pill ${currentSalesFilter==='all'?'active':''}" onclick="filterBySales('all')">å…¨éƒ¨ <span class="sales-count">${targetItems.length}</span></span>`;
    salesNames.forEach(name => {
        html += `<span class="sales-pill ${currentSalesFilter===name?'active':''}" onclick="filterBySales('${name}')">${name} <span class="sales-count">${counts[name]}</span></span>`;
    });
    container.innerHTML = html;
  }

  // ğŸŒŸ å„ªåŒ–æç¤ºæ–‡å­— (Smart Summary)
  function updateFilterHint() {
      const container = document.getElementById('filterHintRow');
      let html = '';
      
      // æ—¥æœŸ
      if(filterState.dateStart || filterState.dateEnd) {
          html += `<span class="filter-tag">ğŸ“… æ—¥æœŸç¯©é¸</span>`;
      }
      
      // é€šç”¨ç”Ÿæˆ
      const makeTag = (label, arr) => {
          if (arr.length === 0) return '';
          let text = arr.join(', ');
          if (arr.length > 2) text = `${arr[0]}, ${arr[1]} (+${arr.length-2})`;
          return `<span class="filter-tag">${label}: ${text}</span>`;
      };

      html += makeTag('ğŸ“¢', filterState.source);
      html += makeTag('ğŸ™ï¸', filterState.area);
      html += makeTag('ğŸ­', filterState.industry);
      
      container.innerHTML = html;
      
      const btn = document.getElementById('filterToggleBtn');
      if (html !== '') {
          btn.style.color = '#007bff';
      } else {
          btn.style.color = '#555';
      }
  }

  function setDateGrain(grain, btn) {
      currentDateGrain = grain;
      document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      render(); 
  }

  function updateDateChart(data) {
    if (!charts.date) return;
    const dateMapCompany = {};
    const dateMapSelf = {};
    
    data.forEach(i => { 
        if (!i.date) return;
        const sep = i.date.includes('/') ? '/' : '-';
        const parts = i.date.split(sep);
        if(parts.length < 3) return;
        const y = parseInt(parts[0]);
        const m = parseInt(parts[1]);
        const d = parseInt(parts[2]);
        let key = '';

        if (currentDateGrain === 'month') {
            key = `${y}/${m.toString().padStart(2,'0')}`;
        } else if (currentDateGrain === 'week') {
            const dateObj = new Date(y, m-1, d);
            const day = dateObj.getDay(); 
            const diff = dateObj.getDate() - day + (day === 0 ? -6 : 1);
            const monday = new Date(new Date(y, m-1, d).setDate(diff)); 
            key = `${monday.getMonth()+1}/${monday.getDate()}é€±`;
        } else {
            key = `${m.toString().padStart(2,'0')}/${d.toString().padStart(2,'0')}`;
        }
        
        if (i.source === "æ¥­å‹™è‡ªé–‹ä»¶") {
            dateMapSelf[key] = (dateMapSelf[key] || 0) + 1;
        } else {
            dateMapCompany[key] = (dateMapCompany[key] || 0) + 1;
        }
    });

    const allKeys = [...new Set([...Object.keys(dateMapCompany), ...Object.keys(dateMapSelf)])].sort((a,b) => {
        const pa = a.match(/\d+/g); const pb = b.match(/\d+/g);
        if(!pa || !pb) return 0;
        if(parseInt(pa[0]) !== parseInt(pb[0])) return parseInt(pa[0]) - parseInt(pb[0]);
        return parseInt(pa[1]||0) - parseInt(pb[1]||0);
    });

    charts.date.data.labels = allKeys;
    charts.date.data.datasets[0].data = allKeys.map(k => dateMapCompany[k] || 0);
    charts.date.data.datasets[1].data = allKeys.map(k => dateMapSelf[k] || 0);
    charts.date.update();
  }

  function playScrollHint() {
    const tabs = document.getElementById('statusTabs');
    setTimeout(() => { tabs.scrollTo({ left: 30, behavior: 'smooth' }); setTimeout(() => { tabs.scrollTo({ left: 0, behavior: 'smooth' }); }, 300); }, 800);
  }

  function filterBySales(name) { currentSalesFilter = name; render(); }
  function setTab(t) { currentTab=t; document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); document.querySelector(`.tab-${t}`).classList.add('active'); render(); }
  
  function calculateCountsAndCharts(data) {
    const cnt = { new:0, unread:0, read:0, noline:0, dispatched:0, self:0, invalid:0 };
    data.forEach(i => { if(cnt[i.category] !== undefined) cnt[i.category]++; });
    const total = data.length;

    document.getElementById('cnt-all').innerText = total;
    document.getElementById('cnt-new').innerText = cnt.new;
    document.getElementById('cnt-unread').innerText = cnt.unread;
    document.getElementById('cnt-read').innerText = cnt.read;
    document.getElementById('cnt-noline').innerText = cnt.noline;
    document.getElementById('cnt-dispatched').innerText = cnt.dispatched;
    document.getElementById('cnt-self').innerText = cnt.self; 
    document.getElementById('cnt-invalid').innerText = cnt.invalid;
    
    if (charts.status) {
        charts.status.data.datasets[0].data = [cnt.new, cnt.unread, cnt.read, cnt.noline, cnt.dispatched, cnt.self, cnt.invalid];
        charts.status.update();
        updateSalesChart(data);
        updateDateChart(data); 
        updateChartCount(charts.source, data, 'source');
        updateChartCount(charts.area, data, 'area', 10);
    }
  }

  function updateSalesChart(data) {
    if (!charts.sales) return;
    const validItems = data.filter(i => i.category === 'dispatched' || i.category === 'self');
    const salesMap = {};
    validItems.forEach(i => {
        const name = i.sales || 'æœªçŸ¥';
        if (!salesMap[name]) salesMap[name] = { dispatched: 0, self: 0 };
        if (i.category === 'dispatched') salesMap[name].dispatched++;
        else if (i.category === 'self') salesMap[name].self++;
    });
    const sortedNames = Object.keys(salesMap).sort((a,b) => (salesMap[b].dispatched + salesMap[b].self) - (salesMap[a].dispatched + salesMap[a].self));
    charts.sales.data.labels = sortedNames;
    charts.sales.data.datasets[0].data = sortedNames.map(n => salesMap[n].dispatched); 
    charts.sales.data.datasets[1].data = sortedNames.map(n => salesMap[n].self);       
    charts.sales.update();
  }

  function toggleSort() { sortDesc = !sortDesc; const btn = document.getElementById('sortToggleBtn'); btn.classList.toggle('active', !sortDesc); doSort(); render(); }
  function doSort() { 
    allData.sort((a, b) => { 
        const valA = parseInt(a.key) || 0;
        const valB = parseInt(b.key) || 0;
        return sortDesc ? (valB - valA) : (valA - valB); 
    }); 
  }

  function openUpdate(key, name) { clickCounts[key] = (clickCounts[key] || 0) + 1; localStorage.setItem('ezPretty_ClickCounts', JSON.stringify(clickCounts)); const targetUrl = `https://liff.line.me/${FORM_LIFF_ID}?key=${encodeURIComponent(key)}&store=${encodeURIComponent(name)}`; liff.openWindow({ url: targetUrl, external: false }); setTimeout(render, 500); }
  function openDispatch(key) { alert("ğŸš€ æ´¾å–®åŠŸèƒ½é–‹ç™¼ä¸­... (å–®è™Ÿ: " + key + ")"); }
  function copyContent(text, label) { if (!text) return; navigator.clipboard.writeText(text).then(() => { const t = document.getElementById("toast"); t.innerText = `å·²è¤‡è£½ ${label}ï¼`; t.className = "show"; setTimeout(() => t.className = "", 3000); }); }
  function resetAllFilters() { 
      filterState = { dateStart: null, dateEnd: null, source: [], area: [], industry: [] };
      document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
      document.getElementById('dateStart').value = '';
      document.getElementById('dateEnd').value = '';
      document.getElementById('dateDisplay').innerText = 'å…¨éƒ¨æ—¥æœŸ';
      render(); 
  }
  function togglePanel(id) { 
      const p = document.getElementById(id); 
      const otherId = id==='filterPanel'?'chartPanel':'filterPanel'; 
      document.getElementById(otherId).style.display='none'; 
      const btnId = id==='filterPanel'?'filterToggleBtn':'chartToggleBtn'; 
      const otherBtnId = id==='filterPanel'?'chartToggleBtn':'filterToggleBtn'; 
      document.getElementById(otherBtnId).classList.remove('active');
      
      if(p.style.display==='block') { 
          p.style.display='none'; 
      } else { 
          p.style.display='block'; 
          document.getElementById(btnId).classList.add('active'); 
          if(id==='filterPanel') { document.getElementById(btnId).style.background=''; document.getElementById(btnId).style.color=''; } 
      } 
  }
  function switchChart(type) { document.querySelectorAll('.chart-tab-btn').forEach(b => b.classList.remove('active')); document.querySelector(`.chart-tab-btn[onclick*="${type}"]`).classList.add('active'); document.querySelectorAll('.chart-wrapper').forEach(w => w.classList.remove('active')); document.getElementById('chart-' + type).classList.add('active'); }
  
  function initAllCharts() { 
      charts.status = new Chart(document.getElementById('canvas-status'), { type: 'doughnut', data: { labels: ['ğŸ†• æ–°å–®', 'ğŸ“² æœªè®€', 'ğŸ‘€ å·²è®€', 'ğŸ“µ æ²’Line', 'ğŸš€ å·²æ´¾å–®', 'ğŸ’ª è‡ªé–‹', 'ğŸ’€ ç„¡æ•ˆ'], datasets: [{ data: [], backgroundColor: ['#00C851', '#ffbb33', '#ff4444', '#33b5e5', '#9c27b0', '#00897b', '#6c757d'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } } }); 
      charts.sales = new Chart(document.getElementById('canvas-sales'), { type: 'bar', data: { labels: [], datasets: [{ label: 'ğŸš€ å·²æ´¾å–®', data: [], backgroundColor: '#9c27b0' }, { label: 'ğŸ’ª è‡ªé–‹ä»¶', data: [], backgroundColor: '#00897b' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true } } } });
      charts.date = new Chart(document.getElementById('canvas-date'), { type: 'line', data: { labels: [], datasets: [{ label: 'ğŸ¢ å…¬å¸å»£å‘Š', data: [], borderColor: '#36A2EB', backgroundColor: '#36A2EB', tension: 0.3 }, { label: 'ğŸ’ª æ¥­å‹™è‡ªé–‹', data: [], borderColor: '#00C851', backgroundColor: '#00C851', tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false } }); 
      charts.source = new Chart(document.getElementById('canvas-source'), { type: 'pie', data: { labels: [], datasets: [{ data: [], backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } } }); 
      charts.area = new Chart(document.getElementById('canvas-area'), { type: 'bar', data: { labels: [], datasets: [{ label: 'åœ°å€åˆ†ä½ˆ', data: [], backgroundColor: '#FF9F40' }] }, options: { responsive: true, maintainAspectRatio: false } }); 
  }
  
  function updateChartCount(chart, data, field, limit = 0) { const map = {}; data.forEach(i => { const key = i[field] || 'æœªçŸ¥'; map[key] = (map[key] || 0) + 1; }); let keys = Object.keys(map).sort((a,b) => map[b] - map[a]); if (limit > 0 && keys.length > limit) keys = keys.slice(0, limit); chart.data.labels = keys; chart.data.datasets[0].data = keys.map(k => map[k]); chart.update(); }
  function checkDuplicates(data) { const lookup = { name: {}, phone: {} }; data.forEach(item => { const add = (f, v) => { if (!v) return; const k = String(v).trim(); if (!lookup[f][k]) lookup[f][k] = []; lookup[f][k].push(item); }; add('name', item.name); add('phone', item.phone); }); ['name','phone'].forEach(f => { Object.values(lookup[f]).forEach(list => { if (list.length > 1) { list.forEach(i => { i.isDup = true; if (!i.dupInfo) i.dupInfo = []; const others = list.filter(o => o.key !== i.key).map(o => `[${o.industry||'æœªåˆ†'}] ${o.name} (#${o.key})`); const unique = [...new Set(others)]; if(unique.length>0) i.dupInfo.push({ reason: f==='name'?'åº—å':'é›»è©±', targets: unique }); }); } }); }); }
  function getSourceStyle(s) { s=String(s||""); if(s.includes("è¬›åº§")) return {bg:"#8e44ad",label:"ğŸ”¥ "+s}; if(s.includes("LINE")||s.includes("å…¬å¸")) return {bg:"#27ae60",label:"ğŸ€ "+s}; if(s.includes("Google")) return {bg:"#c0392b",label:"ğŸ”´ "+s}; return {bg:"#7f8c8d",label:"ğŸ”” "+s}; }

  window.onload = loadData;
</script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ezPretty é–‹ç™¼æˆ°æƒ…å®¤</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: -apple-system, "Noto Sans TC", sans-serif; background: #f4f6f9; padding: 10px; margin: 0; }
    .header-sticky { position: sticky; top: 0; background: #f4f6f9; z-index: 100; padding-bottom: 10px; }
    .search-input { width: 100%; padding: 12px 20px; border-radius: 25px; border: none; box-sizing: border-box; font-size: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 12px; }

    /* 4 å¤§åˆ†é¡æŒ‰éˆ• */
    .filter-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .filter-btn { padding: 8px 5px; border-radius: 12px; border: none; font-weight: bold; color: white; text-align: center; font-size: 13px; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .btn-ice { background: #5D9CEC; } .btn-stall { background: #FFCE54; color: #656D78; }
    .btn-hot { background: #ED5565; } .btn-dead { background: #AAB2BD; }
    .filter-btn.active { box-shadow: 0 0 0 3px #434A54; transform: scale(0.98); }

    /* ğŸŒŸ æ–°å¢ï¼šå–®æ•¸å°æ¨™ç±¤æ¨£å¼ */
    .count-text { font-size: 11px; margin-top: 2px; opacity: 0.9; font-weight: normal; }

    /* åº—å®¶å¡ç‰‡ */
    .store-card { background: white; border-radius: 16px; padding: 16px; margin-bottom: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-top: 6px solid #ccc; }
    .card-ice { border-top-color: #5D9CEC; } .card-stall { border-top-color: #FFCE54; }
    .card-hot { border-top-color: #ED5565; } .card-dead { border-top-color: #AAB2BD; }

    /* 12ç¨®ç‹€æ…‹ç²¾å¯†æ¨™ç±¤ */
    .detail-label { display: inline-block; background: #434A54; color: white; font-size: 11px; padding: 3px 12px; border-radius: 20px; margin-bottom: 10px; }

    .store-name { font-size: 19px; font-weight: bold; color: #333; margin-bottom: 8px; }
    .key-badge { font-size: 11px; color: #999; font-weight: normal; }

    /* è³‡è¨Šå€ */
    .info-box { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; font-size: 13px; color: #555; background: #f8faff; padding: 12px; border-radius: 12px; border: 1px solid #eef2f7; }
    .info-item b { color: #333; }
    .full-row { grid-column: span 2; border-top: 1px solid #edf1f7; padding-top: 6px; margin-top: 4px; }

    /* ç‹€æ…‹æ¨™ç±¤å€ */
    .status-tags { display: flex; gap: 5px; margin: 12px 0; flex-wrap: wrap; }
    .tag { font-size: 10px; padding: 3px 6px; border-radius: 6px; background: #f1f3f5; border: 1px solid #dee2e6; color: #444; }
    .tag-active { background: #e7f5ff; border-color: #a5d8ff; color: #1971c2; font-weight: bold; }
    
    /* é€šè©±ç´€éŒ„å°ˆç”¨æ¡† (Pæ¬„) */
    .call-log-box { width: 100%; font-size: 11px; background: #fffdf0; padding: 8px; border-radius: 6px; border: 1px dashed #f6e05e; margin-top: 5px; color: #744210; }

    .action-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 15px; }
    .btn-tool { display: flex; flex-direction: column; align-items: center; padding: 8px 0; border-radius: 12px; border: 1px solid #ddd; font-size: 10px; font-weight: bold; text-decoration: none; color: #444; background: #fff; transition: 0.2s; }
    .btn-tool i { font-size: 18px; margin-bottom: 2px; font-style: normal; }
    .btn-call { background: #eafaf1; border-color: #2ecc71; color: #27ae60; }
    .btn-line { background: #ebf9f0; border-color: #06C755; color: #06C755; }
  </style>
</head>
<body>

  <div class="header-sticky">
    <input type="text" class="search-input" id="searchInput" placeholder="ğŸ” æœåº—åã€è² è²¬äººã€éœ€æ±‚ã€ç´€éŒ„..." oninput="render()">
    <div class="filter-grid">
      <div class="filter-btn btn-ice active" id="f-ice" onclick="setFilter('ice')">
        ğŸ§Š å†°å°æ–°åå–® <span class="count-text" id="count-ice">(0 å–®)</span>
      </div>
      <div class="filter-btn btn-stall" id="f-stall" onclick="setFilter('stall')">
        âš¡ è¯çµ¡é€²è¡Œä¸­ <span class="count-text" id="count-stall">(0 å–®)</span>
      </div>
      <div class="filter-btn btn-hot" id="f-hot" onclick="setFilter('hot')">
        ğŸ”¥ æ’¥é€šè¿½è¹¤ä¸­ <span class="count-text" id="count-hot">(0 å–®)</span>
      </div>
      <div class="filter-btn btn-dead" id="f-dead" onclick="setFilter('dead')">
        âš ï¸ ç€•æ­»/å·²æ–·ç·š <span class="count-text" id="count-dead">(0 å–®)</span>
      </div>
    </div>
  </div>

  <div id="storeList">
    <div style="text-align:center; padding:50px; color:#999;">åå–®è¼‰å…¥ä¸­...</div>
  </div>

<script>
  let allData = [];
  let currentFilter = 'ice';

  async function loadData() {
    const gasUrl = "https://script.google.com/macros/s/AKfycbzIKHpWcWj0bOhaQsx-OynY5FVVorMJvTNON5PBOywj1q-Nd5EylLCSl-zTlFW9Rb5U/exec?action=getManagementList";
    try {
      const response = await fetch(gasUrl);
      allData = await response.json();
      updateCategoryCounts(); // ğŸŒŸ è®€å–å¾Œç«‹åˆ»çµ±è¨ˆ
      render();
    } catch (e) {
      document.getElementById('storeList').innerHTML = `<div style="text-align:center; padding:20px; color:red;">é€£ç·šå¤±æ•—<br><small>${e.message}</small></div>`;
    }
  }

  // ğŸŒŸ æ–°å¢ï¼šè¨ˆç®—å››å¤§åˆ†é¡å–®æ•¸çš„é‚è¼¯
  function updateCategoryCounts() {
    const counts = { ice: 0, stall: 0, hot: 0, dead: 0 };
    allData.forEach(item => {
      if(counts.hasOwnProperty(item.type)) {
        counts[item.type]++;
      }
    });
    // æ›´æ–°åˆ°ä»‹é¢
    document.getElementById('count-ice').innerText = `(${counts.ice} å–®)`;
    document.getElementById('count-stall').innerText = `(${counts.stall} å–®)`;
    document.getElementById('count-hot').innerText = `(${counts.hot} å–®)`;
    document.getElementById('count-dead').innerText = `(${counts.dead} å–®)`;
  }

  function render() {
    const list = document.getElementById('storeList');
    const search = document.getElementById('searchInput').value.trim().toLowerCase();
    
    const filtered = allData.filter(i => {
      const content = (i.name + i.boss + i.area + i.key + i.req + i.rawP).toLowerCase();
      const matchSearch = content.includes(search);
      // å¦‚æœæœ‰è¼¸å…¥æœå°‹æ–‡å­—ï¼Œå°±è·¨åˆ†é¡æœå°‹ï¼›æ²’æœå°‹æ™‚æ‰é¡¯ç¤ºç•¶å‰æŒ‰éˆ•åˆ†é¡
      return (search !== "") ? matchSearch : (matchSearch && i.type === currentFilter);
    });

    if (filtered.length === 0) {
      list.innerHTML = `<div style="text-align:center; padding:50px; color:#999;">æš«ç„¡ç¬¦åˆåå–®</div>`;
      return;
    }

    list.innerHTML = filtered.map(item => `
      <div class="store-card card-${item.type}">
        <div class="detail-label">ğŸ“ ${item.detailLabel}</div>
        
        <div class="store-name">
          ${item.area}${item.name} <span class="key-badge">#${item.key}</span>
        </div>
        
        <div class="info-box">
          <div class="info-item"><b>ä¾†æº:</b> ${item.source}</div>
          <div class="info-item"><b>æ—¥æœŸ:</b> ${item.date}</div>
          <div class="info-item"><b>è² è²¬äºº:</b> ${item.boss}</div>
          <div class="info-item"><b>é›»è©±:</b> ${item.phone}</div>
          <div class="info-item full-row" style="color:#d35400;"><b>éœ€æ±‚:</b> ${item.req}</div>
        </div>

        <div class="status-tags">
          <span class="tag ${item.isL?'tag-active':''}">åŠ Line: ${item.isL?'âœ…':'âŒ'}</span>
          <span class="tag ${item.isM?'tag-active':''}">å·²è®€: ${item.isM?'âœ…':'âŒ'}</span>
          <span class="tag ${item.isN?'tag-active':''}">å·²æ‰“: ${item.isN?'âœ…':'âŒ'}</span>
          <span class="tag ${item.isO?'tag-active':''}">æ’¥é€š: ${item.isO?'âœ…':'âŒ'}</span>
          <span class="tag ${item.isQ?'tag-active':''}">Email: ${item.isQ?'âœ…':'âŒ'}</span>
          
          <div class="call-log-box">
             <b>ğŸ“ é€šè©±æ¬¡æ•¸èˆ‡ç´€éŒ„:</b> ${item.rawP}
          </div>
        </div>

        <div class="action-grid">
          <a href="tel:${item.phone}" class="btn-tool btn-call"><i>ğŸ“</i>æ’¥é›»è©±</a>
          <a href="https://line.me/ti/p/~${item.lineId}" class="btn-tool btn-line"><i>ğŸ’¬</i>åŠ LINE</a>
          <div class="btn-tool" style="color:#d35400;" onclick="openUpdate('${item.key}')"><i>ğŸ“</i>é€²åº¦</div>
          <div class="btn-tool" style="color:#2980b9;" onclick="openDispatch('${item.key}')"><i>ğŸš€</i>æ´¾å–®</div>
        </div>
      </div>
    `).join('');
  }

  function setFilter(t) {
    currentFilter = t;
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('f-'+t).classList.add('active');
    document.getElementById('searchInput').value = ""; 
    render();
  }

  function openUpdate(key) {
    alert("å–®è™Ÿ " + key + " é€²åº¦æ›´æ–°åŠŸèƒ½é–‹ç™¼ä¸­...");
  }

  function openDispatch(key) {
    alert("æº–å‚™æ´¾ç™¼å–®è™Ÿ " + key + "...");
  }

  window.onload = loadData;
</script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ezPretty é–‹ç™¼æˆ°æƒ…å®¤</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: -apple-system, "Noto Sans TC", sans-serif; background: #f4f6f9; padding: 10px; margin: 0; padding-bottom: 80px; }
    .header-sticky { position: sticky; top: 0; background: #f4f6f9; z-index: 100; padding-bottom: 5px; }
    
    /* æ§åˆ¶é¢æ¿ */
    .control-panel { display: flex; flex-direction: column; gap: 8px; margin-bottom: 8px; }
    .control-row { display: flex; gap: 8px; }

    .custom-select {
      padding: 8px 4px;
      border-radius: 20px;
      border: none;
      background: white;
      font-size: 13px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      appearance: none;
      text-align: center;
      font-weight: bold;
      color: #555;
    }

    .flex-1 { flex: 1; }
    .sel-status { flex: 1.5; text-align: left; padding-left: 12px; }
    
    .search-input { 
      flex: 1; 
      padding: 8px 15px;
      border-radius: 20px; 
      border: none; 
      box-sizing: border-box; 
      font-size: 14px; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
      outline: none;
    }

    /* 4 å¤§åˆ†é¡æŒ‰éˆ• */
    .filter-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
    .filter-btn { 
      padding: 6px 2px;
      border-radius: 10px; 
      border: none; 
      font-weight: bold; 
      color: white; 
      text-align: center; 
      font-size: 11px;
      cursor: pointer; 
      transition: 0.2s; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      justify-content: center; 
      min-height: 42px;
    }
    .btn-ice { background: #5D9CEC; } .btn-stall { background: #FFCE54; color: #656D78; }
    .btn-hot { background: #ED5565; } .btn-dead { background: #AAB2BD; }
    .filter-btn.active { box-shadow: 0 0 0 2px #434A54; transform: scale(0.98); }

    .count-text { 
      font-size: 10px; 
      margin-top: 1px; 
      opacity: 0.9; 
      font-weight: normal; 
      background: rgba(0,0,0,0.1);
      padding: 0 4px;
      border-radius: 4px;
    }

    /* å¡ç‰‡æ¨£å¼ */
    .store-card { position: relative; background: white; border-radius: 16px; padding: 16px; margin-bottom: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-top: 6px solid #ccc; }
    .card-ice { border-top-color: #5D9CEC; } .card-stall { border-top-color: #FFCE54; }
    .card-hot { border-top-color: #ED5565; } .card-dead { border-top-color: #AAB2BD; }

    .top-right-badge {
        position: absolute;
        top: 12px;
        right: 12px;
        text-align: right;
        font-size: 11px;
        color: #888;
        line-height: 1.4;
    }
    .badge-source { 
        font-weight: bold; 
        padding: 2px 6px; 
        border-radius: 4px; 
        margin-bottom: 3px; 
        display: inline-block;
        color: #fff; 
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .detail-label { display: inline-block; background: #434A54; color: white; font-size: 11px; padding: 3px 12px; border-radius: 20px; margin-bottom: 8px; }
    
    /* ğŸŒŸ åº—åæ¨£å¼ (å«ç”¢æ¥­åˆ¥) */
    .store-name { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 8px; padding-right: 80px; line-height: 1.4; }
    .industry-text { font-size: 0.9em; color: #555; font-weight: normal; margin-right: 4px; }
    .key-badge { font-size: 11px; color: #999; font-weight: normal; }

    .info-box { display: flex; flex-direction: column; gap: 4px; font-size: 13px; color: #555; background: #f8faff; padding: 10px; border-radius: 12px; border: 1px solid #eef2f7; }
    .info-item b { color: #333; margin-right: 5px; }
    .req-text { color: #d35400; font-weight: bold; border-top: 1px dashed #ddd; padding-top: 4px; margin-top: 2px; }

    .status-tags { display: flex; gap: 4px; margin: 10px 0; flex-wrap: wrap; }
    .tag { font-size: 10px; padding: 2px 5px; border-radius: 4px; background: #f1f3f5; border: 1px solid #dee2e6; color: #444; }
    .tag-active { background: #e7f5ff; border-color: #a5d8ff; color: #1971c2; font-weight: bold; }
    
    .call-log-box { width: 100%; font-size: 11px; background: #fffdf0; padding: 6px; border-radius: 6px; border: 1px dashed #f6e05e; margin-top: 4px; color: #744210; }

    /* 6å€‹æŒ‰éˆ• (3x2) */
    .action-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-top: 10px; }
    .btn-tool { display: flex; flex-direction: row; justify-content: center; align-items: center; padding: 6px 0; border-radius: 8px; border: 1px solid #ddd; font-size: 11px; font-weight: bold; text-decoration: none; color: #444; background: #fff; transition: 0.2s; gap: 4px; }
    .btn-tool i { font-size: 14px; margin-bottom: 0; font-style: normal; }
    
    .btn-line { background: #ebf9f0; border-color: #06C755; color: #06C755; }
    .btn-call { background: #e0f7fa; border-color: #00acc1; color: #00838f; }
    .btn-email { background: #fce8e6; border-color: #ea4335; color: #c0392b; }
    .btn-map { background: #e8f0fe; border-color: #4285F4; color: #4285F4; }

    /* æ‡¸æµ®æŒ‰éˆ• */
    .fab-switch {
      position: fixed;
      bottom: 25px;
      right: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 24px;
      border-radius: 50px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      font-size: 14px;
      font-weight: bold;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 1000;
      transition: transform 0.2s;
    }
    .fab-switch:active { transform: scale(0.95); }
    .fab-switch i { font-style: normal; font-size: 18px; }
  </style>
</head>
<body>

  <div class="header-sticky">
    
    <div class="control-panel">
      <div class="control-row">
        <select id="dateSelect" class="custom-select flex-1" onchange="updateAllCounts(); render()">
          <option value="all">ğŸ“… æ—¥æœŸ</option>
        </select>
        
        <select id="areaSelect" class="custom-select flex-1" onchange="updateAllCounts(); render()">
          <option value="all">ğŸ™ï¸ åœ°å€</option>
        </select>
      </div>

      <div class="control-row">
        <select id="detailSelect" class="custom-select sel-status" onchange="render()">
          <option value="all">ğŸ·ï¸ æ‰€æœ‰ç‹€æ…‹</option>
          <optgroup label="ğŸ”¥ å·²æ’¥é€š (Hot)">
              <option value="æºé€šé †æš¢">ğŸ”¥ æºé€šé †æš¢</option>
              <option value="æ•·è¡æ‡‰ä»˜">ğŸ”¥ æ•·è¡æ‡‰ä»˜</option>
              <option value="å‚³çµ±é–‹ç™¼">ğŸ”¥ å‚³çµ±é–‹ç™¼</option>
          </optgroup>
          <optgroup label="âš¡ æ•¸ä½åƒµå±€ (Stall)">
              <option value="é–€å¸‚å¿™ç¢Œ">âš¡ é–€å¸‚å¿™ç¢Œ</option>
              <option value="æ•¸ä½è£æ­»">âš¡ æ•¸ä½è£æ­»</option>
              <option value="å¹½éˆå°é–">âš¡ å¹½éˆå°é–</option>
              <option value="æ•¸ä½å¾…æ©Ÿ">âš¡ æ•¸ä½å¾…æ©Ÿ</option>
              <option value="å‚³çµ±åƒµå±€">âš¡ å‚³çµ±åƒµå±€</option>
              <option value="éƒµä»¶è¿½è¹¤">âš¡ éƒµä»¶è¿½è¹¤</option>
          </optgroup>
          <optgroup label="ğŸ§Š/âš ï¸ ç‰¹æ®Šç‹€æ…‹">
              <option value="å†°å°æ–°åå–®">ğŸ§Š å†°å°åå–®</option>
              <option value="ç€•æ­»åå–®">âš ï¸ ç€•æ­»åå–®</option>
          </optgroup>
        </select>

        <input type="text" class="search-input" id="searchInput" placeholder="ğŸ” æœåº—åã€è² è²¬äººã€é›»è©±..." oninput="render()">
      </div>
    </div>

    <div class="filter-grid">
      <div class="filter-btn btn-ice active" id="f-ice" onclick="setFilter('ice')">
        ğŸ§Š å†°å° <span class="count-text" id="count-ice">0</span>
      </div>
      <div class="filter-btn btn-stall" id="f-stall" onclick="setFilter('stall')">
        âš¡ é€²è¡Œ <span class="count-text" id="count-stall">0</span>
      </div>
      <div class="filter-btn btn-hot" id="f-hot" onclick="setFilter('hot')">
        ğŸ”¥ è¿½è¹¤ <span class="count-text" id="count-hot">0</span>
      </div>
      <div class="filter-btn btn-dead" id="f-dead" onclick="setFilter('dead')">
        âš ï¸ ç€•æ­» <span class="count-text" id="count-dead">0</span>
      </div>
    </div>
  </div>

  <div id="storeList">
    <div style="text-align:center; padding:50px; color:#999;">åå–®è¼‰å…¥ä¸­...</div>
  </div>

  <a href="https://liff.line.me/YOUR_BACKEND_LIFF_ID" class="fab-switch">
    ğŸ¯ å‰å¾€å¾Œæ®µ <i>â†’</i>
  </a>

<script>
  let allData = [];
  let currentFilter = 'ice';

  async function loadData() {
    const gasUrl = "https://script.google.com/macros/s/AKfycbzIKHpWcWj0bOhaQsx-OynY5FVVorMJvTNON5PBOywj1q-Nd5EylLCSl-zTlFW9Rb5U/exec?action=getManagementList";
    try {
      const response = await fetch(gasUrl);
      const rawData = await response.json();
      // æ’é™¤å·²æœ‰æ¥­å‹™çš„
      allData = rawData.filter(item => !item.sales || item.sales.toString().trim() === "");

      initDateSelect();
      initAreaSelect(); 
      updateAllCounts(); 
      render();
    } catch (e) {
      document.getElementById('storeList').innerHTML = `<div style="text-align:center; padding:20px; color:red;">é€£ç·šå¤±æ•—<br><small>${e.message}</small></div>`;
    }
  }

  function initDateSelect() {
    const select = document.getElementById('dateSelect');
    const yearSet = new Set();
    const monthSet = new Set();
    allData.forEach(d => {
      if (!d.date) return;
      const parts = d.date.split('/'); 
      if (parts.length >= 1) yearSet.add(parts[0]); 
      if (parts.length >= 2) monthSet.add(parts[0] + '/' + parts[1]);
    });
    const sortedYears = [...yearSet].sort((a, b) => b - a);
    sortedYears.forEach(year => {
      const yearOption = document.createElement('option');
      yearOption.value = year;
      yearOption.text = `ğŸ“‚ ${year}`;
      yearOption.style.fontWeight = "bold";
      select.appendChild(yearOption);
      const monthsInYear = [...monthSet]
        .filter(m => m.startsWith(year + '/'))
        .sort((a, b) => parseInt(b.split('/')[1]) - parseInt(a.split('/')[1]));
      monthsInYear.forEach(m => {
        const monOption = document.createElement('option');
        monOption.value = m;
        monOption.text = `ã€€${m.split('/')[1]}æœˆ`;
        select.appendChild(monOption);
      });
    });
  }

  function initAreaSelect() {
    const select = document.getElementById('areaSelect');
    const areaSet = new Set();
    allData.forEach(item => {
      if (item.area && item.area.trim() !== "") {
        areaSet.add(item.area.trim());
      }
    });
    const sortedAreas = [...areaSet].sort((a, b) => a.localeCompare(b, 'zh-Hant'));
    sortedAreas.forEach(area => {
      const option = document.createElement('option');
      option.value = area;
      option.text = area;
      select.appendChild(option);
    });
  }

  function updateAllCounts() {
    const selectedDate = document.getElementById('dateSelect').value;
    const selectedArea = document.getElementById('areaSelect').value; 
    
    const mainCounts = { ice: 0, stall: 0, hot: 0, dead: 0 };
    const detailCounts = {}; 
    let totalMatch = 0; 

    allData.forEach(item => {
      let matchDate = true;
      if (selectedDate !== 'all') {
         if (!item.date) matchDate = false;
         else {
           const dP = item.date.split('/');
           const sP = selectedDate.split('/');
           matchDate = (sP.length===1) ? (dP[0]===sP[0]) : (dP[0]===sP[0] && dP[1]===sP[1]);
         }
      }

      let matchArea = true;
      if (selectedArea !== 'all') {
         matchArea = item.area === selectedArea;
      }

      if (matchDate && matchArea) {
        totalMatch++; 
        if (mainCounts.hasOwnProperty(item.type)) mainCounts[item.type]++;
        if (item.detailLabel) updateOptionCount(detailCounts, item.detailLabel);
      }
    });

    document.getElementById('count-ice').innerText = `${mainCounts.ice}`;
    document.getElementById('count-stall').innerText = `${mainCounts.stall}`;
    document.getElementById('count-hot').innerText = `${mainCounts.hot}`;
    document.getElementById('count-dead').innerText = `${mainCounts.dead}`;
    refreshSelectOptions(detailCounts, totalMatch);
  }

  function updateOptionCount(counter, label) {
    const options = document.getElementById('detailSelect').querySelectorAll('option');
    options.forEach(opt => {
        if (opt.value !== 'all' && label.includes(opt.value)) {
            counter[opt.value] = (counter[opt.value] || 0) + 1;
        }
    });
  }

  function refreshSelectOptions(counts, total) {
    const select = document.getElementById('detailSelect');
    const options = select.querySelectorAll('option');
    options.forEach(opt => {
        if (opt.value === 'all') {
             opt.text = `ğŸ·ï¸ æ‰€æœ‰ç‹€æ…‹ (${total})`;
             return;
        }
        let baseText = opt.text.replace(/\s\(\d+\)$/, ''); 
        const count = counts[opt.value] || 0;
        opt.text = `${baseText} (${count})`;
    });
  }

  function getSourceStyle(source) {
    const s = String(source || ""); 
    if (s.includes("è¬›åº§ä»¶")) return { bg: "#6F4E37", label: "ğŸ”¥ " + s };
    if (s.includes("LINE@") || s.includes("å…¬å¸ä»¶")) return { bg: "#06C755", label: "ğŸ€ " + s };
    if (s.includes("Meta"))  return { bg: "#1877F2", label: "ğŸ”µ " + s };
    if (s.includes("Google")) return { bg: "#DB4437", label: "ğŸ”´ " + s };
    return { bg: "#808080", label: "ğŸ”” " + s };
  }

  function render() {
    const list = document.getElementById('storeList');
    const search = document.getElementById('searchInput').value.trim().toLowerCase();
    const selectedDate = document.getElementById('dateSelect').value;
    const selectedArea = document.getElementById('areaSelect').value; 
    const selectedDetail = document.getElementById('detailSelect').value; 

    const filtered = allData.filter(i => {
      const content = (i.name + i.boss + i.area + i.key + i.req + i.rawP).toLowerCase();
      const matchSearch = (search === "") || content.includes(search);
      const matchType = (search !== "") ? true : (i.type === currentFilter);
      
      let matchDate = true;
      if (selectedDate !== 'all') {
         if (!i.date) matchDate = false;
         else {
           const dP = i.date.split('/');
           const sP = selectedDate.split('/');
           matchDate = (sP.length===1) ? (dP[0]===sP[0]) : (dP[0]===sP[0] && dP[1]===sP[1]);
         }
      }

      let matchArea = true;
      if (selectedArea !== 'all') {
         matchArea = i.area === selectedArea;
      }

      let matchDetail = true;
      if (selectedDetail !== 'all') {
        matchDetail = i.detailLabel && i.detailLabel.includes(selectedDetail);
      }
      return matchSearch && matchType && matchDate && matchArea && matchDetail;
    });

    if (filtered.length === 0) {
      list.innerHTML = `<div style="text-align:center; padding:50px; color:#999;">ç„¡ç¬¦åˆåå–®</div>`;
      return;
    }

    list.innerHTML = filtered.map(item => {
      const style = getSourceStyle(item.source);
      
      return `
      <div class="store-card card-${item.type}">
        <div class="top-right-badge">
            <span class="badge-source" style="background:${style.bg}">${style.label}</span><br>
            ${item.date}
        </div>

        <div class="detail-label">ğŸ“ ${item.detailLabel}</div>
        
        <div class="store-name">
            <span class="industry-text">ğŸ­ ${item.industry || 'æœªåˆ†é¡'}</span>ï½œ
            ${item.area}${item.name} 
            <span class="key-badge">#${item.key}</span>
        </div>
        
        <div class="info-box">
          <div><b>ğŸ‘¤ è² è²¬äºº:</b> ${item.boss}</div>
          <div></div> 
          <div><b>ğŸ“ é›»è©±:</b> ${item.phone}</div>
          <div><b>ğŸ†” Line:</b> ${item.lineId}</div>
          <div class="req-text">ğŸ“ éœ€æ±‚: ${item.req}</div>
        </div>

        <div class="status-tags">
          <span class="tag ${item.isL?'tag-active':''}">åŠ Line: ${item.isL?'âœ…':'âŒ'}</span>
          <span class="tag ${item.isM?'tag-active':''}">å·²è®€: ${item.isM?'âœ…':'âŒ'}</span>
          <span class="tag ${item.isN?'tag-active':''}">å·²æ‰“: ${item.isN?'âœ…':'âŒ'}</span>
          <span class="tag ${item.isO?'tag-active':''}">æ’¥é€š: ${item.isO?'âœ…':'âŒ'}</span>
          <span class="tag ${item.isQ?'tag-active':''}">Email: ${item.isQ?'âœ…':'âŒ'}</span>
          <div class="call-log-box"><b>ğŸ“ é€šè©±:</b> ${item.rawP}</div>
        </div>
        
        <div class="action-grid">
          <a href="https://line.me/ti/p/~${item.lineId}" class="btn-tool btn-line"><i>ğŸ’¬</i>åŠ LINE</a>
          <a href="tel:${item.phone}" class="btn-tool btn-call"><i>ğŸ“</i>é›»è©±</a>
          <a href="mailto:${item.email}" class="btn-tool btn-email"><i>âœ‰ï¸</i>Email</a>
          <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.area + item.name)}" target="_blank" class="btn-tool btn-map"><i>ğŸ—ºï¸</i>åœ°åœ–</a>
          <div class="btn-tool" style="color:#d35400;" onclick="openUpdate('${item.key}')"><i>ğŸ“</i>é€²åº¦</div>
          <div class="btn-tool" style="color:#2980b9;" onclick="openDispatch('${item.key}')"><i>ğŸš€</i>æ´¾å–®</div>
        </div>
      </div>
    `}).join('');
  }

  function setFilter(t) {
    currentFilter = t;
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('f-'+t).classList.add('active');
    document.getElementById('searchInput').value = ""; 
    render();
  }

  function openUpdate(key) { alert("æ›´æ–° " + key); }
  function openDispatch(key) { alert("æ´¾å–® " + key); }

  window.onload = loadData;
</script>
</body>
</html>

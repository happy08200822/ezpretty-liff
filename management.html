<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ezPretty é–‹ç™¼æˆ°æƒ…å®¤</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    body { font-family: -apple-system, "Noto Sans TC", sans-serif; background: #f4f6f9; padding: 10px; margin: 0; padding-bottom: 80px; }
    .header-sticky { position: sticky; top: 0; background: #f4f6f9; z-index: 100; padding-bottom: 5px; }
    
    .top-search-container { margin-bottom: 8px; }
    .main-search-input { 
      width: 100%; padding: 12px 15px; border-radius: 12px; border: 2px solid #e0e0e0; 
      background: #fff; box-sizing: border-box; font-size: 15px; outline: none;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.3s;
    }
    .main-search-input:focus { border-color: #007bff; box-shadow: 0 0 0 3px rgba(0,123,255,0.2); }

    /* å·¥å…·åˆ— */
    .top-toolbar { display: flex; gap: 8px; margin-bottom: 8px; justify-content: space-between; }
    .tool-btn {
      flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px;
      background: white; border: none; padding: 8px 5px; border-radius: 12px;
      font-size: 12px; font-weight: bold; color: #555;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s;
      min-height: 52px; /* ç¨å¾®åŠ é«˜ä»¥å®¹ç´æç¤ºå­— */
    }
    .tool-btn i { font-style: normal; font-size: 16px; }
    .tool-btn.active { background: #e8f0fe; color: #007bff; border: 1px solid #b3d7ff; }
    
    /* ğŸŒŸ æ–°å¢ï¼šç¯©é¸æç¤ºæ–‡å­—æ¨£å¼ */
    .filter-hint { 
      font-size: 10px; color: #007bff; font-weight: normal; 
      max-width: 90px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
    }

    /* éš±è—é¢æ¿ */
    .hidden-panel {
      display: none; background: white; border-radius: 16px; padding: 12px; margin-bottom: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      animation: slideDown 0.3s ease-out;
    }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    .control-panel { display: flex; flex-direction: column; gap: 8px; }
    .control-row { display: flex; gap: 8px; align-items: center; }

    .custom-select {
      padding: 8px 4px; border-radius: 20px; border: 1px solid #eee; background: #f9f9f9;
      font-size: 13px; appearance: none; text-align: center; font-weight: bold; color: #555; width: 100%;
    }
    .flex-1 { flex: 1; }
    .sel-status { flex: 1.5; text-align: left; padding-left: 12px; }

    /* ğŸŒŸ æ–°å¢ï¼šé‡ç½®æŒ‰éˆ•æ¨£å¼ */
    .btn-reset {
      background: #fff0f0; color: #e03131; border: 1px solid #ffc9c9;
      padding: 8px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;
      cursor: pointer; white-space: nowrap;
    }
    .btn-reset:active { background: #ffe3e3; }

    /* åœ–è¡¨ Tabs */
    .chart-tabs { 
      display: flex; gap: 8px; margin-bottom: 10px; overflow-x: auto; padding-bottom: 5px; 
      cursor: grab; -webkit-overflow-scrolling: touch; scrollbar-width: none; 
    }
    .chart-tabs::-webkit-scrollbar { display: none; }
    .chart-tab-btn {
      padding: 6px 12px; border-radius: 20px; background: #f1f3f5; color: #555; 
      font-size: 12px; font-weight: bold; border: none; white-space: nowrap; cursor: pointer;
    }
    .chart-tab-btn.active { background: #007bff; color: white; }
    
    /* åœ–è¡¨é«˜åº¦å®¹å™¨ */
    .chart-wrapper { position: relative; height: 260px; width: 100%; display: none; }
    .chart-wrapper.active { display: block; }

    /* 4 å¤§åˆ†é¡æŒ‰éˆ• */
    .filter-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
    .filter-btn { 
      padding: 6px 2px; border-radius: 10px; border: none; font-weight: bold; color: white;
      text-align: center; font-size: 11px; cursor: pointer; transition: 0.2s;
      display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 42px;
    }
    .btn-ice { background: #5D9CEC; } .btn-stall { background: #FFCE54; color: #656D78; }
    .btn-hot { background: #ED5565; } .btn-dead { background: #AAB2BD; }
    .filter-btn.active { box-shadow: 0 0 0 2px #434A54; transform: scale(0.98); }
    .count-text { 
      font-size: 10px; margin-top: 1px; opacity: 0.9; font-weight: normal;
      background: rgba(0,0,0,0.1); padding: 0 4px; border-radius: 4px;
    }

    /* å¡ç‰‡æ¨£å¼ */
    .store-card { position: relative; background: white; border-radius: 16px; padding: 16px; margin-bottom: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-top: 6px solid #ccc; }
    .card-ice { border-top-color: #5D9CEC; } .card-stall { border-top-color: #FFCE54; }
    .card-hot { border-top-color: #ED5565; } .card-dead { border-top-color: #AAB2BD; }

    .top-right-badge { position: absolute; top: 12px; right: 12px; text-align: right; font-size: 11px; color: #888; line-height: 1.4; }
    .badge-source { font-weight: bold; padding: 2px 6px; border-radius: 4px; margin-bottom: 3px; display: inline-block; color: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    .detail-label { display: inline-block; background: #434A54; color: white; font-size: 11px; padding: 3px 12px; border-radius: 20px; margin-bottom: 8px; }
    .store-name { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 4px; padding-right: 80px; line-height: 1.4; display: flex; align-items: center; }
    .industry-text { font-size: 0.9em; color: #555; font-weight: normal; margin-right: 4px; }
    .key-badge { font-size: 11px; color: #999; font-weight: normal; margin-left: 4px; }
    .btn-copy-text { background: none; border: none; font-size: 14px; cursor: pointer; margin-left: 5px; opacity: 0.6; }
    .btn-copy-text:active { transform: scale(0.9); opacity: 1; }

    .dup-alert { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; font-size: 11px; padding: 6px 8px; border-radius: 6px; margin-bottom: 8px; }
    .info-box { display: flex; flex-direction: column; gap: 4px; font-size: 13px; color: #555; background: #f8faff; padding: 10px; border-radius: 12px; border: 1px solid #eef2f7; }
    .req-text { color: #d35400; font-weight: bold; border-top: 1px dashed #ddd; padding-top: 4px; margin-top: 2px; }
    .status-tags { display: flex; gap: 4px; margin: 10px 0; flex-wrap: wrap; }
    .tag { font-size: 10px; padding: 2px 5px; border-radius: 4px; background: #f1f3f5; border: 1px solid #dee2e6; color: #444; }
    .tag-active { background: #e7f5ff; border-color: #a5d8ff; color: #1971c2; font-weight: bold; }
    .call-log-box { width: 100%; font-size: 11px; background: #fffdf0; padding: 6px; border-radius: 6px; border: 1px dashed #f6e05e; margin-top: 4px; color: #744210; }

    .action-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-top: 10px; }
    .btn-tool { display: flex; flex-direction: row; justify-content: center; align-items: center; padding: 6px 0; border-radius: 8px; border: 1px solid #ddd; font-size: 11px; font-weight: bold; text-decoration: none; color: #444; background: #fff; transition: 0.2s; gap: 4px; }
    .btn-line { background: #ebf9f0; border-color: #06C755; color: #06C755; }
    .btn-call { background: #e0f7fa; border-color: #00acc1; color: #00838f; }
    .btn-email { background: #fce8e6; border-color: #ea4335; color: #c0392b; }
    .btn-map { background: #e8f0fe; border-color: #4285F4; color: #4285F4; }
    .btn-tool i { font-size: 14px; margin-bottom: 0; font-style: normal; }

    .fab-switch { position: fixed; bottom: 25px; right: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 24px; border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); font-size: 14px; font-weight: bold; text-decoration: none; display: flex; align-items: center; gap: 8px; z-index: 1000; transition: transform 0.2s; }
    .fab-switch:active { transform: scale(0.95); }
    #toast { visibility: hidden; min-width: 200px; background-color: #333; color: #fff; text-align: center; border-radius: 20px; padding: 10px; position: fixed; z-index: 2000; left: 50%; bottom: 100px; transform: translateX(-50%); font-size: 13px; }
    #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
    @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 100px; opacity: 1;} }
    @keyframes fadeout { from {bottom: 100px; opacity: 1;} to {bottom: 0; opacity: 0;} }

    /* éª¨æ¶å± */
    @keyframes shimmer { 0% { background-position: -468px 0; } 100% { background-position: 468px 0; } }
    .skeleton-card { background: #fff; border-radius: 16px; padding: 16px; margin-bottom: 16px; border-top: 6px solid #e0e0e0; }
    .skeleton-box { background: #f6f7f8; background-image: linear-gradient(to right, #f6f7f8 0%, #edeef1 20%, #f6f7f8 40%, #f6f7f8 100%); background-repeat: no-repeat; background-size: 800px 104px; display: inline-block; position: relative; animation: shimmer 1s linear infinite forwards; border-radius: 4px; }
    .sk-title { width: 60%; height: 20px; margin-bottom: 10px; }
    .sk-detail { width: 100%; height: 80px; margin-bottom: 10px; }
    .sk-btn { width: 30%; height: 30px; } .sk-row { display: flex; gap: 5px; }
  </style>
</head>
<body>

  <div class="header-sticky">
    
    <div class="top-search-container">
        <input type="text" class="main-search-input" id="searchInput" placeholder="ğŸ” æœå°‹åº—åã€é›»è©±ã€IDã€è² è²¬äºº..." oninput="render()">
    </div>

    <div class="top-toolbar">
        <button class="tool-btn" id="filterToggleBtn" onclick="togglePanel('filterPanel')">
            <span><i>ğŸŒªï¸</i> ç¯©é¸æ¢ä»¶</span>
            <span id="filterSummary" class="filter-hint"></span>
        </button>
        <button class="tool-btn" id="chartToggleBtn" onclick="togglePanel('chartPanel')">
            <span><i>ğŸ“Š</i> çµ±è¨ˆåœ–è¡¨</span>
        </button>
        <button class="tool-btn" id="sortToggleBtn" onclick="toggleSort()">
            <span><i>â‡…</i> æ—¥æœŸæ’åº</span>
        </button>
    </div>

    <div id="filterPanel" class="hidden-panel">
        <div class="control-panel">
            <div class="control-row">
                <select id="dateSelect" class="custom-select flex-1" onchange="render()"><option value="all">ğŸ“… æ—¥æœŸ</option></select>
                <select id="sourceSelect" class="custom-select flex-1" onchange="render()"><option value="all">ğŸ“¢ ä¾†æº</option></select>
            </div>
            <div class="control-row">
                <select id="areaSelect" class="custom-select flex-1" onchange="render()"><option value="all">ğŸ™ï¸ åœ°å€</option></select>
                <select id="industrySelect" class="custom-select flex-1" onchange="render()"><option value="all">ğŸ­ ç”¢æ¥­</option></select>
            </div>
            <div class="control-row">
                <select id="detailSelect" class="custom-select flex-1" onchange="render()">
                    <option value="all">ğŸ·ï¸ æ‰€æœ‰ç‹€æ…‹</option>
                    <optgroup label="ğŸ”¥ å·²æ’¥é€š (Hot)">
                        <option value="æºé€šé †æš¢">ğŸ”¥ æºé€šé †æš¢</option>
                        <option value="æ•·è¡æ‡‰ä»˜">ğŸ”¥ æ•·è¡æ‡‰ä»˜</option>
                        <option value="å‚³çµ±é–‹ç™¼">ğŸ”¥ å‚³çµ±é–‹ç™¼</option>
                    </optgroup>
                    <optgroup label="âš¡ æ•¸ä½åƒµå±€ (Stall)">
                        <option value="é–€å¸‚å¿™ç¢Œ">âš¡ é–€å¸‚å¿™ç¢Œ</option>
                        <option value="æ•¸ä½è£æ­»">âš¡ æ•¸ä½è£æ­»</option>
                        <option value="å¹½éˆå°é–">âš¡ å¹½éˆå°é–</option>
                        <option value="æ•¸ä½å¾…æ©Ÿ">âš¡ æ•¸ä½å¾…æ©Ÿ</option>
                        <option value="å‚³çµ±åƒµå±€">âš¡ å‚³çµ±åƒµå±€</option>
                        <option value="éƒµä»¶è¿½è¹¤">âš¡ éƒµä»¶è¿½è¹¤</option>
                    </optgroup>
                    <optgroup label="ğŸ§Š/âš ï¸ ç‰¹æ®Šç‹€æ…‹">
                        <option value="å†°å°æ–°åå–®">ğŸ§Š å†°å°åå–®</option>
                        <option value="ç€•æ­»åå–®">âš ï¸ ç€•æ­»åå–®</option>
                    </optgroup>
                </select>
                <button class="btn-reset" onclick="resetAllFilters()">é‡ç½® âœ•</button>
            </div>
        </div>
    </div>
    
    <div id="chartPanel" class="hidden-panel">
       <div class="chart-tabs">
         <button class="chart-tab-btn active" onclick="switchChart('status')">ğŸ·ï¸ 4å¤§ç‹€æ…‹</button>
         <button class="chart-tab-btn" onclick="switchChart('detail')">ğŸ” 12ç¨®ç‹€æ…‹</button>
         <button class="chart-tab-btn" onclick="switchChart('date')">ğŸ“… æ—¥æœŸ</button>
         <button class="chart-tab-btn" onclick="switchChart('source')">ğŸ“¢ ä¾†æº</button>
         <button class="chart-tab-btn" onclick="switchChart('area')">ğŸ™ï¸ åœ°å€</button>
         <button class="chart-tab-btn" onclick="switchChart('industry')">ğŸ­ ç”¢æ¥­</button>
       </div>
       <div class="chart-wrapper active" id="chart-status"><canvas id="canvas-status"></canvas></div>
       <div class="chart-wrapper" id="chart-detail"><canvas id="canvas-detail"></canvas></div>
       <div class="chart-wrapper" id="chart-date"><canvas id="canvas-date"></canvas></div>
       <div class="chart-wrapper" id="chart-source"><canvas id="canvas-source"></canvas></div>
       <div class="chart-wrapper" id="chart-area"><canvas id="canvas-area"></canvas></div>
       <div class="chart-wrapper" id="chart-industry"><canvas id="canvas-industry"></canvas></div>
    </div>

    <div class="filter-grid">
      <div class="filter-btn btn-ice active" id="f-ice" onclick="setFilter('ice')">
        ğŸ§Š å†°å° <span class="count-text" id="count-ice">0</span>
      </div>
      <div class="filter-btn btn-stall" id="f-stall" onclick="setFilter('stall')">
        âš¡ é€²è¡Œ <span class="count-text" id="count-stall">0</span>
      </div>
      <div class="filter-btn btn-hot" id="f-hot" onclick="setFilter('hot')">
        ğŸ”¥ è¿½è¹¤ <span class="count-text" id="count-hot">0</span>
      </div>
      <div class="filter-btn btn-dead" id="f-dead" onclick="setFilter('dead')">
        âš ï¸ ç€•æ­» <span class="count-text" id="count-dead">0</span>
      </div>
    </div>
  </div>

  <div id="storeList"></div>

  <a href="https://liff.line.me/YOUR_BACKEND_LIFF_ID" class="fab-switch">
    ğŸ¯ å‰å¾€å·²æ´¾ <i>â†’</i>
  </a>

  <div id="toast">å·²è¤‡è£½åº—å®¶è³‡æ–™ï¼</div>

<script>
  let allData = [];
  let currentFilter = 'ice';
  let sortDesc = true; 
  // ğŸŒŸ ç¢ºèªæ‰€æœ‰åœ–è¡¨åƒæ•¸éƒ½ä¿ç•™
  const charts = { status: null, detail: null, date: null, source: null, area: null, industry: null };

  function showSkeleton() {
    const list = document.getElementById('storeList');
    list.innerHTML = Array(3).fill(0).map(() => `
      <div class="skeleton-card">
        <div class="skeleton-box sk-title"></div>
        <div class="skeleton-box sk-detail"></div>
        <div class="sk-row"><div class="skeleton-box sk-btn"></div><div class="skeleton-box sk-btn"></div><div class="skeleton-box sk-btn"></div></div>
      </div>
    `).join('');
  }

  async function loadData() {
    showSkeleton();
    const gasUrl = "https://script.google.com/macros/s/AKfycbzIKHpWcWj0bOhaQsx-OynY5FVVorMJvTNON5PBOywj1q-Nd5EylLCSl-zTlFW9Rb5U/exec?action=getManagementList";
    try {
      const response = await fetch(gasUrl);
      const rawData = await response.json();
      
      // ğŸŒŸ ä¿ç•™ U æ¬„éæ¿¾é‚è¼¯
      allData = rawData.filter(item => !item.sales || item.sales.toString().trim() === "");

      checkDuplicates(allData);
      initDateSelect();
      initAreaSelect(); 
      initSourceSelect(); 
      initIndustrySelect(); 
      
      initAllCharts(); 
      doSort();
      render(); 
      enableDragScroll();
    } catch (e) {
      document.getElementById('storeList').innerHTML = `<div style="text-align:center; padding:20px; color:red;">é€£ç·šå¤±æ•—<br><small>${e.message}</small></div>`;
    }
  }

  // ğŸŒŸ é‡ç½®æ‰€æœ‰ç¯©é¸åŠŸèƒ½
  function resetAllFilters() {
    document.getElementById('dateSelect').value = 'all';
    document.getElementById('sourceSelect').value = 'all';
    document.getElementById('areaSelect').value = 'all';
    document.getElementById('industrySelect').value = 'all';
    document.getElementById('detailSelect').value = 'all';
    document.getElementById('searchInput').value = '';
    
    // é‡æ–°æ¸²æŸ“ï¼Œé€™æœƒè§¸ç™¼ updateFilterHint ä¸¦æ¸…ç©ºæŒ‰éˆ•æç¤º
    render();
  }

  // ğŸŒŸ æ›´æ–°ç¯©é¸æŒ‰éˆ•ä¸Šçš„æç¤ºæ–‡å­—
  function updateFilterHint() {
    const date = document.getElementById('dateSelect').value;
    const source = document.getElementById('sourceSelect').value;
    const area = document.getElementById('areaSelect').value;
    const industry = document.getElementById('industrySelect').value;
    const detail = document.getElementById('detailSelect').value;
    
    const hints = [];
    if (date !== 'all') hints.push(date === 'today' ? 'ä»Šå¤©' : date.split('/').pop() + 'æœˆ');
    if (source !== 'all') hints.push(source);
    if (area !== 'all') hints.push(area);
    if (industry !== 'all') hints.push(industry);
    if (detail !== 'all') hints.push(detail.substring(2,6)); // ç°¡çŸ­é¡¯ç¤ºç‹€æ…‹

    const hintEl = document.getElementById('filterSummary');
    const btn = document.getElementById('filterToggleBtn');

    if (hints.length > 0) {
        hintEl.innerText = hints.join(' / ');
        btn.classList.add('active'); // äº®èµ·æç¤ºæœ‰ç¯©é¸
        btn.style.background = '#f3f0ff';
        btn.style.color = '#764ba2';
    } else {
        hintEl.innerText = '';
        btn.classList.remove('active');
        btn.style.background = '';
        btn.style.color = '';
    }
  }

  function togglePanel(panelId) {
    const panel = document.getElementById(panelId);
    const btnId = panelId === 'filterPanel' ? 'filterToggleBtn' : 'chartToggleBtn';
    const btn = document.getElementById(btnId);

    if (panelId === 'filterPanel') {
        document.getElementById('chartPanel').style.display = 'none';
        document.getElementById('chartToggleBtn').classList.remove('active');
    } else {
        document.getElementById('filterPanel').style.display = 'none';
        document.getElementById('filterToggleBtn').classList.remove('active');
        // æ¢å¾©ç¯©é¸æŒ‰éˆ•çš„ç‹€æ…‹ (å¦‚æœæœ‰ç¯©é¸æ¢ä»¶)
        updateFilterHint();
    }

    if (panel.style.display === 'block') {
        panel.style.display = 'none';
        // å¦‚æœæ˜¯ç¯©é¸é¢æ¿é—œé–‰ï¼Œä»è¦æª¢æŸ¥æ˜¯å¦æœ‰ active ç‹€æ…‹ (é€é updateFilterHint)
        if (panelId === 'filterPanel') updateFilterHint();
        else btn.classList.remove('active');
    } else {
        panel.style.display = 'block';
        btn.classList.add('active');
        // æ‰“é–‹æ™‚å¼·åˆ¶ç§»é™¤ç‰¹æ®Šæ¨£å¼ï¼Œé¿å…èˆ‡ active class è¡çª
        if (panelId === 'filterPanel') {
             btn.style.background = ''; btn.style.color = '';
        }
    }
  }

  function enableDragScroll() {
    const slider = document.querySelector('.chart-tabs');
    let isDown = false; let startX; let scrollLeft;
    slider.addEventListener('mousedown', (e) => { isDown = true; slider.style.cursor = 'grabbing'; startX = e.pageX - slider.offsetLeft; scrollLeft = slider.scrollLeft; });
    slider.addEventListener('mouseleave', () => { isDown = false; slider.style.cursor = 'grab'; });
    slider.addEventListener('mouseup', () => { isDown = false; slider.style.cursor = 'grab'; });
    slider.addEventListener('mousemove', (e) => { if(!isDown) return; e.preventDefault(); const x = e.pageX - slider.offsetLeft; const walk = (x - startX) * 2; slider.scrollLeft = scrollLeft - walk; });
  }

  function switchChart(type) {
    document.querySelectorAll('.chart-tab-btn').forEach(b => b.classList.remove('active'));
    const map = { 'status':0, 'detail':1, 'date':2, 'source':3, 'area':4, 'industry':5 };
    const btns = document.querySelectorAll('.chart-tab-btn');
    if(btns[map[type]]) btns[map[type]].classList.add('active');
    document.querySelectorAll('.chart-wrapper').forEach(w => w.classList.remove('active'));
    document.getElementById('chart-' + type).classList.add('active');
  }

  function initAllCharts() {
    charts.status = new Chart(document.getElementById('canvas-status'), { type: 'doughnut', data: { labels: ['ğŸ§Š å†°å°', 'âš¡ é€²è¡Œ', 'ğŸ”¥ è¿½è¹¤', 'âš ï¸ ç€•æ­»'], datasets: [{ data: [], backgroundColor: ['#5D9CEC', '#FFCE54', '#ED5565', '#AAB2BD'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } } });
    
    // ğŸŒŸ ä¿ç•™ 12 è©³ç´°ç‹€æ…‹
    charts.detail = new Chart(document.getElementById('canvas-detail'), {
      type: 'doughnut',
      data: { labels: [], datasets: [{ data: [], backgroundColor: [] }] },
      options: { 
        responsive: true, maintainAspectRatio: false, 
        plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: {size:10} } } } 
      }
    });

    charts.date = new Chart(document.getElementById('canvas-date'), { type: 'line', data: { labels: [], datasets: [{ label: 'é€²å–®é‡', data: [], borderColor: '#36A2EB', backgroundColor: '#9BD0F5', tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false } });
    charts.source = new Chart(document.getElementById('canvas-source'), { type: 'pie', data: { labels: [], datasets: [{ data: [], backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#C9CBCF'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } } });
    charts.area = new Chart(document.getElementById('canvas-area'), { type: 'bar', data: { labels: [], datasets: [{ label: 'åœ°å€åˆ†ä½ˆ', data: [], backgroundColor: '#FF9F40' }] }, options: { responsive: true, maintainAspectRatio: false } });
    charts.industry = new Chart(document.getElementById('canvas-industry'), { type: 'bar', data: { labels: [], datasets: [{ label: 'ç”¢æ¥­ä½”æ¯”', data: [], backgroundColor: '#9966FF' }] }, options: { responsive: true, maintainAspectRatio: false } });
  }

  function updateAllCharts(filteredData) {
    if (!charts.status) return;
    const statusCounts = { ice: 0, stall: 0, hot: 0, dead: 0 };
    filteredData.forEach(i => { if (statusCounts.hasOwnProperty(i.type)) statusCounts[i.type]++; });
    charts.status.data.datasets[0].data = [statusCounts.ice, statusCounts.stall, statusCounts.hot, statusCounts.dead];
    charts.status.update();

    updateDetailChart(filteredData);

    const dateMap = {};
    filteredData.forEach(i => {
      if (!i.date) return;
      const parts = i.date.split('/'); 
      if (parts.length >= 2) { const key = `${parts[0]}/${parts[1]}`; dateMap[key] = (dateMap[key] || 0) + 1; }
    });
    const sortedDates = Object.keys(dateMap).sort((a,b) => new Date(a) - new Date(b));
    charts.date.data.labels = sortedDates;
    charts.date.data.datasets[0].data = sortedDates.map(d => dateMap[d]);
    charts.date.update();

    updateChartCount(charts.source, filteredData, 'source');
    updateChartCount(charts.area, filteredData, 'area', 10);
    updateChartCount(charts.industry, filteredData, 'industry', 10);
  }

  function updateDetailChart(data) {
    const map = {};
    data.forEach(i => { const k = i.detailLabel || 'æœªçŸ¥'; map[k] = (map[k] || 0) + 1; });
    let keys = Object.keys(map).sort((a,b) => map[b] - map[a]);
    
    const colors = keys.map(k => {
        if (k.includes('ğŸ”¥')) return '#ED5565'; 
        if (k.includes('âš¡')) return '#FFCE54'; 
        if (k.includes('ğŸ§Š')) return '#5D9CEC'; 
        if (k.includes('âš ï¸')) return '#AAB2BD'; 
        return '#808080';
    });

    charts.detail.data.labels = keys;
    charts.detail.data.datasets[0].data = keys.map(k => map[k]);
    charts.detail.data.datasets[0].backgroundColor = colors;
    charts.detail.update();
  }

  function updateChartCount(chart, data, field, limit = 0) {
    const map = {};
    data.forEach(i => { const key = i[field] || 'æœªçŸ¥'; map[key] = (map[key] || 0) + 1; });
    let keys = Object.keys(map).sort((a,b) => map[b] - map[a]);
    if (limit > 0 && keys.length > limit) keys = keys.slice(0, limit);
    chart.data.labels = keys;
    chart.data.datasets[0].data = keys.map(k => map[k]);
    chart.update();
  }

  function toggleSort() {
    sortDesc = !sortDesc;
    const btn = document.getElementById('sortToggleBtn');
    if (sortDesc) btn.classList.remove('active'); 
    else btn.classList.add('active'); 
    doSort();
    render();
  }

  function doSort() {
    allData.sort((a, b) => {
      const getVal = (dateStr) => {
        if (!dateStr) return 0;
        const match = dateStr.match(/(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})/);
        if (match) return new Date(match[1], match[2]-1, match[3]).getTime();
        return 0; 
      };
      const valA = getVal(a.date);
      const valB = getVal(b.date);
      return sortDesc ? (valB - valA) : (valA - valB);
    });
  }

  function copyCardInfo(key) {
    const item = allData.find(i => i.key === key);
    if (!item) return;
    const text = `ã€${item.industry || 'åº—å®¶'}ã€‘${item.area}${item.name}
ğŸ‘¤ è² è²¬äººï¼š${item.boss}
ğŸ“ é›»è©±ï¼š${item.phone}
ğŸ“ éœ€æ±‚ï¼š${item.req}
ğŸ“ ç‹€æ…‹ï¼š${item.detailLabel}`;
    navigator.clipboard.writeText(text).then(() => showToast());
  }

  function showToast() {
    const x = document.getElementById("toast");
    x.className = "show";
    setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
  }

  function checkDuplicates(data) {
    const lookup = { name: {}, boss: {}, lineId: {}, phone: {}, email: {} };
    data.forEach(item => {
        const add = (field, val) => {
            if (!val || String(val).trim() === "") return;
            const key = String(val).trim().toLowerCase(); 
            if (!lookup[field][key]) lookup[field][key] = [];
            lookup[field][key].push(item);
        };
        add('name', item.name); add('boss', item.boss); add('lineId', item.lineId); add('phone', item.phone); add('email', item.email);   
    });
    const fields = ['name', 'boss', 'lineId', 'phone', 'email'];
    const fieldNames = { name: 'åº—å', boss: 'è² è²¬äºº', lineId: 'LineID', phone: 'é›»è©±', email: 'Email' };
    fields.forEach(field => {
        Object.values(lookup[field]).forEach(list => {
            if (list.length > 1) { 
                list.forEach(item => {
                    item.isDup = true; 
                    if (!item.dupInfo) item.dupInfo = [];
                    const others = list.filter(other => other.key !== item.key);
                    const otherNames = others.map(o => `[${o.industry||'æœªåˆ†é¡'}] ${o.area}${o.name} (#${o.key})`);
                    const uniqueTargets = [...new Set(otherNames)]; 
                    item.dupInfo.push({ reason: fieldNames[field], targets: uniqueTargets });
                });
            }
        });
    });
  }

  function initDateSelect() {
    const select = document.getElementById('dateSelect');
    const yearSet = new Set();
    const monthSet = new Set();
    const today = new Date();
    const todayDisplay = `${today.getMonth()+1}/${today.getDate()}`;
    const todayOpt = document.createElement('option');
    todayOpt.value = 'today';
    todayOpt.text = `ğŸ“… ä»Šå¤© (${todayDisplay})`;
    todayOpt.style.color = 'blue';
    todayOpt.style.fontWeight = 'bold';
    select.appendChild(todayOpt);
    allData.forEach(d => {
      if (!d.date) return;
      const parts = d.date.split('/'); 
      if (parts.length >= 1) yearSet.add(parts[0]); 
      if (parts.length >= 2) monthSet.add(parts[0] + '/' + parts[1]);
    });
    const sortedYears = [...yearSet].sort((a, b) => b - a);
    sortedYears.forEach(year => {
      const yearOption = document.createElement('option');
      yearOption.value = year;
      yearOption.text = `ğŸ“‚ ${year}`;
      yearOption.style.fontWeight = "bold";
      select.appendChild(yearOption);
      const monthsInYear = [...monthSet]
        .filter(m => m.startsWith(year + '/'))
        .sort((a, b) => parseInt(b.split('/')[1]) - parseInt(a.split('/')[1]));
      monthsInYear.forEach(m => {
        const monOption = document.createElement('option');
        monOption.value = m;
        monOption.text = `ã€€${m.split('/')[1]}æœˆ`;
        select.appendChild(monOption);
      });
    });
  }
  function initAreaSelect() {
    const select = document.getElementById('areaSelect');
    const set = new Set();
    allData.forEach(i => { if (i.area && i.area.trim() !== "") set.add(i.area.trim()); });
    [...set].sort((a, b) => a.localeCompare(b, 'zh-Hant')).forEach(v => {
      const opt = document.createElement('option'); opt.value = v; opt.text = v; select.appendChild(opt);
    });
  }
  function initSourceSelect() {
    const select = document.getElementById('sourceSelect');
    const set = new Set();
    allData.forEach(i => { if (i.source) set.add(i.source.trim()); });
    [...set].sort().forEach(v => {
      const opt = document.createElement('option'); opt.value = v; opt.text = v; select.appendChild(opt);
    });
  }
  function initIndustrySelect() {
    const select = document.getElementById('industrySelect');
    const set = new Set();
    allData.forEach(i => { if (i.industry) set.add(i.industry.trim()); });
    [...set].sort().forEach(v => {
      const opt = document.createElement('option'); opt.value = v; opt.text = v; select.appendChild(opt);
    });
  }

  function calculateCounts(filteredData) {
      const mainCounts = { ice: 0, stall: 0, hot: 0, dead: 0 };
      const detailCounts = {}; 
      filteredData.forEach(item => {
          if (mainCounts.hasOwnProperty(item.type)) mainCounts[item.type]++;
          if (item.detailLabel) updateOptionCount(detailCounts, item.detailLabel);
      });
      document.getElementById('count-ice').innerText = `${mainCounts.ice}`;
      document.getElementById('count-stall').innerText = `${mainCounts.stall}`;
      document.getElementById('count-hot').innerText = `${mainCounts.hot}`;
      document.getElementById('count-dead').innerText = `${mainCounts.dead}`;
      
      refreshSelectOptions(detailCounts, filteredData.length);
      updateAllCharts(filteredData);
  }

  function updateOptionCount(counter, label) {
    const options = document.getElementById('detailSelect').querySelectorAll('option');
    options.forEach(opt => {
        if (opt.value !== 'all' && label.includes(opt.value)) {
            counter[opt.value] = (counter[opt.value] || 0) + 1;
        }
    });
  }
  function refreshSelectOptions(counts, total) {
    const select = document.getElementById('detailSelect');
    const options = select.querySelectorAll('option');
    options.forEach(opt => {
        if (opt.value === 'all') { opt.text = `ğŸ·ï¸ æ‰€æœ‰ç‹€æ…‹ (${total})`; return; }
        let baseText = opt.text.replace(/\s\(\d+\)$/, ''); 
        const count = counts[opt.value] || 0;
        opt.text = `${baseText} (${count})`;
    });
  }

  function getSourceStyle(source) {
    const s = String(source || ""); 
    if (s.includes("è¬›åº§ä»¶")) return { bg: "#6F4E37", label: "ğŸ”¥ " + s };
    if (s.includes("LINE@") || s.includes("å…¬å¸ä»¶")) return { bg: "#06C755", label: "ğŸ€ " + s };
    if (s.includes("Meta"))  return { bg: "#1877F2", label: "ğŸ”µ " + s };
    if (s.includes("Google")) return { bg: "#DB4437", label: "ğŸ”´ " + s };
    return { bg: "#808080", label: "ğŸ”” " + s };
  }

  function render() {
    // ğŸŒŸ æ¯æ¬¡æ¸²æŸ“éƒ½æª¢æŸ¥ç¯©é¸ç‹€æ…‹ï¼Œæ›´æ–°æç¤º
    updateFilterHint();

    const list = document.getElementById('storeList');
    const search = document.getElementById('searchInput').value.trim().toLowerCase();
    const selDate = document.getElementById('dateSelect').value;
    const selSource = document.getElementById('sourceSelect').value; 
    const selArea = document.getElementById('areaSelect').value; 
    const selIndustry = document.getElementById('industrySelect').value; 
    const selDetail = document.getElementById('detailSelect').value; 

    const commonFiltered = allData.filter(i => {
      const content = (
          (i.source || "") + (i.industry || "") + (i.area || "") + 
          (i.name || "") + (i.boss || "") + (i.lineId || "") + 
          (i.phone || "") + (i.email || "") + (i.req || "") + (i.date || "")
      ).toLowerCase();
      const matchSearch = (search === "") || content.includes(search);
      
      let matchDate = true;
      if (selDate === 'today') {
         const today = new Date();
         const todayStr = `${today.getFullYear()}/${today.getMonth()+1}/${today.getDate()}`;
         matchDate = i.date && i.date.startsWith(todayStr);
      } else if (selDate !== 'all') {
         if (!i.date) matchDate = false;
         else {
           const dP = i.date.split('/');
           const sP = selDate.split('/');
           matchDate = (sP.length===1) ? (dP[0]===sP[0]) : (dP[0]===sP[0] && dP[1]===sP[1]);
         }
      }
      let matchArea = (selArea === 'all') || (i.area === selArea);
      let matchSource = (selSource === 'all') || (i.source === selSource);
      let matchIndustry = (selIndustry === 'all') || (i.industry === selIndustry);
      let matchDetail = true;
      if (selDetail !== 'all') matchDetail = i.detailLabel && i.detailLabel.includes(selDetail);

      return matchSearch && matchDate && matchArea && matchSource && matchIndustry && matchDetail;
    });

    calculateCounts(commonFiltered);

    const finalFiltered = commonFiltered.filter(i => {
        const matchType = (search !== "") ? true : (i.type === currentFilter);
        return matchType;
    });

    if (finalFiltered.length === 0) {
      list.innerHTML = `<div style="text-align:center; padding:50px; color:#999;">ç„¡ç¬¦åˆåå–®</div>`;
      return;
    }

    list.innerHTML = finalFiltered.map(item => {
      const style = getSourceStyle(item.source);
      let dupAlert = '';
      if (item.isDup && item.dupInfo) {
          const reasonsHtml = item.dupInfo.map(info => 
              `<div style="margin-top:2px;">ğŸš¨ é‡è¤‡ï¼š${info.reason} <br><span style="color:#666;font-weight:normal;">â†³ èˆ‡ ${info.targets.join('ã€')}</span></div>`
          ).join('');
          dupAlert = `<div class="dup-alert">${reasonsHtml}</div>`;
      }
      return `
      <div class="store-card card-${item.type}">
        <div class="top-right-badge"><span class="badge-source" style="background:${style.bg}">${style.label}</span><br>${item.date}</div>
        <div class="detail-label">ğŸ“ ${item.detailLabel}</div>
        <div class="store-name">
            <span class="industry-text">ğŸ­ ${item.industry || 'æœªåˆ†é¡'}</span>ï½œ${item.area}${item.name} 
            <button class="btn-copy-text" onclick="copyCardInfo('${item.key}')">ğŸ“„</button>
        </div>
        <div style="margin-bottom:8px;"><span class="key-badge">#${item.key}</span></div>
        ${dupAlert}
        <div class="info-box">
          <div><b>ğŸ‘¤ è² è²¬äºº:</b> ${item.boss}</div>
          <div></div> 
          <div><b>ğŸ“ é›»è©±:</b> ${item.phone}</div>
          <div><b>ğŸ†” Line:</b> ${item.lineId}</div>
          <div class="req-text">ğŸ“ éœ€æ±‚: ${item.req}</div>
        </div>
        <div class="status-tags">
          <span class="tag ${item.isL?'tag-active':''}">åŠ Line: ${item.isL?'âœ…':'âŒ'}</span>
          <span class="tag ${item.isM?'tag-active':''}">å·²è®€: ${item.isM?'âœ…':'âŒ'}</span>
          <span class="tag ${item.isN?'tag-active':''}">å·²æ‰“: ${item.isN?'âœ…':'âŒ'}</span>
          <span class="tag ${item.isO?'tag-active':''}">æ’¥é€š: ${item.isO?'âœ…':'âŒ'}</span>
          <span class="tag ${item.isQ?'tag-active':''}">Email: ${item.isQ?'âœ…':'âŒ'}</span>
          <div class="call-log-box"><b>ğŸ“ é€šè©±:</b> ${item.rawP}</div>
        </div>
        <div class="action-grid">
          <a href="https://line.me/ti/p/~${item.lineId}" class="btn-tool btn-line"><i>ğŸ’¬</i>åŠ LINE</a>
          <a href="tel:${item.phone}" class="btn-tool btn-call"><i>ğŸ“</i>é›»è©±</a>
          <a href="mailto:${item.email}" class="btn-tool btn-email"><i>âœ‰ï¸</i>Email</a>
          <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.area + item.name)}" target="_blank" class="btn-tool btn-map"><i>ğŸ—ºï¸</i>åœ°åœ–</a>
          <div class="btn-tool" style="color:#d35400;" onclick="openUpdate('${item.key}')"><i>ğŸ“</i>é€²åº¦</div>
          <div class="btn-tool" style="color:#2980b9;" onclick="openDispatch('${item.key}')"><i>ğŸš€</i>æ´¾å–®</div>
        </div>
      </div>
    `}).join('');
  }

  function setFilter(t) {
    currentFilter = t;
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('f-'+t).classList.add('active');
    document.getElementById('searchInput').value = ""; 
    render();
  }
  function openUpdate(key) { alert("æ›´æ–° " + key); }
  function openDispatch(key) { alert("æ´¾å–® " + key); }
  window.onload = loadData;
</script>
</body>
</html>

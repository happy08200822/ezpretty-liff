<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ›´æ–°è¯çµ¡é€²åº¦</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f4f7f6; padding: 20px; }
    .card { border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .form-label { font-weight: bold; color: #333; }
    .btn-submit { width: 100%; padding: 12px; font-weight: bold; font-size: 18px; margin-top: 20px; }
    #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    /* å„ªåŒ–æ­·å²ç´€éŒ„é¡¯ç¤ºçš„å­—é«” */
    pre { font-family: "Microsoft JhengHei", sans-serif; }
  </style>
</head>
<body>

<div id="loadingOverlay">
  <div class="spinner-border text-primary" role="status"></div>
  <div class="mt-2 fw-bold text-secondary">æ­£åœ¨è®€å–èˆŠè³‡æ–™...</div>
</div>

<div class="container" style="max-width: 500px;">
  <div class="card p-4">
    <h4 class="text-center mb-3">ğŸ“ æ›´æ–°è¯çµ¡ç´€éŒ„</h4>
    <div id="displayStore" class="alert alert-info text-center fw-bold">...</div>

    <form id="progressForm">
      
      <div class="mb-3">
        <label class="form-label">1. åŠ  Line </label>
        <select id="addedLine" class="form-select">
          <option value="âŒ">âŒ å¦</option>
          <option value="âœ…">âœ… æ˜¯</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label">2. å·²è®€ </label>
        <select id="isRead" class="form-select">
          <option value="âŒ">âŒ å¦</option>
          <option value="âœ…">âœ… æ˜¯</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label">3. æ‰“é›»è©± </label>
        <select id="called" class="form-select">
          <option value="âŒ">âŒ å¦</option>
          <option value="âœ…">âœ… æ˜¯</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label">4. æ˜¯å¦æ’¥é€š </label>
        <select id="connected" class="form-select">
          <option value="âŒ">âŒ å¦</option>
          <option value="âœ…">âœ… æ˜¯</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label">5. æ’¥æ‰“æ¬¡æ•¸ç´€éŒ„ </label>
        <div class="input-group mb-2">
          <button class="btn btn-outline-secondary" type="button" onclick="adjustCount(-1)">-</button>
          <input type="number" id="callCount" class="form-control text-center" value="0" readonly style="font-weight: bold; font-size: 1.2rem;">
          <button class="btn btn-outline-primary" type="button" onclick="adjustCount(1)">+</button>
        </div>
        
        <div class="card bg-light">
          <div class="card-body p-2">
            <small class="text-muted fw-bold">ğŸ“œ è©³ç´°æ’¥æ‰“æ™‚é–“ï¼š</small>
            <pre id="historyDisplay" style="margin-bottom: 0; font-size: 0.85rem; color: #555; white-space: pre-wrap;">(è®€å–ä¸­...)</pre>
          </div>
        </div>
      </div>
      
      <div class="mb-3">
        <label class="form-label">6. è¯çµ¡ä¸åˆ°æ˜¯å¦å¯„ Email </label>
        <select id="emailed" class="form-select">
          <option value="âŒ">âŒ å¦</option>
          <option value="âœ…">âœ… æ˜¯</option>
        </select>
      </div>

      <button type="button" onclick="submitData()" class="btn btn-primary btn-submit">ğŸ’¾ å„²å­˜æ›´æ–°</button>
    </form>
  </div>
</div>

<script>
  // ğŸŒŸ GAS éƒ¨ç½²ç¶²å€
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbzIKHpWcWj0bOhaQsx-OynY5FVVorMJvTNON5PBOywj1q-Nd5EylLCSl-zTlFW9Rb5U/exec';
   
  // ğŸŒŸ LIFF ID
  const LIFF_ID = '2009117067-6y3yHx9o'; 

  let currentKey = "";
  let currentStore = "";

  async function main() {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) { liff.login(); return; }

    const params = new URLSearchParams(window.location.search);
    currentKey = params.get('key');
    currentStore = params.get('store');
    
    document.getElementById('displayStore').innerText = currentStore || "åº—å®¶è³‡æ–™";

    // ğŸš€ æ ¸å¿ƒï¼šåˆå§‹åŒ–æ™‚ï¼Œå…ˆå» GAS æŠ“èˆŠè³‡æ–™
    fetchDataFromGAS(currentKey);
  }

  // å¾ GAS è®€å–è³‡æ–™
  function fetchDataFromGAS(key) {
    fetch(`${GAS_URL}?action=getProgress&key=${key}`)
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          alert("è®€å–å¤±æ•—ï¼š" + data.error);
        } else {
          // è‡ªå‹•å¡«å…¥ä¸‹æ‹‰é¸å–®
          document.getElementById('addedLine').value = data.addedLine;
          document.getElementById('isRead').value = data.isRead;
          document.getElementById('called').value = data.called;
          document.getElementById('connected').value = data.connected;
          document.getElementById('emailed').value = data.emailed;
          
          // ğŸŒŸ è™•ç†è¨ˆæ•¸å™¨èˆ‡æ­·å²ç´€éŒ„
          document.getElementById('callCount').value = data.callCount;

          // åˆ¤æ–·æ˜¯å¦ç‚ºæ–°æ ¼å¼çš„æ­·å²ç´€éŒ„
          const historyEl = document.getElementById('historyDisplay');
          if (data.rawHistory && data.rawHistory.includes("å…±æ’¥æ‰“é")) {
             // å¦‚æœæ˜¯æ–°æ ¼å¼ï¼Œç›´æ¥é¡¯ç¤º
             historyEl.innerText = data.rawHistory; 
          } else {
             // å¦‚æœæ˜¯èˆŠæ ¼å¼æˆ–ç©ºçš„ï¼Œé¡¯ç¤ºæç¤º
             historyEl.innerText = data.rawHistory ? "(èˆŠè³‡æ–™: " + data.rawHistory + ")" : "(å°šç„¡ç´€éŒ„)";
          }
        }
        // é—œé–‰è®€å–é®ç½©
        document.getElementById('loadingOverlay').style.display = 'none';
      })
      .catch(err => {
        console.error(err);
        alert("é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
        document.getElementById('loadingOverlay').style.display = 'none';
      });
  }

  // èª¿æ•´è¨ˆæ•¸å™¨
  function adjustCount(delta) {
    const input = document.getElementById('callCount');
    let val = parseInt(input.value) || 0;
    val += delta;
    if (val < 0) val = 0;
    input.value = val;
  }

  // é€å‡ºè³‡æ–™
  function submitData() {
    // é–‹å•Ÿé®ç½©
    document.getElementById('loadingOverlay').innerHTML = '<div class="spinner-border text-light"></div><div class="mt-2 text-white">å„²å­˜ä¸­...</div>';
    document.getElementById('loadingOverlay').style.backgroundColor = "rgba(0,0,0,0.7)";
    document.getElementById('loadingOverlay').style.display = 'flex';

    const data = {
      action: 'receiveProgressData',
      key: currentKey,
      storeName: currentStore,
      addedLine: document.getElementById('addedLine').value,
      isRead: document.getElementById('isRead').value,
      called: document.getElementById('called').value,
      connected: document.getElementById('connected').value,
      callCount: document.getElementById('callCount').value,
      emailed: document.getElementById('emailed').value
    };

    fetch(GAS_URL, {
      method: 'POST',
      mode: 'no-cors',
      body: JSON.stringify(data)
    }).then(() => {
      // æˆåŠŸå¾Œé—œé–‰è¦–çª—
      setTimeout(() => liff.closeWindow(), 500);
    }).catch(err => {
      alert("å„²å­˜å¤±æ•—ï¼š" + err);
      document.getElementById('loadingOverlay').style.display = 'none';
    });
  }

  main();
</script>
</body>
</html>


<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ezPretty æˆ°æƒ…å®¤ (çµ‚æ¥µä¿®å¾©ç‰ˆ3)</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    /* --- 0. åŸºç¤è¨­å®š --- */
    body { font-family: -apple-system, "Noto Sans TC", sans-serif; background: #f4f6f9; padding: 0; margin: 0; padding-bottom: 100px; -webkit-tap-highlight-color: transparent; width: 100%; overflow-x: hidden; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* --- 1. Loading --- */
    #loadingOverlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.7); backdrop-filter: blur(5px); z-index: 20000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.3s; }
    .spinner { width: 40px; height: 40px; border: 4px solid #e0e0e0; border-top: 4px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
    .loading-text { font-size: 14px; color: #555; font-weight: bold; letter-spacing: 1px; animation: pulse 1.5s infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

    /* --- 2. HUD --- */
    #hud { 
        position: fixed; top: 15px; left: 50%; transform: translateX(-50%) translateY(-150%);
        width: 90%; max-width: 400px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white; border-radius: 50px; padding: 8px 15px 8px 20px;
        display: flex; align-items: center; justify-content: space-between;
        z-index: 11000; box-shadow: 0 8px 20px rgba(118, 75, 162, 0.4);
        font-size: 13px; font-weight: bold;
        transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    #hud.show { transform: translateX(-50%) translateY(0); }
    .hud-left { display: flex; align-items: center; gap: 8px; }
    .hud-icon { background: rgba(255,255,255,0.2); border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
    .hud-btn { background: white; color: #764ba2; border: none; padding: 6px 14px; border-radius: 20px; font-size: 12px; cursor: pointer; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    
    /* --- 3. Header --- */
    .header-sticky { position: sticky; top: 0; background: #f4f6f9; z-index: 100; box-shadow: 0 4px 6px -6px rgba(0,0,0,0.1); }
    .top-row-container { display: flex; align-items: center; gap: 8px; padding: 10px 10px 5px 10px; }
    .main-search-input { flex: 1; padding: 10px 12px; border-radius: 10px; border: 2px solid #e0e0e0; background: #fff; font-size: 14px; outline: none; transition: 0.3s; height: 42px; box-sizing: border-box; }
    .main-search-input:focus { border-color: #007bff; }
    .tool-group { display: flex; gap: 5px; }
    .tool-btn-small { width: 42px; height: 42px; border-radius: 10px; background: white; border: 1px solid #ddd; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 16px; color: #555; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: 0.2s; }
    .tool-btn-small:active { transform: scale(0.95); }
    .tool-btn-small.active-chart { background: #e3f2fd; color: #007bff; border-color: #007bff; }
    
    /* Tabs */
    .tabs-sticky-container { background: #f4f6f9; padding-bottom: 5px; border-bottom: 1px solid rgba(0,0,0,0.05); }
    .status-tabs { display: flex; overflow-x: auto; gap: 8px; padding: 0 10px; align-items: center; }
    .tab-btn { 
        flex: 0 0 auto; min-width: 68px; padding: 8px 12px; border-radius: 12px; 
        font-size: 11px; font-weight: bold; border: none; cursor: pointer; 
        background: #fff; color: #666; transition: 0.2s; 
        display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 3px; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); white-space: nowrap; 
    }
    .tab-btn span { font-size: 16px; line-height: 1; }
    .tab-btn .count { background: #f0f0f0; padding: 2px 8px; border-radius: 10px; font-size: 10px; color: #888; }
    .tab-btn.active { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); color: white; }
    
    /* Tabs Colors */
    .tab-all.active { background: #555; } .tab-all.active .count { background: rgba(255,255,255,0.3); color: white; }
    .tab-new.active { background: #00C851; } .tab-new.active .count { background: rgba(255,255,255,0.3); color: white; }
    .tab-unread.active { background: #ffbb33; color:#5c3a00; } .tab-unread.active .count { background: rgba(0,0,0,0.1); color: #5c3a00; }
    .tab-read.active { background: #ff4444; } .tab-read.active .count { background: rgba(255,255,255,0.3); color: white; }
    .tab-noline.active { background: #33b5e5; } .tab-noline.active .count { background: rgba(255,255,255,0.3); color: white; }
    .tab-dispatched.active { background: #9c27b0; } .tab-dispatched.active .count { background: rgba(255,255,255,0.3); color: white; }
    .tab-self.active { background: #00897b; } .tab-self.active .count { background: rgba(255,255,255,0.3); color: white; }
    .tab-invalid.active { background: #6c757d; } .tab-invalid.active .count { background: rgba(255,255,255,0.3); color: white; }

    .filter-trigger-row { padding: 5px 10px; display: flex; flex-direction: column; align-items: flex-start; gap: 5px; }
    .filter-toggle-btn { background: white; border: 1px solid #ddd; border-radius: 20px; color: #555; font-size: 12px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 6px; padding: 6px 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: 0.2s; }
    .filter-toggle-btn.active { background: #e3f2fd; color: #007bff; border-color: #007bff; }
    .filter-hint-row { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 5px; padding: 0 10px; }
    .filter-tag { font-size: 10px; background: #e7f5ff; color: #007bff; padding: 2px 8px; border-radius: 10px; border: 1px solid #b3d7ff; white-space: nowrap; }
    #salesFilterBar { display: none; white-space: nowrap; overflow-x: auto; padding: 0 10px 8px 10px; }
    .sales-pill { display: inline-flex; align-items: center; gap: 5px; padding: 4px 10px; margin-right: 5px; border-radius: 15px; font-size: 11px; color: #555; background: #e0e0e0; border: 1px solid #ccc; cursor: pointer; transition: 0.2s; }
    .sales-pill.active { background: #333; color: white; border-color: #000; }
    .sales-filter-dispatched .sales-pill.active { background: #9c27b0; border-color: #7b1fa2; }
    .sales-filter-self .sales-pill.active { background: #00897b; border-color: #00695c; }

    /* Expand Area */
    .expand-area { padding: 0 10px; }
    .hidden-panel { display: none; background: linear-gradient(180deg, #f0f7ff 0%, #ffffff 100%); border-radius: 0 0 16px 16px; padding: 20px 15px; margin-bottom: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); animation: slideDown 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); position: relative; overflow: hidden; }
    .hidden-panel::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #667eea, #764ba2); }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    .date-trigger-btn { width: 100%; padding: 12px 15px; background: #e3f2fd; border: none; border-radius: 12px; text-align: left; font-size: 14px; font-weight: bold; color: #1565c0; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; cursor: pointer; box-sizing: border-box; box-shadow: 0 4px 10px rgba(33, 150, 243, 0.15); transition: transform 0.1s; }
    .date-trigger-btn:active { transform: scale(0.98); }
    .filter-section-title { font-size: 12px; color: #666; font-weight: bold; margin-bottom: 8px; margin-top: 10px; display: flex; align-items: center; gap: 5px; }
    .chip-container { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 5px; }
    .chip { flex: 0 0 auto; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: bold; color: #555; background: #fff; border: 1px solid #dee2e6; cursor: pointer; transition: 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .chip.active { background: #e7f5ff; color: #007bff; border-color: #007bff; box-shadow: 0 2px 6px rgba(0,123,255,0.25); }
    .btn-reset-full { width: 100%; padding: 12px; background: #fff5f5; color: #c0392b; border: 1px solid #ffcdd2; border-radius: 12px; font-size: 13px; font-weight: bold; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 5px; transition: 0.2s; margin-top: 15px; }
    
    #chartPanel { background: linear-gradient(180deg, #ffffff 0%, #f8faff 100%); border-top: none; }
    .chart-header-title { text-align: center; font-size: 16px; font-weight: bold; color: #333; margin-bottom: 5px; padding-top: 5px; }
    .insight-row { display: flex; justify-content: space-around; margin-bottom: 10px; background: white; padding: 8px 5px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); align-items: center; }
    .insight-item { text-align: center; }
    .insight-val { font-size: 15px; font-weight: bold; color: #333; line-height: 1.2; }
    .insight-label { font-size: 10px; color: #888; }
    .insight-val.good { color: #00C851; }
    .insight-val.bad { color: #ff4444; }

    .chart-wrapper { position: relative; height: 320px; width: 100%; display: none; margin-top: 10px; }
    .chart-wrapper.active { display: block; }
    .chart-tabs { display: flex; gap: 8px; overflow-x: auto; margin-bottom: 10px; }
    .chart-tab-btn { padding: 6px 14px; border-radius: 20px; background: #f1f3f5; color: #555; font-size: 12px; font-weight: bold; border: none; white-space: nowrap; cursor: pointer; }
    .chart-tab-btn.active { background: #007bff; color: white; }
    .time-toggles-container { display: flex; justify-content: flex-end; padding-right: 10px; margin-bottom: 5px; }
    .time-toggles { display: flex; background: #e9ecef; border-radius: 20px; padding: 3px; }
    .time-btn { padding: 4px 12px; border: none; background: transparent; font-size: 11px; border-radius: 15px; cursor: pointer; color: #666; font-weight: bold; transition: 0.2s; }
    .time-btn.active { background: white; color: #007bff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

    /* List & Cards */
    .list-container { padding: 10px; }
    .store-card { background: white; border-radius: 16px; padding: 16px; margin-bottom: 16px; border-top: 6px solid #ccc; position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: border-color 0.3s; }
    .store-card.idle-warning { border: 2px solid #ff4444; animation: redPulse 2s infinite; }
    .idle-tag { position: absolute; top: -10px; right: 10px; background: #ff4444; color: #fff; font-size: 10px; font-weight: bold; padding: 2px 8px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 5; }
    @keyframes redPulse { 0% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(255, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0); } }

    .card-new { border-top-color: #00C851; }
    .card-unread { border-top-color: #ffbb33; }
    .card-read { border-top-color: #ff4444; }
    .card-noline { border-top-color: #33b5e5; }
    .card-invalid { border-top-color: #6c757d; opacity: 0.7; }
    .card-dispatched { border-top-color: #9c27b0; } 
    .card-self { border-top-color: #00897b; } 
    
    .top-right-badge { 
        position: absolute; top: 12px; right: 12px; text-align: right; font-size: 11px; color: #888; line-height: 1.4; 
        max-width: 140px; overflow: hidden; 
    }
    .badge-source { 
        font-weight: bold; padding: 2px 6px; border-radius: 4px; margin-bottom: 3px; display: inline-block; color: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2); 
        max-width: 100%; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; vertical-align: bottom;
    }
    
    .action-alert { background: #fff5f5; border: 1px dashed #ff6b6b; color: #c0392b; padding: 8px 12px; border-radius: 8px; font-size: 14px; font-weight: bold; margin: 8px 0; display: flex; align-items: center; gap: 6px; }
    .action-alert i { font-style: normal; font-size: 16px; }
    .dup-alert { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; font-size: 11px; padding: 8px; border-radius: 8px; margin-bottom: 8px; }
    
    .store-name { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 4px; padding-right: 80px; line-height: 1.4; display: flex; align-items: center; flex-wrap: wrap; }
    .industry-text { font-size: 12px; background: #eee; color: #555; padding: 2px 6px; border-radius: 4px; margin-right: 5px; font-weight: normal; max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: inline-block; vertical-align: bottom; }
    
    .w-status-badge { font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: bold; color: white; margin-left: 6px; display: inline-block; vertical-align: middle; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .w-red { background: #c0392b; }
    .w-green { background: #27ae60; }
    .w-orange { background: #e67e22; }
    .w-gray { background: #7f8c8d; }

    .btn-copy-text { background: none; border: none; font-size: 14px; cursor: pointer; margin-left: 5px; opacity: 0.6; pointer-events: auto; }
    .key-badge { font-size: 11px; color: #666; background: #f0f0f0; padding: 2px 6px; border-radius: 4px; margin-left: 5px; vertical-align: middle; }
    .info-box { display: flex; flex-direction: column; gap: 4px; font-size: 13px; color: #555; background: #f8faff; padding: 10px; border-radius: 12px; border: 1px solid #eef2f7; margin-bottom: 8px; }
    .req-text { color: #d35400; font-weight: bold; border-top: 1px dashed #ddd; padding-top: 6px; margin-top: 4px; line-height: 1.4; }
    .status-checks { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 5px; }
    .check-pill { font-size: 10px; padding: 2px 6px; border-radius: 10px; background: #f0f0f0; color: #aaa; border: 1px solid #ddd; }
    .check-pill.on { background: #e3f2fd; color: #1565c0; border-color: #90caf9; font-weight: bold; }
    .update-badge { background: #e74c3c; color: white; border-radius: 10px; padding: 0px 5px; font-size: 10px; margin-left: 2px; height: 16px; line-height: 16px; display: inline-block; vertical-align: text-top; }
    
    .record-section { margin-bottom: 8px; }
    .record-label { font-size: 12px; font-weight: bold; color: #555; margin-bottom: 4px; display: flex; align-items: center; gap: 5px; }
    .status-badge { font-size: 10px; padding: 2px 8px; border-radius: 10px; font-weight: bold; color: white; }
    .status-badge.good { background: #007bff; }
    .status-badge.bad { background: #dc3545; }
    
    .record-box { font-size: 11px; color: #666; background: #f8f9fa; padding: 8px 10px; border-radius: 8px; white-space: pre-wrap; line-height: 1.5; max-height: 4.5em; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; border-left: 3px solid #ddd; }

    .action-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px; }
    .btn-ghost { display: flex; align-items: center; justify-content: center; padding: 8px 0; border-radius: 8px; border: 1px solid #e0e0e0; background: white; color: #666; font-size: 12px; font-weight: bold; text-decoration: none; transition: 0.2s; gap: 4px; }
    .btn-ghost:active { background: #f5f5f5; }
    .btn-orange { background: #ff9800; color: white; border: none; box-shadow: 0 2px 5px rgba(255, 152, 0, 0.3); }
    .btn-purple { background: #9c27b0; color: white; border: none; box-shadow: 0 2px 5px rgba(156, 39, 176, 0.3); }
    .btn-tool { display: flex; align-items: center; justify-content: center; padding: 8px 0; border-radius: 8px; font-size: 12px; font-weight: bold; cursor: pointer; text-decoration: none; gap: 4px; }

    /* Modals */
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9998; display: none; opacity: 0; transition: opacity 0.3s; }
    .bottom-sheet { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-radius: 20px 20px 0 0; z-index: 10000; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.9, 0.3, 1); padding: 20px; padding-bottom: 40px; display: flex; flex-direction: column; max-height: 90vh; overflow-y: auto; }
    .bottom-sheet.show { transform: translateY(0); }
    .sheet-header { font-size: 18px; font-weight: bold; text-align: center; margin-bottom: 15px; position: relative; color: #333; }
    .sheet-close { position: absolute; right: 0; top: -5px; background: none; border: none; font-size: 24px; color: #999; padding: 0 10px; cursor: pointer; }

    /* Update Modal */
    .update-chip-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
    .update-chip { padding: 6px 12px; background: #f1f3f5; border-radius: 15px; font-size: 12px; color: #555; border: 1px solid #ddd; cursor: pointer; display: flex; align-items: center; gap: 4px; }
    .update-chip.call-chip { background: #e3f2fd; color: #0288d1; border-color: #b3e5fc; font-weight: bold; }
    .update-chip.line-chip { background: #e8f5e9; color: #2e7d32; border-color: #c8e6c9; font-weight: bold; }
    
    .status-group-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    .status-btn-big { padding: 12px; border-radius: 12px; border: 2px solid transparent; font-size: 14px; font-weight: bold; cursor: pointer; text-align: center; transition: 0.2s; }
    .status-btn-big.contact { background: #e3f2fd; color: #007bff; border-color: #b3d7ff; }
    .status-btn-big.contact.active { background: #007bff; color: white; border-color: #0056b3; box-shadow: 0 4px 10px rgba(0,123,255,0.3); }
    .status-btn-big.reject { background: #ffebee; color: #c62828; border-color: #ffcdd2; }
    .status-btn-big.reject.active { background: #c62828; color: white; border-color: #b71c1c; box-shadow: 0 4px 10px rgba(198,40,40,0.3); }

    .update-textarea { width: 100%; height: 160px; border: 1px solid #ddd; border-radius: 12px; padding: 10px; font-size: 14px; resize: none; margin-bottom: 15px; background: #fafafa; font-family: monospace; line-height: 1.5; box-sizing: border-box; }
    .toggle-row { display: flex; justify-content: space-between; margin-bottom: 10px; background: white; padding: 5px 0; border-radius: 12px; }
    .toggle-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; padding: 10px 5px; border-radius: 10px; transition: 0.2s; margin: 0 3px; background: #f0f0f0; color: #999; }
    .toggle-icon { font-size: 20px; }
    .toggle-label { font-size: 10px; font-weight: bold; }
    .toggle-item.active.tog-L { background: #06C755; color: white; }
    .toggle-item.active.tog-M { background: #333; color: white; }
    .toggle-item.active.tog-N { background: #007bff; color: white; }
    .toggle-item.active.tog-O { background: #ff9800; color: white; }
    .toggle-item.active.tog-Q { background: #c0392b; color: white; }

    /* Dispatch */
    .dispatch-step { display: none; }
    .dispatch-step.active { display: block; }
    .store-name-large { font-size: 22px; font-weight: bold; color: #333; text-align: center; margin: 20px 0; }
    .copy-btn-large { width: 100%; padding: 15px; background: #e3f2fd; color: #1565c0; border: 1px dashed #1565c0; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; margin-bottom: 20px; display: flex; justify-content: center; align-items: center; gap: 8px; }
    .sales-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
    .sales-tile { aspect-ratio: 1.5; border-radius: 12px; background: white; border: 2px solid #eee; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 14px; font-weight: bold; color: #555; position: relative; transition: 0.2s; }
    .sales-tile.selected { border-color: #9c27b0; background: #f3e5f5; color: #9c27b0; }
    .sales-check { position: absolute; top: 5px; right: 5px; font-size: 12px; display: none; }
    .sales-tile.selected .sales-check { display: block; }
    .input-field { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 15px; font-size: 14px; box-sizing: border-box; }
    .sheet-confirm-btn { width: 100%; padding: 14px; background: linear-gradient(135deg, #007bff, #0056b3); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; }

    /* Date Picker */
    .quick-date-grid-row1 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 8px; }
    .quick-date-grid-row2 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 20px; }
    .quick-btn { padding: 10px 2px; background: #f8f9fa; border: 1px solid #eee; border-radius: 10px; font-size: 12px; color: #555; font-weight: bold; text-align: center; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .quick-btn:active { background: #e9ecef; color: #007bff; border-color: #b3d7ff; }
    .date-range-inputs { display: flex; gap: 10px; align-items: center; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 12px; }
    .date-input-group { flex: 1; display: flex; flex-direction: column; gap: 5px; }
    .date-input-group label { font-size: 11px; color: #666; font-weight: bold; }
    .date-native-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 8px; font-size: 15px; box-sizing: border-box; background: #fff; }

    .fab-switch { position: fixed; bottom: 25px; right: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 24px; border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); font-size: 14px; font-weight: bold; text-decoration: none; display: flex; align-items: center; gap: 8px; z-index: 1000; transition: transform 0.2s; }
    #toast { visibility: hidden; min-width: 200px; background-color: #333; color: #fff; text-align: center; border-radius: 20px; padding: 10px; position: fixed; z-index: 10001; left: 50%; bottom: 100px; transform: translateX(-50%); font-size: 13px; }
    #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }

    /* --- ğŸŒŸ æ–°å¢ï¼šé–‹ç™¼å°å¼•å°å°ˆç”¨æ¨£å¼ --- */
    .sheet-header-box { padding: 15px 20px; border-bottom: 1px solid #eee; text-align: center; position: relative; width: 100%; box-sizing: border-box; }
    .current-store-title { font-size: 20px; font-weight: 900; color: #2c3e50; margin: 0; }
    .sheet-close-btn { position: absolute; right: 15px; top: 15px; font-size: 24px; color: #ccc; cursor: pointer; border: none; background: none; }

    .guide-scroll-area { padding: 20px; max-height: 80vh; overflow-y: auto; box-sizing: border-box; width: 100%; }
    .guide-container { display: flex; flex-direction: column; gap: 20px; width: 100%; }
    
    .step-box { display: flex; gap: 15px; position: relative; width: 100%; box-sizing: border-box; }
    .step-box:not(:last-child)::after { content: ''; position: absolute; left: 14px; top: 35px; width: 2px; height: calc(100% - 15px); background: #007bff; z-index: 1; }
    .step-box.done:not(:last-child)::after { background: #e0e0e0; }

    .step-num { min-width: 30px; height: 30px; border-radius: 50%; background: #007bff; color: white; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; z-index: 2; }
    .step-box.done .step-num { background: #dcdde1; color: #7f8c8d; }
    .step-content { flex: 1; min-width: 0; width: 100%; }
    .step-title { font-size: 15px; font-weight: bold; color: #555; margin-bottom: 10px; display: block; }

    .btn-main { display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: bold; color: #fff; background: #007bff; padding: 14px; border-radius: 12px; cursor: pointer; text-decoration: none; width: 100%; border: none; box-sizing: border-box; }
    .tag-btn-group { display: flex; gap: 10px; width: 100%; }
    .tag-btn { flex: 1; padding: 12px; background: #fff; border: 1.5px solid #dee2e6; border-radius: 10px; font-weight: bold; cursor: pointer; text-align: center; }
    .card-img-box { width: 100%; display: block; }
    .card-img { width: 100%; max-width: 350px; height: auto; border-radius: 10px; border: 1px solid #ddd; cursor: grab; }

    .script-tabs { display: flex; background: #eee; border-radius: 10px; padding: 4px; margin-bottom: 12px; gap: 4px; width: 100%; }
    .tab-btn { flex: 1; padding: 10px; border: none; border-radius: 8px; font-size: 13px; font-weight: bold; cursor: pointer; color: #777; }
    .tab-btn.active { background: #fff; color: #007bff; }
    .staff-row { display: none; gap: 8px; margin-bottom: 10px; justify-content: flex-end; }
    .staff-chip { padding: 5px 15px; border-radius: 20px; font-size: 12px; border: 1px solid #007bff; color: #007bff; cursor: pointer; }
    .staff-chip.active { background: #007bff; color: white; }

    .line-textarea { width: 100%; height: 130px; border: 1.5px solid #eee; border-radius: 15px; padding: 15px; font-size: 15px; margin-bottom: 15px; box-sizing: border-box; background: #fafafa; resize: none; }
    .btn-final-copy { width: 100%; padding: 18px; border-radius: 15px; border: none; background: #00b894; color: white; font-size: 17px; font-weight: bold; cursor: pointer; box-sizing: border-box; }
    .btn-final-copy.copied { background: #2f3640; }

    /* --- ğŸŒŸ æœ€çµ‚ç‰ˆï¼šæŒ‰éˆ•é¸ä¸­æ™‚ï¼Œè®Šæˆå°æ‡‰é¡è‰² + åŒè‰²ç³»ç™¼å…‰ --- */

    /* 1. åŸºç¤å‹•æ•ˆ (æ”¾å¤§ã€ä¸Šæµ®ã€ç™½æ¡†) */
    .tab-btn.active {
        transform: scale(1.1) translateY(-2px) !important; /* æ”¾å¤§ä¸Šæµ® */
        border: 2px solid #fff !important; /* åŠ ç™½æ¡†è®“é¡è‰²æ›´è·³ */
        z-index: 10;
        color: white !important; /* æ–‡å­—è®Šç™½ */
    }

    /* 2. å€‹åˆ¥æŒ‡å®šé¡è‰²èˆ‡ç™¼å…‰é™°å½± (Glow Effect) */
    
    /* ğŸ“‚ å…¨éƒ¨ (æ·±ç°) */
    .tab-all.active { 
        background: #555 !important; 
        box-shadow: 0 4px 15px rgba(85, 85, 85, 0.5) !important; 
    }

    /* ğŸ†• æ–°å–® (ç¶ è‰²) */
    .tab-new.active { 
        background: #00C851 !important; 
        box-shadow: 0 4px 15px rgba(0, 200, 81, 0.5) !important; 
    }

    /* ğŸ“² æœªè®€ (é»ƒè‰² - å­—ç¶­æŒæ·±è‰²æ‰çœ‹å¾—åˆ°) */
    .tab-unread.active { 
        background: #ffbb33 !important; 
        color: #5c3a00 !important; /* ç‰¹ä¾‹ï¼šé»ƒåº•é…æ·±å’–å•¡å­— */
        box-shadow: 0 4px 15px rgba(255, 187, 51, 0.6) !important; 
    }

    /* ğŸ‘€ å·²è®€ (ç´…è‰²) */
    .tab-read.active { 
        background: #ff4444 !important; 
        box-shadow: 0 4px 15px rgba(255, 68, 68, 0.5) !important; 
    }

    /* ğŸ“µ æ²’Line (è—è‰²) */
    .tab-noline.active { 
        background: #33b5e5 !important; 
        box-shadow: 0 4px 15px rgba(51, 181, 229, 0.5) !important; 
    }

    /* ğŸš€ å·²æ´¾å–® (ç´«è‰²) */
    .tab-dispatched.active { 
        background: #9c27b0 !important; 
        box-shadow: 0 4px 15px rgba(156, 39, 176, 0.5) !important; 
    }

    /* ğŸ’ª è‡ªé–‹ä»¶ (æ¹–æ°´ç¶ ) */
    .tab-self.active { 
        background: #00897b !important; 
        box-shadow: 0 4px 15px rgba(0, 137, 123, 0.5) !important; 
    }

    /* ğŸ’€ ç„¡æ•ˆ (ç°è‰²) */
    .tab-invalid.active { 
        background: #6c757d !important; 
        box-shadow: 0 4px 15px rgba(108, 117, 125, 0.5) !important; 
    }
    
    /* --- ğŸŒŸ ä¿®æ­£ï¼šæŒ‰éˆ•è¢«é»æ“Šå¾Œï¼Œæ•¸å­—æ¶ˆå¤±çš„å•é¡Œ --- */
    /* å¼·åˆ¶æ‰€æœ‰ã€Œè¢«é¸ä¸­ (active)ã€çš„æŒ‰éˆ•ï¼Œæ•¸å­—ä¸€å¾‹è®Šç‚ºã€Œç™½åº•é»‘å­—ã€ */
    .tab-btn.active .count {
        background-color: #ffffff !important;  /* æ•¸å­—èƒŒæ™¯æ”¹ç´”ç™½ */
        color: #000000 !important;             /* æ•¸å­—æ–‡å­—æ”¹ç´”é»‘ */
        opacity: 1 !important;                 /* ä¸é€æ˜ */
        display: inline-block !important;      /* ç¢ºä¿é¡¯ç¤º */
        box-shadow: 0 1px 3px rgba(0,0,0,0.3) !important; /* åŠ é»é™°å½±æ›´æ¸…æ¥š */
    }

  </style>
</head>
<body>

  <div id="loadingOverlay"><div class="spinner"></div><div class="loading-text">è³‡æ–™è®€å–ä¸­...</div></div>

  <div id="hud">
      <div class="hud-left">
          <span class="hud-icon">ğŸ’¡</span>
          <span id="hudText">èŠå®Œè¨˜å¾—å›ä¾†æ›´æ–°é€²åº¦ï¼</span>
      </div>
      <div>
          <button class="hud-btn" id="hudActionBtn" onclick="handleHudClick()">ç«‹åˆ»æ›´æ–°</button>
          <span style="font-size:18px; cursor:pointer; color:rgba(255,255,255,0.7); margin-left:10px;" onclick="closeHUD()">âœ•</span>
      </div>
  </div>

  <div class="header-sticky">
    <div class="top-row-container">
        <input type="text" class="main-search-input" id="searchInput" placeholder="ğŸ” æœå°‹..." oninput="render()">
        <div class="tool-group">
            <div class="tool-btn-small" id="chartToggleBtn" onclick="togglePanel('chartPanel')"><span>ğŸ“Š</span></div>
            <div class="tool-btn-small" id="sortToggleBtn" onclick="toggleSort()"><span>â‡…</span></div>
            <div class="tool-btn-small" onclick="loadData()"><span>ğŸ”„</span></div>
        </div>
    </div>
    <div class="tabs-sticky-container">
        <div class="status-tabs no-scrollbar" id="statusTabs">
            <button class="tab-btn tab-all" onclick="setTab('all')"><span>ğŸ“‚</span>å…¨éƒ¨<div class="count" id="cnt-all">0</div></button>
            <button class="tab-btn tab-new active" onclick="setTab('new')"><span>ğŸ†•</span>æ–°å–®<div class="count" id="cnt-new">0</div></button>
            <button class="tab-btn tab-unread" onclick="setTab('unread')"><span>ğŸ“²</span>æœªè®€<div class="count" id="cnt-unread">0</div></button>
            <button class="tab-btn tab-read" onclick="setTab('read')"><span>ğŸ‘€</span>å·²è®€<div class="count" id="cnt-read">0</div></button>
            <button class="tab-btn tab-noline" onclick="setTab('noline')"><span>ğŸ“µ</span>æ²’Line<div class="count" id="cnt-noline">0</div></button>
            <button class="tab-btn tab-dispatched" onclick="setTab('dispatched')"><span>ğŸš€</span>å·²æ´¾å–®<div class="count" id="cnt-dispatched">0</div></button>
            <button class="tab-btn tab-self" onclick="setTab('self')"><span>ğŸ’ª</span>è‡ªé–‹ä»¶<div class="count" id="cnt-self">0</div></button>
            <button class="tab-btn tab-invalid" onclick="setTab('invalid')"><span>ğŸ’€</span>ç„¡æ•ˆ<div class="count" id="cnt-invalid">0</div></button>
        </div>
        <div class="filter-trigger-row">
            <button class="filter-toggle-btn" id="filterToggleBtn" onclick="togglePanel('filterPanel')"><span style="font-size:16px;">ğŸŒªï¸</span> ç¯©é¸æ¢ä»¶</button>
        </div>
        <div class="filter-hint-row" id="filterHintRow"></div>
        <div id="salesFilterBar" class="no-scrollbar"></div>
    </div>
  </div>

  <div class="expand-area">
      <div id="filterPanel" class="hidden-panel">
          <button class="date-trigger-btn" onclick="openDateSheet()"><div>ğŸ“… æ—¥æœŸå€é–“</div><span id="dateDisplay">å…¨éƒ¨æ—¥æœŸ</span></button>
          <div class="filter-section-title">ğŸ“¢ ä¾†æº (å¯è¤‡é¸)</div><div class="chip-container no-scrollbar" id="sourceChips"></div>
          <div class="filter-section-title">ğŸ™ï¸ åœ°å€ (å¯è¤‡é¸)</div><div class="chip-container no-scrollbar" id="areaChips"></div>
          <div class="filter-section-title">ğŸ­ ç”¢æ¥­ (å¯è¤‡é¸)</div><div class="chip-container no-scrollbar" id="industryChips"></div>
          <div style="text-align:center;"><button class="btn-reset-full" onclick="resetAllFilters()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æ¢ä»¶</button></div>
      </div>
      
      <div id="chartPanel" class="hidden-panel">
         <div class="chart-header-title">ğŸ“ˆ ç‡Ÿé‹æ•¸æ“šå ±è¡¨</div>
         <div class="insight-row">
             <div class="insight-item"><div class="insight-val" id="val-conversion">0%</div><div class="insight-label">ğŸš€ æ´¾å–®è½‰åŒ–ç‡</div></div>
             <div class="insight-item"><div class="insight-val" id="val-junk">0%</div><div class="insight-label">ğŸ—‘ï¸ åƒåœ¾å–®ç‡</div></div>
         </div>
         <div class="chart-tabs no-scrollbar">
           <button class="chart-tab-btn active" onclick="switchChart('status')">ğŸ·ï¸ ç‹€æ…‹</button>
           <button class="chart-tab-btn" onclick="switchChart('sales')">ğŸ† æ’è¡Œ</button>
           <button class="chart-tab-btn" onclick="switchChart('date')">ğŸ“… èµ°å‹¢</button>
           <button class="chart-tab-btn" onclick="switchChart('source')">ğŸ“¢ ä¾†æº</button>
         </div>
         <div class="chart-wrapper active" id="chart-status"><canvas id="canvas-status"></canvas></div>
         <div class="chart-wrapper" id="chart-sales"><canvas id="canvas-sales"></canvas></div>
         <div class="chart-wrapper" id="chart-date">
             <div class="time-toggles-container"><div class="time-toggles"><button class="time-btn" onclick="setDateGrain('month', this)">æœˆ</button><button class="time-btn" onclick="setDateGrain('week', this)">é€±</button><button class="time-btn active" onclick="setDateGrain('day', this)">æ—¥</button></div></div>
             <canvas id="canvas-date"></canvas>
         </div>
         <div class="chart-wrapper" id="chart-source"><canvas id="canvas-source"></canvas></div>
         <div class="chart-wrapper" id="chart-area"><canvas id="canvas-area"></canvas></div>
      </div>
  </div>

  <div class="list-container"><div id="storeList"></div></div>
  <a href="https://liff.line.me/YOUR_BACKEND_LIFF_ID" class="fab-switch">ğŸ¯ å‰å¾€å¾Œæ®µ <i>â†’</i></a>
  <div id="toast">å·²è¤‡è£½åº—å®¶è³‡æ–™ï¼</div>

  <div class="modal-overlay" id="updateModalOverlay" onclick="closeUpdateModal()"></div>
  <div class="bottom-sheet" id="updateModal">
      <div class="sheet-header"><span id="updateModalTitle">æ›´æ–°é€²åº¦</span> <button class="sheet-close" onclick="closeUpdateModal()">âœ•</button></div>
      
      <div class="filter-section-title" style="font-size:14px; color:#333; margin-top:0;">ğŸ“Œ é€™å¼µå–®é‚„æœ‰æ•‘å—ï¼Ÿ</div>
      <div class="status-group-grid">
          <div class="status-btn-big contact" onclick="selectStatus(this, 'è¯çµ¡ä¸­')">ğŸ“ è¯çµ¡ä¸­</div>
          <div class="status-btn-big reject" onclick="selectStatus(this, 'æ‹’çµ•')">ğŸš« æ‹’çµ• / ç„¡æ•ˆ</div>
      </div>

      <div class="toggle-row">
          <div class="toggle-item tog-L" id="tog-L" onclick="toggleStatus('L')"><div class="toggle-icon">ğŸ’¬</div><div class="toggle-label">åŠ Line</div></div>
          <div class="toggle-item tog-M" id="tog-M" onclick="toggleStatus('M')"><div class="toggle-icon">ğŸ‘€</div><div class="toggle-label">å·²è®€</div></div>
          <div class="toggle-item tog-N" id="tog-N" onclick="toggleStatus('N')"><div class="toggle-icon">ğŸ“</div><div class="toggle-label">æ’¥é›»è©±</div></div>
          <div class="toggle-item tog-O" id="tog-O" onclick="toggleStatus('O')"><div class="toggle-icon">ğŸ—£ï¸</div><div class="toggle-label">æ’¥é€š</div></div>
          <div class="toggle-item tog-Q" id="tog-Q" onclick="toggleStatus('Q')"><div class="toggle-icon">âœ‰ï¸</div><div class="toggle-label">Email</div></div>
      </div>

      <div class="filter-section-title">å¿«é€Ÿç´€éŒ„ (è¨˜æ†¶æŒ‰éˆ•)</div>
      <div class="update-chip-container">
          <div class="update-chip line-chip" onclick="insertNote('line')">ğŸ’¬ å‚³Lineæ™‚é–“ <span id="lbl-line-count">(0)</span></div>
          <div class="update-chip call-chip" onclick="insertNote('call')">ğŸ“ æ’¥æ‰“æ™‚é–“ <span id="lbl-call-count">(0)</span></div>
          <div class="update-chip" onclick="insertNote('ç„¡äººæ¥è½')">ç„¡äººæ¥è½</div>
          <div class="update-chip" onclick="insertNote('å¿™ç¢Œä¸­')">å¿™ç¢Œä¸­</div>
          <div class="update-chip" onclick="insertNote('è«‹å¯„è³‡æ–™')">è«‹å¯„è³‡æ–™</div>
          <div class="update-chip" onclick="insertNote('å·²ç´„æ™‚é–“')">å·²ç´„æ™‚é–“</div>
      </div>

      <textarea id="updateNote" class="update-textarea"></textarea>
      <button class="sheet-confirm-btn" onclick="saveUpdate()">ğŸ’¾ å„²å­˜æ›´æ–°</button>
  </div>

  <div class="modal-overlay" id="dispatchModalOverlay"></div>
  <div class="bottom-sheet" id="dispatchModal">
      <div class="sheet-header">ğŸš€ æº–å‚™æ´¾å–® <button class="sheet-close" onclick="closeDispatchModal()">âœ•</button></div>
      <div id="dispatchStep1" class="dispatch-step active">
          <div class="store-name-large" id="dispatchStoreName"></div>
          <button class="copy-btn-large" onclick="copyStoreAndNext()">ğŸ“‹ è¤‡è£½åº—å (å»å»ºç¾¤çµ„)</button>
          <p style="text-align:center; color:#666; font-size:12px;">è«‹å…ˆåˆ° LINE å»ºç«‹ç¾¤çµ„ï¼Œä¸¦è²¼ä¸Šæ­¤åº—åã€‚<br>å®Œæˆå¾Œå›ä¾†å¡«å¯«è³‡æ–™ã€‚</p>
      </div>
      <div id="dispatchStep2" class="dispatch-step">
          <div class="filter-section-title">Step 2: å›å¡«è³‡æ–™</div>
          
          <div style="position:relative; margin-bottom:10px;">
              <input type="text" id="dispatchGroupId" class="input-field" placeholder="æ­£åœ¨æŠ“å–ç¾¤çµ„ ID..." readonly style="background:#e9ecef; color:#555; font-weight:bold;">
              <span style="position:absolute; right:12px; top:12px; font-size:12px; color:#00C851; font-weight:bold;" id="groupIdStatus">â³ åµæ¸¬ä¸­</span>
          </div>

          <input type="text" id="dispatchLink" class="input-field" placeholder="ğŸ”— è²¼ä¸Š LINE ç¾¤çµ„é€£çµ (é¸å¡«)">
          
          <div class="filter-section-title">é¸æ“‡æ¥­å‹™</div>
          <div class="sales-grid" id="salesGrid"></div>
          <input type="text" id="dispatchNote" class="input-field" placeholder="ğŸ“ çµ¦æ¥­å‹™çš„å‚™è¨» (é¸å¡«)">
          <button class="sheet-confirm-btn" style="background:#9c27b0" onclick="confirmDispatch()">âœ… ç¢ºèªæ´¾å–®</button>
          <button style="width:100%; padding:10px; background:none; border:none; color:#999; margin-top:5px;" onclick="backToStep1()">â¬…ï¸ ä¸Šä¸€æ­¥</button>
      </div>
  </div>

  <div class="bottom-sheet-overlay" id="dateSheetOverlay" onclick="closeDateSheet()"></div>
  <div class="bottom-sheet" id="dateSheet">
      <div class="sheet-header">ğŸ“… é¸æ“‡æ—¥æœŸå€é–“ <button class="sheet-close" onclick="closeDateSheet()">âœ•</button></div>
      <div class="filter-section-title" style="margin-bottom:8px;">âš¡ å¿«é€Ÿé¸æ“‡</div>
      <div class="quick-date-grid-row1">
          <div class="quick-btn" onclick="setQuickDate('thisMonth')">æœ¬æœˆ</div>
          <div class="quick-btn" onclick="setQuickDate('lastMonth')">ä¸Šå€‹æœˆ</div>
          <div class="quick-btn" onclick="setQuickDate('thisWeek')">æœ¬é€±</div>
          <div class="quick-btn" onclick="setQuickDate('lastWeek')">ä¸Šé€±</div>
      </div>
      <div class="quick-date-grid-row2" id="recentMonthsContainer"></div>
      <div class="date-range-inputs">
          <div class="date-input-group"><label>é–‹å§‹æ—¥æœŸ</label><input type="date" id="dateStart" class="date-native-input" onchange="validateDateRange()"></div>
          <div style="padding-top:20px; color:#aaa;">â</div>
          <div class="date-input-group"><label>çµæŸæ—¥æœŸ</label><input type="date" id="dateEnd" class="date-native-input" onchange="validateDateRange()"></div>
      </div>
      <button class="sheet-confirm-btn" onclick="applyDateFilter()">ç¢ºèªç¯©é¸</button>
      <button style="width:100%; padding:12px; background:none; border:none; color:#666; margin-top:5px;" onclick="clearDateFilter()">æ¸…é™¤æ—¥æœŸæ¢ä»¶</button>
  </div>

  <div class="bottom-sheet" id="lineModal" style="padding:0; overflow:hidden;">
      <div class="sheet-header-box">
          <button class="sheet-close-btn" onclick="closeLineModal()">âœ•</button>
          <p class="current-store-title">ğŸ  <span id="displayStoreName">--</span></p>
      </div>

      <div class="guide-scroll-area">
          <div class="guide-container">
              <div class="step-box" id="step1">
                  <div class="step-num">1</div>
                  <div class="step-content">
                      <span class="step-title">é»æ“Š ID åŠ å¥½å‹</span>
                      <a id="lineJumpBtn" href="#" class="btn-main" target="_blank" onclick="markDone(1)">ğŸ†” <span id="lineInfoText">ID</span></a>
                  </div>
              </div>
              <div class="step-box" id="step2">
                  <div class="step-num">2</div>
                  <div class="step-content">
                      <span class="step-title">è¤‡è£½æš±ç¨±</span>
                      <div class="tag-btn-group">
                          <div class="tag-btn" id="tagUser" onclick="copyNick('user'); markDone(2)">ğŸ‘¤ æš±ç¨±</div>
                          <div class="tag-btn" id="tagTeacher" onclick="copyNick('teacher'); markDone(2)">ğŸ§‘â€ğŸ« æš±ç¨±</div>
                      </div>
                  </div>
              </div>
              <div class="step-box" id="step3">
                  <div class="step-num">3</div>
                  <div class="step-content">
                      <span class="step-title">å‚³é€åç‰‡ (é•·æŒ‰æ‹–æ›³è‡³å³è¦–çª—)</span>
                      <div class="card-img-box">
                        <img src="https://happy08200822.github.io/ezpretty-liff/card.jpg" class="card-img" draggable="true" ondragstart="markDone(3)">
                      </div>
                  </div>
              </div>
              <div class="step-box" id="step4">
                  <div class="step-num">4</div>
                  <div class="step-content">
                      <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span class="step-title">è¤‡è£½é–‹ç™¼è©±è¡“</span>
                        <div class="staff-row" id="staffSelector">
                            <div class="staff-chip active" id="chipK" onclick="selectS('Kelvin')">Kelvin</div>
                            <div class="staff-chip" id="chipD" onclick="selectS('David')">David</div>
                        </div>
                      </div>
                      <div class="script-tabs">
                          <button class="tab-btn active" onclick="setS('first')">åˆæ¬¡</button>
                          <button class="tab-btn" onclick="setS('follow')">äºŒæ•²</button>
                          <button class="tab-btn" onclick="setS('success')">é‚€ç´„</button>
                      </div>
                      <textarea id="lineScriptArea" class="line-textarea"></textarea>
                      <button class="btn-final-copy" id="copyBtn" onclick="pureCopy()">ğŸ“‹ åƒ…è¤‡è£½è©±è¡“</button>
                  </div>
              </div>
          </div>
      </div>
  </div>


<script>
  const FORM_LIFF_ID = "2009117067-6y3yHx9o"; 
  const GAS_URL = "https://script.google.com/macros/s/AKfycbzIKHpWcWj0bOhaQsx-OynY5FVVorMJvTNON5PBOywj1q-Nd5EylLCSl-zTlFW9Rb5U/exec";

// ğŸŒŸ 1. æ–°å¢è¨ˆæ™‚å™¨è®Šæ•¸ (çµ¦è‡ªå‹•åµæ¸¬ç”¨)
  let pollingTimer = null; 

  // ğŸŒŸ 2. æ–°å¢å®‰å…¨å‡½å¼ (é˜²æ­¢åº—åæœ‰å–®å¼•è™Ÿå°è‡´ç•«é¢ç©ºç™½å´©æ½°)
  function safe(str) {
      return (str || "").replace(/'/g, "\\'").replace(/"/g, '&quot;');
  }

  let allData = [];
  let currentTab = 'new';
  let currentSalesFilter = 'all'; 
  let currentDateGrain = 'day'; 
  let sortDesc = true; 
  let clickCounts = JSON.parse(localStorage.getItem('ezPretty_ClickCounts')) || {};
  let interactionCounts = JSON.parse(localStorage.getItem('ezPretty_InteractionCounts')) || {}; 
  let tempInteractionCounts = {}; 

  const charts = { status: null, sales: null, date: null, source: null, area: null };
  let filterState = { dateStart: null, dateEnd: null, source: [], area: [], industry: [] };
  
  let currentUpdateKey = null;
  let currentChecks = { L:false, M:false, N:false, O:false, Q:false };
  let currentProgress = "è¯çµ¡ä¸­"; 
  
  let currentDispatchKey = null;
  let currentDispatchStore = "";
  let selectedSales = null;
  let currentHudMode = 'update';

  const SALES_LIST = ['WT', 'Kelvin', 'David']; 

  // 1. è®€å–è³‡æ–™ (ä¿®å¾© Loading å¡ä½å•é¡Œ)
  async function loadData() {
    document.getElementById('loadingOverlay').style.opacity = '1';
    document.getElementById('loadingOverlay').style.display = 'flex';
    try {
      const response = await fetch(GAS_URL + "?action=getManagementList&t=" + new Date().getTime());
      const rawData = await response.json();
      allData = rawData.map(processItem); 
      checkDuplicates(allData); 
      initFilterOptions(); 
      calculateInsights(allData);
      doSort(); 
      render(); 
    } catch (e) { console.error(e); }
    
    // å»¶é²é—œé–‰ Loading ä¸¦ç¹ªè£½åœ–è¡¨
    setTimeout(() => {
        document.getElementById('loadingOverlay').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('loadingOverlay').style.display = 'none';
            try { initAllCharts(); } catch(e) { console.log('Chart load deferred'); }
        }, 300);
    }, 100);
  }

  function parseDate(dateStr) {
      if(!dateStr) return null;
      let clean = dateStr.toString().split(" ")[0].replace(/[^\d\/\-\.]/g, ''); 
      let d = new Date(clean);
      if(isNaN(d.getTime())) return null;
      return d;
  }

  function processItem(i) {
    const L = !!i.isL; const M = !!i.isM; const N = !!i.isN; const O = !!i.isO; const Q = !!i.isQ;
    const rawR = String(i.progress || ""); 
    const parts = rawR.split(/[|ï½œ]/); 
    const lastUpdateStr = parts[0] ? parts[0].trim() : "";
    const statusStr = parts[1] ? parts[1].trim() : (parts[0] || ""); 

    const isReject = rawR.includes("æ‹’çµ•");
    const isInvalid = (String(i.detailLabel)||"").includes('ç„¡æ•ˆ') || i.status === 'ç„¡æ•ˆå–®' || isReject;
    
    let isIdle = false;
    if (lastUpdateStr && !isInvalid) {
        const lastDate = parseDate(lastUpdateStr);
        if (lastDate) {
            const diffDays = (new Date() - lastDate) / (1000 * 60 * 60 * 24);
            if (diffDays > 3) isIdle = true;
        }
    }
    i.isIdle = isIdle;
    i.progressStatus = statusStr;

    const sales = String(i.sales||"").trim();
    const hasSales = sales !== "";
    const isSelf = i.source === "æ¥­å‹™è‡ªé–‹ä»¶";
    
    let category = 'new';
    let actionText = 'æœªå®šç¾©';
    if (hasSales) { category = isSelf ? 'self' : 'dispatched'; actionText = isSelf ? `ğŸ’ª æ¥­å‹™è‡ªé–‹ï¼š${sales}` : `ğŸš€ å·²æ´¾å–®çµ¦ï¼š${sales}`; } 
    else if (isInvalid) { category = 'invalid'; actionText = 'ğŸ’€ æ­¤å–®å·²æ¨™è¨˜ç„¡æ•ˆ'; } 
    else if (!L && !M && !N && !O && !Q) { category = 'new'; actionText = 'ğŸ†• æ–°å–®è«‹è¯çµ¡ï¼'; } 
    else if (L && !M) { category = 'unread'; actionText = !N ? 'ğŸ“ è«‹ä¸€å®šè¦æ‰“é›»è©±ï¼' : (N && !O ? 'ğŸ”„ æœªæ¥ï¼ç¹¼çºŒæ‰“ï¼' : (N && O && !Q ? 'ğŸš¨ è£æ­»ä¸çœ‹ï¼' : 'ğŸ“§ å·²å¯„ä¿¡ï¼ç¹¼çºŒè¿½æ®ºï¼')); } 
    else if (L && M) { category = 'read'; actionText = !N && !O ? 'ğŸ“ å·²è®€æ²’å›ï¼è«‹æ‰“é›»è©±ï¼' : (N && !O ? 'ğŸ”„ å·²è®€æœªæ¥ï¼ç¹¼çºŒæ‰“ï¼' : 'ğŸ”¥ å·²è®€å·²é€šï¼è©²æ´¾å–®äº†ï¼'); } 
    else { category = 'noline'; actionText = N && !O ? 'ğŸ”„ æœªé€šï¼ç¹¼çºŒæ‰“ï¼' : (N && O ? 'âš ï¸ æœ‰é€šæ²’åŠ Lineï¼' : 'â“ ç‹€æ…‹ç•°å¸¸'); }
    i.category = category; i.actionText = actionText;
    return i;
  }

  function calculateInsights(data) {
      const companyTotal = data.filter(i => i.source !== "æ¥­å‹™è‡ªé–‹ä»¶").length;
      const companyDispatch = data.filter(i => i.category === 'dispatched' && i.source !== "æ¥­å‹™è‡ªé–‹ä»¶").length;
      const companyJunk = data.filter(i => i.category === 'invalid' && i.source !== "æ¥­å‹™è‡ªé–‹ä»¶").length;

      const convRate = companyTotal > 0 ? Math.round((companyDispatch / companyTotal) * 100) : 0;
      const junkRate = companyTotal > 0 ? Math.round((companyJunk / companyTotal) * 100) : 0;

      document.getElementById('val-conversion').innerText = convRate + "%";
      document.getElementById('val-junk').innerText = junkRate + "%";
      document.getElementById('val-conversion').className = "insight-val " + (convRate >= 20 ? "good" : "");
      document.getElementById('val-junk').className = "insight-val " + (junkRate > 50 ? "bad" : "");
  }

  function render() {
    updateFilterHint();
    const salesBar = document.getElementById('salesFilterBar');
    if (currentTab === 'dispatched' || currentTab === 'self') {
        salesBar.style.display = 'block';
        salesBar.className = 'sales-filter-dispatched no-scrollbar';
        if(currentTab === 'self') salesBar.className = 'sales-filter-self no-scrollbar';
        updateSalesFilterUI(allData); 
    } else {
        salesBar.style.display = 'none';
        currentSalesFilter = 'all'; 
    }
    const list = document.getElementById('storeList');
    const search = document.getElementById('searchInput').value.trim().toLowerCase();
    const commonFiltered = allData.filter(i => {
      const content = ((i.source||"")+(i.industry||"")+(i.area||"")+(i.name||"")+(i.boss||"")+(i.lineId||"")+(i.phone||"")+(i.email||"")+(i.req||"")+(i.key||"")+(i.sales||"")).toLowerCase();
      if(search !== "" && !content.includes(search)) return false;
      if (filterState.dateStart || filterState.dateEnd) {
          const d = parseDate(i.date);
          if (!d) return false; 
          if (filterState.dateStart && d < filterState.dateStart) return false;
          if (filterState.dateEnd && d > filterState.dateEnd) return false;
      }
      if (filterState.source.length > 0 && !filterState.source.includes(i.source)) return false;
      if (filterState.area.length > 0 && !filterState.area.includes(i.area)) return false;
      if (filterState.industry.length > 0 && !filterState.industry.includes(i.industry)) return false;
      return true;
    });
    calculateCountsAndCharts(commonFiltered);
    const finalFiltered = commonFiltered.filter(i => {
        const matchTab = (currentTab === 'all') ? true : (i.category === currentTab);
        const matchSales = (currentSalesFilter === 'all') ? true : (i.sales === currentSalesFilter);
        return matchTab && matchSales;
    });
    if (finalFiltered.length === 0) { list.innerHTML = `<div style="text-align:center; padding:50px; color:#999;">æ­¤åˆ†é¡ç„¡ç¬¦åˆåå–®</div>`; return; }
    
    list.innerHTML = finalFiltered.map(item => {
      const style = getSourceStyle(item.source);
      let dupAlert = '';
      if (item.isDup && item.dupInfo) {
          const reasons = item.dupInfo.map(info => `<div>ğŸš¨ é‡è¤‡ï¼š${info.reason} (${info.targets.join(', ')})</div>`).join('');
          dupAlert = `<div class="dup-alert">${reasons}</div>`;
      }
      const localCount = clickCounts[item.key] || 0;
      const badgeHtml = localCount > 0 ? `<span class="update-badge">${localCount}</span>` : '';
      
      let lineUrl = item.lineId ? `https://line.me/ti/p/~${item.lineId}` : (item.phone ? `https://line.me/ti/p/~${item.phone}` : "#");
      // ğŸŒŸ é€™è£¡é †ä¾¿ä¿®å¾©äº†ä½ çš„åœ°åœ–é€£çµ (è£œå› $)
      const mapUrl = `http://googleusercontent.com/maps.google.com/maps?q=${encodeURIComponent(item.area + item.name)}`;
      
      const cleanRawP = (item.rawP || "").replace(/'/g, "\\'").replace(/\n/g, "\\n");
      const currentProgress = item.progressStatus || ""; 

      const idleClass = item.isIdle ? "idle-warning" : "";
      const idleTag = item.isIdle ? `<div class="idle-tag">â³ ä¹…æœªè¯çµ¡</div>` : "";
      
      let badgeClass = "good";
      if(item.progress && item.progress.includes("æ‹’çµ•")) badgeClass = "bad";

      const wStatus = item.status || "";
      let wBadgeClass = "w-gray";
      if(wStatus.includes("å·²æˆäº¤") || wStatus.includes("æ„é¡˜é«˜")) wBadgeClass = "w-red";
      else if(wStatus.includes("å·²ç´„å±•") || wStatus.includes("å·²æ‹‰ç¾¤")) wBadgeClass = "w-green";
      else if(wStatus.includes("å±•ç¤ºå®Œ")) wBadgeClass = "w-orange";
      
      const wBadgeHtml = wStatus ? `<span class="w-status-badge ${wBadgeClass}">${wStatus}</span>` : "";
      
      const safeReq = (item.req || "").replace(/'/g, "\\'").replace(/"/g, '"').replace(/\n/g, ' ');

      return `
      <div class="store-card card-${item.category} ${idleClass}">
        ${idleTag}
        <div class="top-right-badge"><span class="badge-source" style="background:${style.bg}">${style.label}</span><br>${parseDate(item.date)?parseDate(item.date).toLocaleDateString():'ç„¡æ—¥æœŸ'}</div>
        <div class="store-name">
            <span class="key-badge">#${item.key || 'ç„¡'}</span>
            <span class="industry-text" style="margin-left:5px;">ğŸ­ ${item.industry || 'ä¸€èˆ¬'}</span>
            ${item.area}${item.name} 
            ${wBadgeHtml} <button class="btn-copy-text" onclick="copyContent('${safe(item.area + item.name)}', 'åº—å')">ğŸ“„</button>
        </div>
        <div class="action-alert"><i>ğŸ””</i> ${item.actionText}</div>
        ${dupAlert}
        <div class="info-box">
          <div><b>ğŸ‘¤ è² è²¬äºº:</b> ${item.boss || 'æœªå¡«'}</div>
          <div><b>ğŸ“ é›»è©±:</b> ${item.phone} <button class="btn-copy-text" onclick="copyContent('${safe(item.phone)}','é›»è©±')">ğŸ“„</button></div>
          <div><b>ğŸ†” Line:</b> ${item.lineId || '--'}</div>
          ${item.req ? `<div class="req-text">ğŸ“ éœ€æ±‚: ${item.req}</div>` : ''}
          ${item.sales ? `<div class="req-text" style="color:${item.category==='self'?'#00897b':'#9c27b0'};">ğŸš€ æ¥­å‹™: ${item.sales}</div>` : ''}
        </div>
        <div class="status-checks">
          <span class="check-pill ${item.isL?'on':''}">åŠ Line</span>
          <span class="check-pill ${item.isM?'on':''}">å·²è®€</span>
          <span class="check-pill ${item.isN?'on':''}">æ’¥é›»è©±</span>
          <span class="check-pill ${item.isO?'on':''}">æ’¥é€š</span>
          <span class="check-pill ${item.isQ?'on':''}">Email</span>
        </div>
        
        <div class="record-section">
            <span class="record-label">
                ğŸ“ ç´€éŒ„ 
                ${currentProgress ? `<span class="status-badge ${badgeClass}" style="margin-left:6px;">${currentProgress}</span>` : ''}
            </span>
            <div class="record-box">${item.rawP || 'ç„¡'}</div>
        </div>
        
        <div class="action-grid">
          <div class="btn-tool btn-ghost" onclick="openLineModal('${item.key}', '${safe(item.name)}', '${item.lineId||'--'}', '${safe(item.phone)}', '${safeReq}', '${safe(item.area)}')">
            <i>ğŸ’¬</i>Line
          </div>
          <a href="tel:${item.phone}" class="btn-tool btn-ghost"><i>ğŸ“</i>é›»è©±</a>
          <a href="mailto:${item.email}" class="btn-tool btn-ghost"><i>âœ‰ï¸</i>Email</a>
          <a href="${mapUrl}" target="_blank" class="btn-tool btn-ghost"><i>ğŸ—ºï¸</i>åœ°åœ–</a>
          <div class="btn-tool btn-orange" onclick="openUpdateModal('${item.key}', '${safe(item.name)}', ${item.isL}, ${item.isM}, ${item.isN}, ${item.isO}, ${item.isQ}, '${cleanRawP}', '${currentProgress}')">
            <i>ğŸ“</i>æ›´æ–°${badgeHtml}
          </div>
          <div class="btn-tool btn-purple" onclick="openDispatchModal('${item.key}', '${safe(item.name)}')">
            <i>ğŸš€</i>æ´¾å–®
          </div>
        </div>
      </div>
    `}).join('');
  }

  function openUpdateModal(key, name, L, M, N, O, Q, rawP, progress) {
      currentUpdateKey = key;
      currentChecks = { L, M, N, O, Q };
      currentProgress = progress || "è¯çµ¡ä¸­"; 

      if(!interactionCounts[key]) interactionCounts[key] = { call:0, line:0 };
      tempInteractionCounts = { ...interactionCounts[key] }; 
      document.getElementById('updateModalTitle').innerText = name;
      document.getElementById('lbl-call-count').innerText = `(${tempInteractionCounts.call})`;
      document.getElementById('lbl-line-count').innerText = `(${tempInteractionCounts.line})`;
      ['L','M','N','O','Q'].forEach(k => {
          const el = document.getElementById('tog-'+k);
          if(currentChecks[k]) el.classList.add('active');
          else el.classList.remove('active');
      });
      
      document.querySelectorAll('.status-btn-big').forEach(btn => {
          btn.classList.remove('active');
          if(btn.innerText.includes(currentProgress)) btn.classList.add('active');
      });

      const noteField = document.getElementById('updateNote');
      if (rawP && rawP !== "null" && rawP !== "undefined" && rawP.trim() !== "") {
          let content = rawP;
          if(!content.includes("å‚³lineç´€éŒ„")) content = "å‚³lineç´€éŒ„ï¼ˆå…±0æ¬¡ï¼‰ï¼š\n" + content;
          if(!content.includes("æ’¥æ‰“ç´€éŒ„")) content = content.replace("å‚³lineç´€éŒ„", "æ’¥æ‰“ç´€éŒ„ï¼ˆå…±0æ¬¡ï¼‰ï¼š\nå‚³lineç´€éŒ„");
          noteField.value = rawP; 
      } else {
          noteField.value = "å‚³lineç´€éŒ„ï¼ˆå…±0æ¬¡ï¼‰ï¼š\næ’¥æ‰“ç´€éŒ„ï¼ˆå…±0æ¬¡ï¼‰ï¼š\nå…¶ä»–è³‡è¨Šï¼š\næ‰‹å‹•ç´€éŒ„ï¼š";
      }
      document.getElementById('updateModalOverlay').style.display = 'block';
      setTimeout(() => document.getElementById('updateModalOverlay').style.opacity = '1', 10);
      document.getElementById('updateModal').classList.add('show');
  }
  
  function selectStatus(el, status) {
      document.querySelectorAll('.status-btn-big').forEach(c => c.classList.remove('active'));
      el.classList.add('active');
      currentProgress = status; 
  }

  function closeUpdateModal() {
      document.getElementById('updateModal').classList.remove('show');
      document.getElementById('updateModalOverlay').style.opacity = '0';
      setTimeout(() => document.getElementById('updateModalOverlay').style.display = 'none', 300);
  }
  function toggleStatus(type) {
      currentChecks[type] = !currentChecks[type];
      const el = document.getElementById('tog-'+type);
      el.classList.toggle('active');
  }
  function insertNote(text) {
      const field = document.getElementById('updateNote');
      let val = field.value;
      const now = new Date();
      const timeStr = `[ ${now.getMonth()+1}/${now.getDate()} ï½œ ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')} ]`;

      if(text === 'call') {
          tempInteractionCounts.call++;
          document.getElementById('lbl-call-count').innerText = `(${tempInteractionCounts.call})`;
          if (/æ’¥æ‰“ç´€éŒ„ï¼ˆå…±\d+æ¬¡ï¼‰ï¼š/.test(val)) {
              val = val.replace(/æ’¥æ‰“ç´€éŒ„ï¼ˆå…±\d+æ¬¡ï¼‰ï¼š/, `æ’¥æ‰“ç´€éŒ„ï¼ˆå…±${tempInteractionCounts.call}æ¬¡ï¼‰ï¼š`);
          } else if (/æ’¥æ‰“ç´€éŒ„ï¼š/.test(val)) {
              val = val.replace(/æ’¥æ‰“ç´€éŒ„ï¼š/, `æ’¥æ‰“ç´€éŒ„ï¼ˆå…±${tempInteractionCounts.call}æ¬¡ï¼‰ï¼š`);
          }
          const lines = val.split('\n');
          const newLines = lines.map(line => {
              if(line.startsWith("æ’¥æ‰“ç´€éŒ„")) return line + " " + timeStr + " å·²æ’¥æ‰“";
              return line;
          });
          val = newLines.join('\n');
      } else if(text === 'line') {
          tempInteractionCounts.line++;
          document.getElementById('lbl-line-count').innerText = `(${tempInteractionCounts.line})`;
          if (/å‚³lineç´€éŒ„ï¼ˆå…±\d+æ¬¡ï¼‰ï¼š/.test(val)) {
              val = val.replace(/å‚³lineç´€éŒ„ï¼ˆå…±\d+æ¬¡ï¼‰ï¼š/, `å‚³lineç´€éŒ„ï¼ˆå…±${tempInteractionCounts.line}æ¬¡ï¼‰ï¼š`);
          } else if (/å‚³lineç´€éŒ„ï¼š/.test(val)) {
              val = val.replace(/å‚³lineç´€éŒ„ï¼š/, `å‚³lineç´€éŒ„ï¼ˆå…±${tempInteractionCounts.line}æ¬¡ï¼‰ï¼š`);
          }
          const lines = val.split('\n');
          const newLines = lines.map(line => {
              if(line.startsWith("å‚³lineç´€éŒ„")) return line + " " + timeStr + " å·²å‚³è¨Š";
              return line;
          });
          val = newLines.join('\n');
      } else {
          const lines = val.split('\n');
          const newLines = lines.map(line => {
              if(line.startsWith("å…¶ä»–è³‡è¨Š")) return line + " [" + text + "]";
              return line;
          });
          val = newLines.join('\n');
      }
      field.value = val;
  }
  function saveUpdate() {
      const btn = document.querySelector('#updateModal .sheet-confirm-btn');
      const originalText = btn.innerText;
      btn.innerText = "â³ å„²å­˜ä¸­...";
      btn.disabled = true;

      const now = new Date();
      const timeStamp = `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${now.getMinutes()}`;
      const compositeR = `${timeStamp} ï½œ ${currentProgress}`; 

      const params = new URLSearchParams({
          action: 'updateProgress',
          key: currentUpdateKey,
          progress: compositeR, 
          note: document.getElementById('updateNote').value,
          isL: currentChecks.L,
          isM: currentChecks.M,
          isN: currentChecks.N,
          isO: currentChecks.O,
          isQ: currentChecks.Q
      });

      fetch(GAS_URL + "?" + params.toString(), { method: "POST" })
      .then(res => res.text())
      .then(result => {
          if(result.includes("Success")) {
              alert(`âœ… æ›´æ–°æˆåŠŸï¼\nç‹€æ…‹ï¼š${currentProgress}`);
              
              const item = allData.find(i => i.key === currentUpdateKey);
              if(item) {
                  item.progressStatus = currentProgress;
                  item.progress = compositeR; 
                  item.isIdle = false;
                  if (currentProgress === 'æ‹’çµ•') {
                      item.category = 'invalid';
                      item.actionText = 'ğŸ’€ æ­¤å–®å·²æ¨™è¨˜ç„¡æ•ˆ';
                  }
              }
              closeUpdateModal();
              render(); 
          } else {
              alert("âŒ å„²å­˜å¤±æ•—ï¼Œå¾Œç«¯å›å‚³éŒ¯èª¤ï¼š" + result);
          }
      })
      .catch(err => {
          alert("âŒ ç¶²è·¯é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
          console.error(err);
      })
      .finally(() => {
          btn.innerText = originalText;
          btn.disabled = false;
      });
  }
// ğŸŒŸ å•Ÿå‹•åµæ¸¬ï¼šæ¯ 3 ç§’å•ä¸€æ¬¡ (çµ¦ Fold 7 ç”¨)
  function startPollingId() {
      if(pollingTimer) clearInterval(pollingTimer);
      
      const idField = document.getElementById('dispatchGroupId');
      const statusLabel = document.getElementById('groupIdStatus');
      
      idField.value = "";
      idField.placeholder = "ç­‰å¾…æ©Ÿå™¨äººå…¥ç¾¤...";
      statusLabel.innerText = "â³ åµæ¸¬ä¸­";
      statusLabel.style.color = "#888";

      // ç«‹å³å•ä¸€æ¬¡
      getLatestGroupIdFromGas();

      // æ¯ 3 ç§’å•ä¸€æ¬¡
      pollingTimer = setInterval(getLatestGroupIdFromGas, 3000);
  }

  // å• GAS æ‹¿ ID
  function getLatestGroupIdFromGas() {
      const idField = document.getElementById('dispatchGroupId');
      const statusLabel = document.getElementById('groupIdStatus');

      fetch(GAS_URL + "?action=getLatestGroupId")
      .then(res => res.json())
      .then(res => {
          if (res.groupId) {
              idField.value = res.groupId;
              statusLabel.innerText = "âœ… å·²è‡ªå‹•æŠ“å–";
              statusLabel.style.color = "#00C851"; 
              
              // æŠ“åˆ°äº†å°±åœæ­¢è¨ˆæ™‚
              if(pollingTimer) {
                  clearInterval(pollingTimer);
                  pollingTimer = null;
              }
          } else {
              // æ²’æŠ“åˆ°ï¼Œç¹¼çºŒç­‰
              if(statusLabel.innerText.includes("åµæ¸¬ä¸­")) {
                  statusLabel.innerText = statusLabel.innerText.endsWith("...") ? "â³ åµæ¸¬ä¸­" : statusLabel.innerText + ".";
              }
          }
      })
      .catch(e => console.error("Polling Error:", e));
  }

  // æ‰“é–‹æ´¾å–®è¦–çª—
  function openDispatchModal(key, name) {
      currentDispatchKey = key;
      currentDispatchStore = name;
      const grid = document.getElementById('salesGrid');
      grid.innerHTML = SALES_LIST.map(s => `<div class="sales-tile" onclick="selectSales(this, '${s}')">${s} <div class="sales-check">âœ…</div></div>`).join('');
      selectedSales = null;
      document.getElementById('dispatchStoreName').innerText = name;
      document.getElementById('dispatchLink').value = '';
      document.getElementById('dispatchNote').value = '';
      
      document.getElementById('dispatchStep1').classList.add('active');
      document.getElementById('dispatchStep2').classList.remove('active');
      
      document.getElementById('dispatchModalOverlay').style.display = 'block';
      setTimeout(() => document.getElementById('dispatchModalOverlay').style.opacity = '1', 10);
      document.getElementById('dispatchModal').classList.add('show');
  }

  // é—œé–‰è¦–çª— (å‹™å¿…åœæ­¢åµæ¸¬)
  function closeDispatchModal() {
      if(pollingTimer) clearInterval(pollingTimer);
      pollingTimer = null;
      document.getElementById('dispatchModal').classList.remove('show');
      document.getElementById('dispatchModalOverlay').style.opacity = '0';
      setTimeout(() => document.getElementById('dispatchModalOverlay').style.display = 'none', 300);
  }

  // æŒ‰ä¸‹è¤‡è£½å¾Œ -> å•Ÿå‹•åµæ¸¬
  function copyStoreAndNext() {
      navigator.clipboard.writeText(currentDispatchStore + " + ezPrettyè¨è«–").then(() => {
          document.getElementById('dispatchStep1').classList.remove('active');
          document.getElementById('dispatchStep2').classList.add('active');
          showHUD(currentDispatchStore);
          
          // ğŸš€ å•Ÿå‹•è‡ªå‹•åµæ¸¬
          startPollingId(); 
      });
  }

  function backToStep1() {
      if(pollingTimer) clearInterval(pollingTimer);
      document.getElementById('dispatchStep2').classList.remove('active');
      document.getElementById('dispatchStep1').classList.add('active');
  }

  function selectSales(el, name) {
      document.querySelectorAll('.sales-tile').forEach(d => d.classList.remove('selected'));
      el.classList.add('selected');
      selectedSales = name;
  }

  function confirmDispatch() {
      const link = document.getElementById('dispatchLink').value;
      const note = document.getElementById('dispatchNote').value;
      const rawGroupId = document.getElementById('dispatchGroupId').value;
      const finalGroupId = (rawGroupId && rawGroupId.trim() !== "") ? rawGroupId : "ç„¡";

      if(!link) { alert("è«‹è²¼ä¸Šç¾¤çµ„é€£çµï¼"); return; }
      if(!selectedSales) { alert("è«‹é¸æ“‡æ¥­å‹™ï¼"); return; }
      
      const btn = document.querySelector('#dispatchStep2 .sheet-confirm-btn');
      const orgText = btn.innerText;
      btn.innerText = "â³ æ´¾å–®ä¸­...";
      btn.disabled = true;

      const params = new URLSearchParams({
          action: 'dispatch', 
          key: currentDispatchKey,
          staff: selectedSales,
          storeName: currentDispatchStore,
          link: link,
          req: note,
          groupId: finalGroupId
      });

      fetch(GAS_URL + "?" + params.toString(), { method: "POST" })
      .then(res => res.text())
      .then(result => {
          if(result.includes("Success")) {
              alert(`âœ… æ´¾å–®æˆåŠŸï¼\næ¥­å‹™ï¼š${selectedSales}\nIDï¼š${finalGroupId}`);
              closeDispatchModal();
              closeHUD();
              loadData(); 
          } else {
              alert("âŒ å¤±æ•—ï¼š" + result);
          }
      })
      .catch(err => alert("âŒ é€£ç·šéŒ¯èª¤"))
      .finally(() => {
          btn.innerText = orgText;
          btn.disabled = false;
      });
  }
  

  // è®“ç¶²é è¼‰å…¥æ™‚å–®ç´”åšè³‡æ–™è®€å–å°±å¥½
  window.onload = loadData;

</script>
</body>
</html>

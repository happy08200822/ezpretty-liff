<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ğŸ¯ ezPretty æ¥­å‹™æˆ°æƒ…å®¤ Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <style>
    [v-cloak] { display: none !important; }
    body { font-family: 'PingFang TC', sans-serif; background-color: #f1f5f9; -webkit-tap-highlight-color: transparent; }
    .card-shadow { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .expand-enter-active, .expand-leave-active { transition: all 0.2s ease-out; max-height: 400px; overflow: hidden; }
    .expand-enter-from, .expand-leave-to { max-height: 0; opacity: 0; }
    .chip-active { background-color: #1e293b !important; color: white !important; border-color: transparent !important; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    input[type="month"]::-webkit-calendar-picker-indicator { cursor: pointer; opacity: 0.6; }
  </style>
</head>
<body class="pb-10">
  <div id="app" v-cloak class="w-full max-w-4xl mx-auto px-3 pt-4">

    <div v-if="isLoading" class="fixed inset-0 bg-slate-50 z-50 flex flex-col items-center justify-center">
      <div class="relative flex justify-center items-center">
        <div class="absolute animate-ping w-16 h-16 rounded-full bg-indigo-400 opacity-20"></div>
        <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-indigo-600 z-10"></div>
      </div>
      <p class="mt-6 text-indigo-600 font-black tracking-widest text-xs animate-pulse">é€£ç·š ezPretty ä¸­å€æˆ°æƒ…ä¸­å¿ƒ...</p>
      <p class="mt-2 text-slate-400 font-bold text-[9px]">åŒæ­¥æœ€æ–°æˆ°å ±æ•¸æ“šä¸­</p>
    </div>

    <div v-show="!isLoading">
      <div class="flex bg-gray-200 rounded-xl p-1 mb-3">
        <button v-for="rep in ['All', 'Kelvin', 'David']" :key="rep" @click="setRep(rep)"
          :class="['flex-1 py-2 rounded-lg text-xs font-black transition-all', currentRep === rep ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-500']">
          [[ rep === 'All' ? 'ğŸŒ å…¨é«”' : rep ]]
        </button>
      </div>

      <div class="bg-white px-4 py-3 rounded-2xl card-shadow border border-slate-100 mb-3">
        <div class="flex justify-between items-center mb-1.5">
          <span class="text-[10px] font-black text-slate-400">$[[ formatNumber(stats.sales) ]]</span>
          <span class="text-[10px] font-black text-rose-500">ç›®æ¨™ $[[ formatNumber(targetAmount) ]]</span>
        </div>
        <div class="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
          <div class="bg-indigo-600 h-full transition-all duration-1000" :style="{ width: (stats.sales / targetAmount * 100) + '%' }"></div>
        </div>
      </div>

      <div class="bg-white rounded-2xl card-shadow border border-slate-100 mb-4 overflow-hidden">
        <button @click="showStats = !showStats" class="w-full px-4 py-2 flex justify-between items-center bg-slate-50/50">
          <span class="text-[9px] font-black text-slate-500 tracking-widest uppercase">æˆ°å ±æ•¸æ“šåˆ†æ</span>
          <span class="text-[10px] font-bold text-slate-400">[[ showStats ? 'â–² é»æ“Šæ”¶åˆ' : 'â–¼ é»æ“Šå±•é–‹' ]]</span>
        </button>
        <transition name="expand">
          <div v-if="showStats" class="p-4 space-y-4 border-t border-slate-100">
            <div class="grid grid-cols-2 gap-3 text-center">
              <div class="bg-blue-50 p-2 rounded-xl border border-blue-100 text-blue-700">
                <p class="text-[8px] font-black opacity-70">ğŸ¢ å…¬å¸ä»¶/å±•ç¤º</p>
                <p class="text-base font-black">[[ stats.corp.assign ]] / [[ stats.corp.demo ]]</p>
              </div>
              <div class="bg-emerald-50 p-2 rounded-xl border border-emerald-100 text-emerald-700">
                <p class="text-[8px] font-black opacity-70">ğŸš€ è‡ªé–‹ç™¼/å±•ç¤º</p>
                <p class="text-base font-black">[[ stats.self.assign ]] / [[ stats.self.demo ]]</p>
              </div>
            </div>
            <div>
              <div class="flex justify-between mb-1">
                <span v-for="s in intentStats" :key="s.label" :class="['text-[8px] font-black', s.color]">[[ s.label ]]:[[ s.count ]]</span>
              </div>
              <div class="w-full flex h-1 rounded-full overflow-hidden bg-slate-100">
                <div v-for="s in intentStats" :key="s.label" :class="[s.bgColor]" :style="{ width: (s.count / (stats.total || 1) * 100) + '%' }"></div>
              </div>
            </div>
          </div>
        </transition>
      </div>

      <div class="space-y-3 mb-6">
        <div class="relative">
          <input v-model="searchQuery" type="text" placeholder="ğŸ” æœå°‹åº—åæˆ–å€åŸŸ..." 
            class="w-full bg-white border-none ring-1 ring-slate-200 rounded-xl py-3 px-4 text-xs font-bold focus:ring-2 focus:ring-slate-800 outline-none shadow-sm">
        </div>

        <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1 items-center">
          <button v-for="d in dateFilters" :key="d.id" @click="timeRange = d.id"
            :class="['flex-none px-4 py-1.5 rounded-full text-[10px] font-black border transition-all', timeRange === d.id ? 'chip-active' : 'bg-white text-slate-400 border-slate-200']">
            [[ d.label ]]
          </button>
          <div class="relative flex-none">
            <input type="month" v-model="customMonth" @change="timeRange = 'custom'"
              class="bg-white rounded-full px-3 py-1.5 text-[10px] font-black focus:outline-none transition-all border"
              :class="timeRange === 'custom' ? 'chip-active' : 'text-slate-400 border-slate-200'">
          </div>
        </div>

        <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
          <button v-for="t in tabs" :key="t.id" @click="currentTab = t.id"
            :class="['flex-none px-4 py-1.5 rounded-full text-[10px] font-black border transition-all flex items-center gap-1.5', currentTab === t.id ? 'chip-active' : 'bg-white text-slate-400 border-slate-200']">
            [[ t.label ]]
            <span :class="currentTab === t.id ? 'bg-white/20 text-white' : 'bg-slate-100 text-slate-400'" class="px-1.5 py-0.5 rounded-md text-[9px]">
              [[ getTabCount(t.id) ]]
            </span>
          </button>
        </div>
      </div>

      <div v-if="processedData.length > 0">
        <div v-for="section in categorizedData" :key="section.title" class="mb-10">
          <div class="flex items-center gap-2 mb-4 px-1">
            <span :class="[section.color, 'text-white text-[11px] font-black px-2.5 py-1 rounded-md shadow-sm tracking-widest']">
              [[ section.title ]]
            </span>
            <span class="text-[10px] font-black text-slate-400 bg-slate-200/50 px-2 py-0.5 rounded-full">
              å…± [[ section.items.length ]] ä»¶
            </span>
            <div class="flex-1 h-px bg-slate-200 ml-2"></div>
          </div>

          <div class="space-y-4">
            <div v-for="item in section.items" :key="item.id" class="bg-white rounded-[2rem] p-5 card-shadow border border-slate-100 relative">
              <div class="absolute top-5 right-6 text-right">
                <p class="text-[10px] font-black text-indigo-500 mb-0.5">ğŸ‘¤ [[ item.owner ]]</p>
                <p class="text-[9px] font-black text-slate-400 tracking-tighter uppercase">ğŸ“… [[ item.assignDate ]]</p>
              </div>

              <div class="mb-2">
                <div class="flex items-center gap-1.5 mb-1.5">
                  <span class="text-[9px] font-black text-slate-500 bg-slate-100 px-2 py-0.5 rounded uppercase">[[ item.industry ]]</span>
                </div>
                <h2 class="text-lg font-black text-slate-800 leading-tight pr-20">[[ item.area ]] [[ item.storeName ]]</h2>
              </div>

              <div class="mb-4 space-y-1.5">
                <div class="bg-blue-50/50 p-2.5 rounded-xl border-l-4 border-blue-400">
                  <p class="text-[8px] font-black text-blue-400 uppercase mb-0.5 tracking-wider">ğŸ’¡ å»£å‘Šéœ€æ±‚ (J æ¬„)</p>
                  <p class="text-[11px] font-bold text-slate-600 line-clamp-2">[[ item.adsReq || 'ç„¡å¡«å¯«éœ€æ±‚' ]]</p>
                </div>
                <div class="bg-amber-50/50 p-2.5 rounded-xl border-l-4 border-amber-400">
                  <p class="text-[8px] font-black text-amber-500 uppercase mb-0.5 tracking-wider">ğŸš© ä¸»ç®¡å‚™è¨» (T æ¬„)</p>
                  <p class="text-[11px] font-bold text-slate-600 line-clamp-2">[[ item.managerNote || 'æš«ç„¡å‚™è¨»' ]]</p>
                </div>
              </div>

              <div class="space-y-1 text-[11px] font-bold text-slate-500 bg-slate-50 p-3 rounded-2xl mb-4 border border-slate-100">
                <div class="flex justify-between py-0.5 border-b border-slate-200/50 pb-1">
                  <span class="text-slate-400">ğŸ¬ å±•ç¤ºæ—¥æœŸ</span>
                  <span class="text-slate-700">[[ item.demoDate ]] ([[ item.demoMethod ]])</span>
                </div>
                <div class="flex justify-between py-0.5 border-b border-slate-200/50 pb-1">
                  <span class="text-slate-400">ğŸ† å±•ç¤ºçµæœ</span>
                  <span :class="item.demoResult === 'æ‹’çµ•' ? 'text-rose-500' : 'text-slate-700'">[[ item.demoResult ]]</span>
                </div>
                <div class="flex justify-between py-0.5 border-b border-slate-200/50 pb-1">
                  <span class="text-slate-400">âŒ› å¡«è¡¨æ™‚é–“</span>
                  <span class="text-slate-400 font-medium text-[10px]">[[ item.trackTime ]]</span>
                </div>
                <div class="flex justify-between py-0.5">
                  <span class="text-slate-400">ğŸ’° æˆäº¤/é‡‘é¡</span>
                  <span class="text-emerald-600 font-black">
                    [[ item.status === 'å·²æˆäº¤' ? 'å·²æˆäº¤' + (item.dealDate ? ' (' + item.dealDate + ')' : '') : 'å°šæœªæˆäº¤' ]] / $[[ formatNumber(item.salesAmount) ]]
                  </span>
                </div>
              </div>

              <div class="grid grid-cols-3 gap-2">
                <button @click="copyLineId(item.lineId)" class="py-2.5 bg-slate-100 rounded-xl text-[10px] font-black text-slate-600 active:bg-slate-200 transition">LINE ID</button>
                <button @click="callPhone(item.phone)" class="py-2.5 bg-slate-100 rounded-xl text-[10px] font-black text-slate-600 active:bg-slate-200 transition">é›»è©±</button>
                <button @click="openGroup(item.groupLink)" class="py-2.5 bg-slate-100 rounded-xl text-[10px] font-black text-slate-600 active:bg-slate-200 transition">ç¾¤çµ„é€£çµ</button>
                
                <button @click="pendingFeature" class="py-2.5 bg-amber-500 rounded-xl text-[10px] font-black text-white active:scale-95 shadow-sm shadow-amber-200 transition">ç´„å±•å›å ±</button>
                <button @click="pendingFeature" class="py-2.5 bg-blue-600 rounded-xl text-[10px] font-black text-white active:scale-95 shadow-sm shadow-blue-200 transition">å±•ç¤ºå›å ±</button>
                <button @click="pendingFeature" class="py-2.5 bg-emerald-600 rounded-xl text-[10px] font-black text-white active:scale-95 shadow-sm shadow-emerald-200 transition">è¿½è¹¤å›å ±</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div v-if="processedData.length === 0" class="text-center py-20">
        <p class="text-slate-300 font-black tracking-widest uppercase text-sm">ç„¡ç¬¦åˆæ¢ä»¶çš„åå–®</p>
      </div>
    </div> </div>

  <script>
    const { createApp } = Vue;
    createApp({
      delimiters: ['[[', ']]'],
      data() {
        return {
          isLoading: true, // ğŸŒŸ æ–°å¢ï¼šå‹•ç•«ç‹€æ…‹
          currentRep: localStorage.getItem('ezPretty_Rep') || 'Kelvin', // ğŸŒŸ æ–°å¢ï¼šè®€å–è¨˜æ†¶
          showStats: false, 
          currentTab: 'å·²æ‹‰ç¾¤', 
          timeRange: 'thisMonth', 
          customMonth: '', 
          searchQuery: '',
          dateFilters: [
            { id: 'today', label: 'ä»Šæ—¥' }, 
            { id: 'thisWeek', label: 'æœ¬é€±' }, 
            { id: 'thisMonth', label: 'æœ¬æœˆ' }, 
            { id: 'lastMonth', label: 'ä¸Šæœˆ' },
            { id: 'all', label: 'å…¨éƒ¨' }
          ],
          tabs: [
            { id: 'å·²æ‹‰ç¾¤', label: 'å·²æ‹‰ç¾¤' }, 
            { id: 'å·²ç´„å±•', label: 'å·²ç´„å±•' }, 
            { id: 'å±•ç¤ºå®Œï¼Œæ„é¡˜åº¦é«˜', label: 'æ„é¡˜é«˜' }, 
            { id: 'å±•ç¤ºå®Œï¼Œæ„é¡˜åº¦ä¸­', label: 'æ„é¡˜ä¸­' }, 
            { id: 'å±•ç¤ºå®Œï¼Œæ„é¡˜åº¦ä½', label: 'æ„é¡˜ä½' }, 
            { id: 'å·²æˆäº¤', label: 'å·²æˆäº¤' }, 
            { id: 'å·²æ‹’çµ•', label: 'å·²æ‹’çµ•' },
            { id: 'å·²ç´„å±•ï¼Œè¢«æ”¾é³¥', label: 'è¢«æ”¾é³¥' },
            { id: 'é‡è¤‡å–®', label: 'é‡è¤‡å–®' }
          ],
          salesData: [] 
        }
      },
      computed: {
        targetAmount() { return this.currentRep === 'All' ? 240000 : 120000; },
        
        baseData() {
          let d = this.salesData;
          
          if (this.currentRep !== 'All') d = d.filter(i => i.owner === this.currentRep);
          
          if (this.timeRange !== 'all') {
            const now = new Date();
            d = d.filter(i => {
              let dateStr = i.assignDate; 
              
              if (i.status === 'å·²æˆäº¤') {
                dateStr = i.dealDate || i.assignDate;        
              } else if (i.status === 'å·²ç´„å±•') {
                dateStr = i.demoDate || i.assignDate;        
              } else if (i.status && i.status.includes('æ„é¡˜')) {
                dateStr = i.trackTime || i.assignDate;       
              }
              
              if (!dateStr) return false; 
              
              const pureDateStr = dateStr.split(' ')[0]; 
              const dObj = new Date(pureDateStr);
              if (isNaN(dObj)) return true; 
              
              if (this.timeRange === 'today') {
                return dObj.toDateString() === now.toDateString();
              } else if (this.timeRange === 'thisWeek') {
                const day = now.getDay() || 7; 
                const startOfWeek = new Date(now);
                startOfWeek.setDate(now.getDate() - day + 1);
                startOfWeek.setHours(0,0,0,0);
                return dObj >= startOfWeek;
              } else if (this.timeRange === 'thisMonth') {
                return dObj.getMonth() === now.getMonth() && dObj.getFullYear() === now.getFullYear();
              } else if (this.timeRange === 'lastMonth') {
                let m = now.getMonth() - 1;
                let y = now.getFullYear();
                if (m < 0) { m = 11; y--; }
                return dObj.getMonth() === m && dObj.getFullYear() === y;
              } else if (this.timeRange === 'custom' && this.customMonth) {
                const [cy, cm] = this.customMonth.split('-');
                return dObj.getFullYear() === parseInt(cy) && (dObj.getMonth() + 1) === parseInt(cm);
              }
              return true;
            });
          }
          return d;
        },

        stats() {
          const d = this.baseData;
          const totalSales = d.filter(i => i.status === 'å·²æˆäº¤').reduce((sum, i) => sum + (Number(i.salesAmount) || 0), 0);
          
          const selfItems = d.filter(i => i.source && i.source.includes('è‡ªé–‹'));
          const corpItems = d.filter(i => !i.source || !i.source.includes('è‡ªé–‹')); 
          
          return { 
            sales: totalSales, 
            total: d.length || 1, 
            corp: { 
              assign: corpItems.length, 
              demo: corpItems.filter(i => i.demoDate !== '').length 
            }, 
            self: { 
              assign: selfItems.length, 
              demo: selfItems.filter(i => i.demoDate !== '').length 
            } 
          };
        },

        intentStats() {
          const d = this.baseData;
          const countMatch = (keyword) => d.filter(i => i.status && i.status.includes(keyword)).length;
          
          return [
            { label: 'æˆäº¤', count: countMatch('æˆäº¤'), color: 'text-amber-500', bgColor: 'bg-amber-500' },
            { label: 'é«˜', count: countMatch('æ„é¡˜åº¦é«˜'), color: 'text-rose-500', bgColor: 'bg-rose-500' },
            { label: 'ä¸­', count: countMatch('æ„é¡˜åº¦ä¸­'), color: 'text-orange-400', bgColor: 'bg-orange-400' },
            { label: 'ä½', count: countMatch('æ„é¡˜åº¦ä½'), color: 'text-blue-400', bgColor: 'bg-blue-400' },
            { label: 'æ‹’', count: countMatch('æ‹’çµ•') + countMatch('æ”¾é³¥'), color: 'text-slate-300', bgColor: 'bg-slate-300' }
          ];
        },

        processedData() {
          let d = this.baseData;
          
          if (this.currentTab) d = d.filter(i => i.status === this.currentTab);
          if (this.searchQuery) {
            const s = this.searchQuery.toLowerCase();
            d = d.filter(i => (i.storeName && i.storeName.includes(s)) || (i.area && i.area.includes(s)));
          }

          d.sort((a, b) => {
            const getT = (dateStr, def) => {
              if (!dateStr) return def;
              const pureDate = dateStr.split(' ')[0]; 
              const t = new Date(pureDate).getTime();
              return isNaN(t) ? def : t;
            };

            const tab = this.currentTab;

            if (tab === 'å·²æ‹‰ç¾¤') {
              return getT(a.assignDate, Infinity) - getT(b.assignDate, Infinity);
            } 
            else if (tab.includes('æ„é¡˜')) {
              return getT(a.trackTime, Infinity) - getT(b.trackTime, Infinity);
            } 
            else if (tab === 'å·²ç´„å±•') {
              return getT(a.demoDate, Infinity) - getT(b.demoDate, Infinity);
            } 
            else if (tab === 'å·²æˆäº¤') {
              return getT(b.dealDate, 0) - getT(a.dealDate, 0);
            } 
            else {
              return getT(b.assignDate, 0) - getT(a.assignDate, 0);
            }
          });

          return d;
        },

        categorizedData() {
          const d = this.processedData;
          
          const self = d.filter(i => i.source && i.source.includes('è‡ªé–‹'));
          const corp = d.filter(i => !i.source || !i.source.includes('è‡ªé–‹')); 
          
          const result = [];
          if (corp.length > 0) result.push({ title: 'ğŸ¢ å…¬å¸åˆ†é…', color: 'bg-blue-500', items: corp });
          if (self.length > 0) result.push({ title: 'ğŸš€ æ¥­å‹™è‡ªé–‹', color: 'bg-emerald-500', items: self });
          return result;
        }
      },
      methods: {
        setRep(n) { 
          this.currentRep = n; 
          localStorage.setItem('ezPretty_Rep', n); // ğŸŒŸ æ–°å¢ï¼šå¯«å…¥è¨˜æ†¶
        },
        formatNumber(v) { return v ? v.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : "0"; },
        getTabCount(statusId) { return this.baseData.filter(i => i.status === statusId).length; },

        async fetchData() {
          this.isLoading = true; // ğŸŒŸ æ–°å¢ï¼šé–‹å§‹è¼‰å…¥
          const GAS_URL = 'https://script.google.com/macros/s/AKfycbzIKHpWcWj0bOhaQsx-OynY5FVVorMJvTNON5PBOywj1q-Nd5EylLCSl-zTlFW9Rb5U/exec';
          try {
            const response = await fetch(`${GAS_URL}?action=getWarRoomData`);
            const data = await response.json();
            this.salesData = data.filter(item => item.owner && item.owner.trim() !== '');
          } catch (error) {
            console.error('æŠ“å–è³‡æ–™å¤±æ•—:', error);
          } finally {
            this.isLoading = false; // ğŸŒŸ æ–°å¢ï¼šçµæŸè¼‰å…¥
          }
        },

        copyLineId(id) {
          if (!id) return alert('å®¢æˆ¶æœªæä¾› LINE ID');
          navigator.clipboard.writeText(id).then(() => alert(`å·²è¤‡è£½ LINE ID: ${id}`));
        },
        callPhone(phone) {
          if (!phone) return alert('å®¢æˆ¶æœªæä¾›é›»è©±');
          window.location.href = `tel:${phone}`;
        },
        openGroup(link) {
          if (!link) return alert('å°šç„¡ç¾¤çµ„é€£çµ');
          window.open(link, '_blank');
        },
        pendingFeature() { alert('åŠŸèƒ½å»ºç½®ä¸­ï¼Œæ•¬è«‹æœŸå¾…ï¼'); }
      },
      mounted() {
        this.fetchData();
      }
    }).mount('#app');
  </script>
</body>
</html>
